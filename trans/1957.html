<html>
<head>
<title>Securing GraphQL API endpoints using rate limits and depth limits - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>ä½¿ç”¨é€Ÿç‡é™åˆ¶å’Œæ·±åº¦é™åˆ¶ä¿æŠ¤ GraphQL API ç«¯ç‚¹</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.logrocket.com/securing-graphql-api-using-rate-limits-and-depth-limits/#0001-01-01">https://blog.logrocket.com/securing-graphql-api-using-rate-limits-and-depth-limits/#0001-01-01</a></blockquote><div><article class="article-post">
<p>å¦‚æœæ‚¨çš„é¡¹ç›®åç«¯æœ‰ä¸€ä¸ªå¸¦æœ‰å„ç§è§£æå™¨çš„ Node.js GraphQL ç«¯ç‚¹ï¼Œå¹¶ä¸”æ‚¨å°†å®ƒéƒ¨ç½²åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦é€šè¿‡é€Ÿç‡å’Œæ·±åº¦é™åˆ¶æ¥ä¿æŠ¤æ‚¨çš„ GraphQL API ç«¯ç‚¹ã€‚</p>
<p>å¦‚æœè¶…è¿‡äº†è®¾ç½®çš„æ¯æ¬¡è¯·æ±‚é™åˆ¶ï¼Œé€Ÿç‡é™åˆ¶æœ‰åŠ©äºæŠ‘åˆ¶ç”¨æˆ·ï¼Œæ·±åº¦é™åˆ¶æœ‰åŠ©äºé€šè¿‡æ·±åº¦é™åˆ¶ GraphQL æŸ¥è¯¢çš„å¤æ‚æ€§ã€‚è¿™äº›æªæ–½æœ‰åŠ©äºæ‚¨çš„åº”ç”¨ç¨‹åºé˜²æ­¢ API åƒåœ¾é‚®ä»¶å’ŒæŸ¥è¯¢æ”»å‡»ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºä¸ºä»€ä¹ˆä»¥åŠå¦‚ä½•å¯¹ API è¿›è¡Œé€Ÿç‡é™åˆ¶å’Œæ·±åº¦é™åˆ¶ã€‚</p>
<h2>ä»€ä¹ˆæ˜¯é€Ÿç‡é™åˆ¶ï¼Ÿ</h2>
<p>é€Ÿç‡é™åˆ¶æ„å‘³ç€é™åˆ¶åº”ç”¨ç¨‹åºæˆ–ç”¨æˆ·åœ¨ç»™å®šæ—¶é—´å†…å¯ä»¥è¿›è¡Œçš„ API è°ƒç”¨çš„æ•°é‡ã€‚å¦‚æœè¶…è¿‡è¯¥é™åˆ¶ï¼Œåˆ™ç”¨æˆ·æˆ–å®¢æˆ·ç«¯å¯èƒ½è¢«èŠ‚æµï¼Œå³ï¼Œå®¢æˆ·ç«¯å¯èƒ½è¢«ç¦æ­¢åœ¨åŒä¸€æ—¶é—´æ®µå†…è¿›è¡Œæ›´å¤šç±»ä¼¼çš„ API è°ƒç”¨ã€‚</p>
<h2>ä¸ºä»€ä¹ˆè¦é™åˆ¶ API çš„é€Ÿç‡ï¼Ÿ</h2>
<p>æ‚¨çš„åç«¯æœåŠ¡å™¨é€šå¸¸ä¼šå¯¹ä¸€ä¸ªæ—¶é—´æ¡†æ¶å†…å¯ä»¥å¤„ç†çš„è¯·æ±‚æ•°é‡æœ‰ä¸€äº›é™åˆ¶ã€‚å¾ˆå¤šæ—¶å€™ï¼Œæ€€æœ‰æ¶æ„çš„ç”¨æˆ·ä¼šç”¨åƒåœ¾é‚®ä»¶è½°ç‚¸æ‚¨çš„ API ç«¯ç‚¹ï¼Œè¿™ä¼šé™ä½æ‚¨çš„æœåŠ¡å™¨é€Ÿåº¦ï¼Œç”šè‡³å¯èƒ½ä½¿å…¶å´©æºƒã€‚</p>
<p>ä¸ºäº†ä¿æŠ¤æ‚¨çš„ API ç«¯ç‚¹å’ŒæœåŠ¡å™¨ä¸è¢«æ·¹æ²¡ï¼Œæ‚¨å¿…é¡»å¯¹æ‚¨çš„ API ç«¯ç‚¹è¿›è¡Œé€Ÿç‡é™åˆ¶ï¼Œæ— è®ºå®ƒæ˜¯ REST API è¿˜æ˜¯ GraphQL ç«¯ç‚¹ã€‚</p>
<h2>é™é€Ÿæ–¹æ³•</h2>
<p>æœ‰å¤šç§æ–¹æ³•å¯ä»¥é™åˆ¶ APIï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<h3>æŒ‰æ¯ä¸ªæ—¶é—´æ®µçš„ IP åœ°å€</h3>
<p>å¦‚æœæŸäº› IP åœ°å€åœ¨ä¸€æ®µæ—¶é—´å†…è¶…è¿‡äº† API è¯·æ±‚çš„æ•°é‡ï¼Œæ‚¨å¯ä»¥é™åˆ¶å®ƒä»¬è®¿é—®æ‚¨çš„æœåŠ¡ã€‚</p>
<h3>æŒ‰ç”¨æˆ· pe æ—¶é—´èŒƒå›´</h3>
<p>æ‚¨å¯ä»¥é™åˆ¶åº”ç”¨ç¨‹åºä¸­çš„æŸäº›ç”¨æˆ·(é€šè¿‡ä»–ä»¬åœ¨æ•°æ®åº“ä¸­çš„å”¯ä¸€æ ‡è¯†ç¬¦)ï¼Œå¹¶åœ¨ä»–ä»¬è¶…è¿‡æŸä¸ªæ—¶é—´èŒƒå›´å†…çš„ API è¯·æ±‚æ•°æ—¶é™åˆ¶ä»–ä»¬å¯¹æ‚¨çš„æœåŠ¡çš„è®¿é—®ã€‚</p>
<h3>æŒ‰ IP åœ°å€å’Œæ¯ä¸ªæ—¶é—´æ®µçš„ç”¨æˆ·</h3>
<p>åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œå¦‚æœç”¨æˆ·è¶…è¿‡æ‚¨æ ¹æ®ä»–ä»¬æ˜¯å¦ä½¿ç”¨ç›¸åŒçš„ IP åœ°å€è®¾ç½®çš„é€Ÿç‡é™åˆ¶ï¼Œæ‚¨å°†å¯¹ç”¨æˆ·è¿›è¡Œé™åˆ¶ã€‚</p>
<h3>æ‰€æœ‰ GraphQL è§£æå™¨çš„ç»Ÿä¸€é€Ÿç‡é™åˆ¶</h3>
<p>å½“ä¸€ä¸ªæœåŠ¡å™¨ä¸Šçš„ GraphQL è§£æå™¨(<a href="https://graphql.org/learn/queries/" target="_blank" rel="noopener">çªå˜ã€æŸ¥è¯¢</a>å’Œè®¢é˜…)å…·æœ‰ç›¸åŒçš„é€Ÿç‡é™åˆ¶æ—¶ï¼Œæ¯”å¦‚æ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿ 10 ä¸ªè¯·æ±‚ï¼Œå°±è¦è¿™æ ·åšã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸€ä¸ª GraphQL æœåŠ¡å™¨å¯èƒ½åœ¨ç›¸åŒçš„é€Ÿç‡é™åˆ¶è§„åˆ™ä¸­æœ‰<code>signInMutation</code>ã€<code>getUserQuery</code>å’Œå…¶ä»–è¿™æ ·çš„è§£æå™¨ï¼Œè¿™æ„å‘³ç€åœ¨<a href="https://www.tutorialspoint.com/graphql/graphql_resolver.htm#:~:text=Resolver%20is%20a%20collection%20of,info" target="_blank" rel="noopener"> GraphQL è§£æå™¨</a>ä¸­æœ‰ä¸€ä¸ªç»Ÿä¸€çš„é€Ÿç‡é™åˆ¶ã€‚</p>
<h3>æ¯ä¸ª GraphQL è§£æå™¨çš„ä¸åŒé€Ÿç‡é™åˆ¶è§„åˆ™</h3>
<p>æœ‰æ—¶æ¯ä¸ª GraphQL è§£æå™¨éƒ½æœ‰ä¸åŒçš„é™é€Ÿè§„åˆ™ã€‚ä¾‹å¦‚ï¼Œä¸æ˜“äºå¤„ç†ä¸”è€—æ—¶è¾ƒå°‘çš„æ—‹å˜å™¨ç›¸æ¯”ï¼Œéœ€è¦å¤§é‡å†…å­˜å’Œå¤„ç†èƒ½åŠ›çš„æ—‹å˜å™¨å°†å…·æœ‰æ›´ä¸¥æ ¼çš„é€Ÿç‡é™åˆ¶ã€‚</p>
<p>å½“æ¯ä¸ªæ—¶é—´æ®µå…è®¸çš„ API è¯·æ±‚è¶Šå°‘æ—¶ï¼Œé€Ÿç‡é™åˆ¶è¶Šä¸¥æ ¼ã€‚</p>
<h2>å­˜å‚¨é™é€Ÿæ•°æ®</h2>
<p>è¦å¯¹ API æˆ– GraphQL ç«¯ç‚¹è¿›è¡Œé€Ÿç‡é™åˆ¶ï¼Œæ‚¨éœ€è¦è·Ÿè¸ªæ—¶é—´ã€ç”¨æˆ· idã€IP åœ°å€å’Œ/æˆ–å…¶ä»–å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¹¶ä¸”æ‚¨è¿˜éœ€è¦å­˜å‚¨ä¸Šæ¬¡æ ‡è¯†ç¬¦è¯·æ±‚ç«¯ç‚¹æ—¶çš„æ•°æ®ï¼Œä»¥ä¾¿è®¡ç®—æ ‡è¯†ç¬¦æ˜¯å¦è¶…å‡ºäº†é€Ÿç‡é™åˆ¶ã€‚</p>
<p>â€œæ ‡è¯†ç¬¦â€å¯ä»¥æ˜¯æœ‰åŠ©äºè¯†åˆ«å®¢æˆ·ç«¯çš„ä»»ä½•å”¯ä¸€å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚æ•°æ®åº“ä¸­çš„ç”¨æˆ· IDã€IP åœ°å€ã€äºŒè€…çš„å­—ç¬¦ä¸²ç»„åˆï¼Œç”šè‡³æ˜¯è®¾å¤‡ä¿¡æ¯ã€‚</p>
<p>é‚£ä¹ˆï¼Œä½ æŠŠæ‰€æœ‰è¿™äº›æ•°æ®å­˜å‚¨åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
<p><a href="http://redis.io/topics/quickstart" target="_blank" rel="noopener"> Redis </a>æ˜¯æœ€é€‚åˆè¿™äº›ç”¨ä¾‹çš„æ•°æ®åº“ã€‚è¿™æ˜¯ä¸€ä¸ªç¼“å­˜æ•°æ®åº“ï¼Œä½ å¯ä»¥åœ¨å¯†é’¥å¯¹ä¸­ä¿å­˜å°‘é‡ä¿¡æ¯ï¼Œè€Œä¸”é€Ÿåº¦æå¿«ã€‚</p>
<p>è®©æˆ‘ä»¬ç°åœ¨å®‰è£… Redisã€‚ç¨åï¼Œæ‚¨å¯ä»¥å°†å®ƒæ’å…¥ Node.js GraphQL æœåŠ¡å™¨è®¾ç½®ä¸­ï¼Œä»¥å­˜å‚¨é€Ÿç‡é™åˆ¶ç›¸å…³ä¿¡æ¯ã€‚</p>
<p>å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨å®˜æ–¹æ–‡æ¡£å®‰è£… Redisï¼Œè¯·åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨è¿™äº›å‘½ä»¤ğŸ‘‡</p>
<pre>wget http://download.redis.io/redis-stable.tar.gz
tar xvzf redis-stable.tar.gz
cd redis-stable
make
sudo cp src/redis-server /usr/local/bin/ # copying build to proper places
sudo cp src/redis-cli /usr/local/bin/ # copying build to proper places
</pre>
<p>ä¸ªäººè®¤ä¸ºæœ‰æ›´ç®€å•çš„å®‰è£…æ–¹å¼:</p>
<p>åœ¨ Mac ä¸Š:</p>
<pre>brew install redis # to install redis
redis-server /usr/local/etc/redis.conf # to run redis
</pre>
<p>åœ¨ Linux ä¸Š:</p>
<pre>sudo apt-get install redis-server # to install redis
redis-server /usr/local/etc/redis.conf # to run redis
</pre>
<p>Redis æœåŠ¡å™¨å¯åŠ¨åï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·ã€‚åœ¨<code>localhost</code>ä¸Šï¼Œè¿è¡Œ Redis æ²¡æœ‰ä»»ä½•å¯†ç æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å¯¹äºç”Ÿäº§æ¥è¯´ä½ ä¸èƒ½ï¼Œå› ä¸ºä½ ä¸å¸Œæœ›ä½ çš„ Redis æœåŠ¡å™¨å¯¹äº’è”ç½‘å¼€æ”¾ã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬è®¾ç½®ä¸€ä¸ª Redis å¯†ç ã€‚è¿è¡Œ<code>redis-cli</code>å¯åŠ¨ Redis å‘½ä»¤è¡Œã€‚è¿™åªæœ‰åœ¨ Redis å®‰è£…å¹¶è¿è¡Œçš„æƒ…å†µä¸‹æ‰æœ‰æ•ˆã€‚</p><div class="code-block code-block-54">
<hr/>
<h3>æ›´å¤šæ¥è‡ª LogRocket çš„ç²¾å½©æ–‡ç« :</h3>

<hr/></div>
<p>ç„¶åï¼Œåœ¨ CLI ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤:</p>
<pre>config set requirepass somerandompassword
</pre>
<p>ç°åœ¨<code>exit</code>å‘½ä»¤è¡Œã€‚æ‚¨çš„ Redis æœåŠ¡å™¨ç°åœ¨æœ‰å¯†ç ä¿æŠ¤ã€‚</p>
<h2>åœ¨ GraphQL ä¸­ä½¿ç”¨é€Ÿç‡é™åˆ¶</h2>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬å°†åˆ©ç”¨<a href="https://www.npmjs.com/package/graphql-rate-limit" target="_blank" rel="noopener"> <code>graphql-rate-limit</code> npm æ¨¡å—</a>ã€‚ä½ è¿˜éœ€è¦<code><a href="https://www.npmjs.com/package/ioredis" target="_blank" rel="noopener">ioredis</a></code>ã€‚</p>
<pre>npm i graphql-rate-limit ioredis -s
</pre>
<p>åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä½¿ç”¨<a href="https://github.com/dotansimha/graphql-yoga" target="_blank" rel="noopener"> graphql-yoga </a>æœåŠ¡å™¨ä½œä¸ºåç«¯ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨<a href="https://github.com/apollographql/apollo-server" target="_blank" rel="noopener"> Apollo GraphQL </a>ã€‚</p>
<p><code><a href="https://www.npmjs.com/package/graphql-rate-limit" target="_blank" rel="noopener">graphql-rate-limit</a></code>é€‚ç”¨äºä»»ä½• Node.js GraphQL è®¾ç½®ã€‚å®ƒæ‰€åšçš„å°±æ˜¯åˆ›å»º<a href="https://graphql.org/learn/queries/#directives" target="_blank" rel="noopener"> GraphQL æŒ‡ä»¤</a>ç”¨äºæ‚¨çš„<a href="https://graphql.org/learn/schema/" target="_blank" rel="noopener"> GraphQL æ¨¡å¼</a>ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªæ™®é€šçš„ GraphQL æœåŠ¡å™¨çš„æ ·å­:</p>
<pre>import { GraphQLServer } from 'graphql-yoga'

const typeDefs = `
  type Query {
    hello(name: String!): String!
  }
`

const resolvers = {
  Query: {
    hello: (_, { name }) =&gt; `Hello ${name}`
  }
}

const server = new GraphQLServer({ typeDefs, resolvers })

server.start(() =&gt; console.log('Server is running on localhost:4000'))
</pre>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç”¨è¿™æ®µä»£ç æ¥é€Ÿç‡é™åˆ¶<code>welcome</code>æŸ¥è¯¢(è§£æå™¨)ã€‚</p>
<pre>import { GraphQLServer } from 'graphql-yoga'

import * as Redis from "ioredis"
import { createRateLimitDirective, RedisStore } from "graphql-rate-limit"

export const redisOptions = {
  host: process.env.REDIS_HOST || "127.0.0.1",
  port: parseInt(process.env.REDIS_PORT) || 6379,
  password: process.env.REDIS_PASSWORD || "somerandompassword",
  retryStrategy: times =&gt; {
    // reconnect after
    return Math.min(times * 50, 2000)
  }
}

const redisClient = new Redis(redisOptions)

const rateLimitOptions = {
  identifyContext: (ctx) =&gt; ctx?.request?.ipAddress || ctx?.id,
  formatError: ({ fieldName }) =&gt; 
    `Woah there, you are doing way too much ${fieldName}`,
  store: new RedisStore(redisClient)
}

const rateLimitDirective = createRateLimitDirective(rateLimitOptions)

const resolvers = {
  Query: {
    hello: (_, { name }) =&gt; `Hello ${name}`
  }
}

// Schema
const typeDefs = `
  directive @rateLimit(
    max: Int
    window: String
    message: String
    identityArgs: [String]
    arrayLengthField: String
  ) on FIELD_DEFINITION

  type Query {
    hello(name: String!): String! @rateLimit(window: "1s", max: 2)
  }
`

const server = new GraphQLServer({ 
  typeDefs, 
  resolvers,

  // this enables you to use @rateLimit directive in GraphQL schema.
  schemaDirectives: {
    rateLimit: rateLimitDirective
  }
})

server.start(() =&gt; console.log('Server is running on localhost:4000'))
</pre>
<p>å¥½äº†ï¼Œ<code>welcome</code>è§£æå™¨ç°åœ¨æ˜¯é€Ÿç‡å—é™çš„ã€‚</p>
<p>å¦‚æœæ‚¨åœ¨<code><a href="https://localhost:4000" rel="nofollow">https://localhost:4000</a></code>è®¿é—®<a href="https://github.com/graphql/graphql-playground" target="_blank" rel="noopener"> GraphQL æ¸¸ä¹åœº</a>ï¼Œè¯·å°è¯•è¿è¡Œä»¥ä¸‹æŸ¥è¯¢ã€‚</p>
<pre># Try to spam this query by clicking fast, 
# you should see an error message after you hit the rate limit.
query {
  hello(name: "Kumar Abhirup")
}
</pre>
<figure id="attachment_58931" aria-describedby="caption-attachment-58931" class="wp-caption aligncenter"><img data-attachment-id="58931" data-permalink="https://blog.logrocket.com/securing-graphql-api-using-rate-limits-and-depth-limits/graphql-playground-query/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query.jpeg" data-orig-size="730,173" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="Graphql playground query" data-image-description="" data-image-caption="&lt;p&gt;Try clicking the white play button rapidly to spam it and youâ€™ll hit the rate limit.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query-300x71.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query.jpeg" decoding="async" class="size-full wp-image-58931 jetpack-lazy-image" src="../Images/f175d7bfc73312e3ea63f86d62fa6e18.png" alt="Query Running With Play Button" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query-300x71.jpeg 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query.jpeg?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query.jpeg"/><noscript><img data-lazy-fallback="1" data-attachment-id="58931" data-permalink="https://blog.logrocket.com/securing-graphql-api-using-rate-limits-and-depth-limits/graphql-playground-query/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query.jpeg" data-orig-size="730,173" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="Graphql playground query" data-image-description="" data-image-caption="&lt;p&gt;Try clicking the white play button rapidly to spam it and youâ€™ll hit the rate limit.&lt;/p&gt;&#10;" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query-300x71.jpeg" data-large-file="https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query.jpeg" decoding="async" loading="lazy" class="size-full wp-image-58931" src="../Images/f175d7bfc73312e3ea63f86d62fa6e18.png" alt="Query Running With Play Button" srcset="https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query.jpeg 730w, https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query-300x71.jpeg 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2021/07/graphql-playground-query.jpeg"/></noscript><figcaption id="caption-attachment-58931" class="wp-caption-text">Try clicking the white play button rapidly to spam it and youâ€™ll hit the rate limit.</figcaption></figure>
<p>è¾¾åˆ°é€Ÿç‡é™åˆ¶åï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°è®¾ç½®çš„é”™è¯¯æ¶ˆæ¯:<code>Woah there, you are doing way too much hello</code>ã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬æ·±å…¥åˆ†æä»£ç ã€‚</p>
<h2>GraphQL ä¸­çš„é€Ÿç‡é™åˆ¶é€‰é¡¹</h2>
<pre>const rateLimitOptions = {
  identifyContext: (ctx) =&gt; ctx?.request?.ipAddress || ctx?.id,
  formatError: ({ fieldName }) =&gt; 
    `Woah there, you are doing way too much ${fieldName}`,
  store: new RedisStore(redisClient)
}

const rateLimitDirective = createRateLimitDirective(rateLimitOptions)
</pre>
<p><code>identifyContext</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå°†è¿”å›æ•°æ®åº“ä¸­æ‰€æœ‰è®¾å¤‡æˆ–ç”¨æˆ·çš„å”¯ä¸€å­—ç¬¦ä¸²ï¼Œæˆ–è€…ä¸¤è€…çš„ç»„åˆã€‚æ‚¨å¯ä»¥åœ¨è¿™é‡Œå†³å®šæ˜¯å¦è¦é€šè¿‡ IP åœ°å€ã€ç”¨æˆ· ID æˆ–å…¶ä»–æ–¹æ³•è¿›è¡Œé€Ÿç‡é™åˆ¶ã€‚</p>
<p>åœ¨ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œæˆ‘ä»¬å°è¯•å°†ç”¨æˆ· IP åœ°å€è®¾ç½®ä¸ºæƒŸä¸€æ ‡è¯†ç¬¦ï¼Œå¦‚æœæ²¡æœ‰æ£€ç´¢åˆ° IP åœ°å€ï¼Œå®ƒå°†ä½¿ç”¨é»˜è®¤çš„ GraphQL æœåŠ¡å™¨æä¾›çš„<code>contextID</code>ä½œä¸ºåå¤‡å€¼ã€‚</p>
<p><code>formatError</code>æ˜¯ä¸€ç§å…è®¸æ‚¨æ ¼å¼åŒ–ç”¨æˆ·è¾¾åˆ°é€Ÿç‡é™åˆ¶åçœ‹åˆ°çš„é”™è¯¯æ¶ˆæ¯çš„æ–¹æ³•ã€‚</p>
<p><code>store</code>è¿æ¥åˆ° Redis å®ä¾‹ï¼Œåœ¨ Redis æœåŠ¡å™¨ä¸­ä¿å­˜å¿…è¦çš„é™é€Ÿæ•°æ®ã€‚æ²¡æœ‰ Redis å­˜å‚¨ï¼Œæ­¤é€Ÿç‡é™åˆ¶è®¾ç½®æ— æ³•è¿è¡Œã€‚è¯·æ³¨æ„ï¼Œæ‚¨ä¸å¿…æ€»æ˜¯ä½¿ç”¨ Redis ä½œä¸ºå­˜å‚¨â€”â€”æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨<a href="https://docs.mongodb.com/manual/tutorial/getting-started/" target="_blank" rel="noopener"> MongoDB </a>æˆ–<a href="https://www.postgresql.org/" target="_blank" rel="noopener"> PostgreSQL </a>,ä½†æ˜¯è¿™äº›æ•°æ®åº“å¯¹äºä¸€ä¸ªç®€å•çš„é™é€Ÿè§£å†³æ–¹æ¡ˆæ¥è¯´æ˜¯å¤šä½™çš„ã€‚</p>
<p><code>createRateLimitDirective</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœä¸<code>rateLimitOptions</code>ä¸€èµ·æä¾›ï¼Œå®ƒä½¿æ‚¨èƒ½å¤Ÿåˆ›å»ºåŠ¨æ€é€Ÿç‡é™åˆ¶æŒ‡ä»¤ï¼Œç¨åæ‚¨å¯ä»¥å°†è¿™äº›æŒ‡ä»¤è¿æ¥åˆ°æ‚¨çš„ GraphQL æœåŠ¡å™¨ï¼Œä»¥ä¾¿åœ¨æ‚¨çš„æ¨¡å¼ä¸­ä½¿ç”¨ã€‚</p>
<p>è¿™æ˜¯æ¨¡å¼ã€‚</p>
<pre>const typeDefs = `
  directive @rateLimit(
    max: Int
    window: String
    message: String
    identityArgs: [String]
    arrayLengthField: String
  ) on FIELD_DEFINITION

  type Query {
    hello(name: String!): String! @rateLimit(window: "1s", max: 2)
  }
`
</pre>
<p><code>directive @rateLimit</code>åœ¨æ¨¡å¼ä¸­åˆ›å»º<code>@rateLimit</code> <a href="https://graphql.org/learn/queries/#directives" target="_blank" rel="noopener">æŒ‡ä»¤</a>ï¼Œè¯¥æŒ‡ä»¤æ¥å—ä¸€äº›å‚æ•°æ¥å¸®åŠ©ä¸ºæ¯ä¸ª<a href="https://graphql.org/learn/queries/" target="_blank" rel="noopener">è§£æå™¨</a>é…ç½®é€Ÿç‡é™åˆ¶è§„åˆ™ã€‚</p>
<p>ä¸€æ—¦ GraphQL æŒ‡ä»¤è®¾ç½®å¥½å¹¶å‡†å¤‡å¥½ä½¿ç”¨ï¼Œæ‚¨å°±å¯ä»¥å°†<code>@rateLimit(window: <em>"1s"</em>, max: 2)</code>é¢„å…ˆå›ºå®šåˆ°ä»»ä½•è§£æå™¨ä¸Šã€‚<code>window: <em>"1s"</em>, max: 2</code>è¡¨ç¤ºè§£æå™¨æ¯ç§’åªèƒ½ç”±ä¸€ä¸ªç”¨æˆ·ã€ä¸€ä¸ª IP åœ°å€æˆ–æŒ‡å®šçš„<code>identifyContext</code>è¿è¡Œä¸¤æ¬¡ã€‚å¦‚æœåŒä¸€æŸ¥è¯¢åœ¨è¯¥æ—¶é—´æ®µå†…ç¬¬ä¸‰æ¬¡è¿è¡Œï¼Œå°†å‡ºç°é€Ÿç‡é™åˆ¶é”™è¯¯ã€‚</p>
<p>å¸Œæœ›æ‚¨ç°åœ¨çŸ¥é“ GraphQL è§£æå™¨æ˜¯å¦‚ä½•è¿›è¡Œé€Ÿç‡é™åˆ¶çš„ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢æŸ¥è¯¢åƒåœ¾é‚®ä»¶æ·¹æ²¡æ‚¨çš„æœåŠ¡å™¨ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»è®¨è®ºäº† GraphQL é€Ÿç‡é™åˆ¶ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•é€šè¿‡æ·±åº¦é™åˆ¶ä½¿ GraphQL ç«¯ç‚¹æ›´åŠ å®‰å…¨ã€‚</p>
<h2>ä»€ä¹ˆæ˜¯ GraphQL æ·±åº¦é™åˆ¶ï¼Ÿ</h2>
<p>æ·±åº¦é™åˆ¶æ˜¯æŒ‡é€šè¿‡æ·±åº¦æ¥é™åˆ¶ GraphQL æŸ¥è¯¢çš„å¤æ‚æ€§ã€‚GraphQL æœåŠ¡å™¨é€šå¸¸æœ‰<a href="https://xuorig.medium.com/the-graphql-dataloader-pattern-visualized-3064a00f319f" target="_blank" rel="noopener">æ•°æ®åŠ è½½å™¨</a>æ¥ä½¿ç”¨å…³ç³»æ•°æ®åº“æŸ¥è¯¢åŠ è½½å’Œå¡«å……æ•°æ®ã€‚</p>
<p>è¯·çœ‹ä¸‹é¢çš„æŸ¥è¯¢:</p>
<pre>query book {
  getBook(id: 1) {
    title
    author
    publisher
    reviews {
      title
      body
      book {
        title
        author
        publisher
        reviews {
          title
        }
      }
    }
  }
}
</pre>
<p>å®ƒä¸ºè¢«æŸ¥è¯¢çš„<code>book</code>è·å–<code>review</code> (s)ã€‚æ¯ä¸ª<code>book</code>éƒ½æœ‰<code>rviews</code>ï¼Œæ¯ä¸ª<code>review</code>éƒ½è¿æ¥åˆ°ä¸€ä¸ª<code>book</code>ï¼Œæˆä¸ºæ•°æ®åŠ è½½å™¨æŸ¥è¯¢çš„ä¸€å¯¹å¤šå…³ç³»ã€‚</p>
<p>ç°åœ¨ï¼Œçœ‹çœ‹è¿™ä¸ª GraphQL æŸ¥è¯¢ã€‚</p>
<pre>query badMaliciousQuery {
  getBook(id: 1) {
    reviews {
      book {
        reviews {
          book {
            reviews {
              book {
                reviews {
                  book {
                    reviews {
                      book {
                        reviews {
                          book {
                            # and so on...
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
</pre>
<p>è¿™ä¸ªæŸ¥è¯¢æœ‰å‡ ä¸ªå±‚æ¬¡ã€‚å®ƒåˆ›å»ºäº†ä¸€ä¸ªå·¨å¤§çš„å¾ªç¯ï¼Œå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œè¿™å–å†³äºæŸ¥è¯¢çš„æ·±åº¦ï¼Œå…¶ä¸­<code>book</code>è·å–<code>reviews</code>ï¼Œ<code>reviews</code>è·å–<code>books</code>ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p>è¿™æ ·çš„æŸ¥è¯¢å­—ç¬¦ä¸²ä¼šæ·¹æ²¡æ‚¨çš„ GraphQL æœåŠ¡å™¨ï¼Œå¹¶å¯èƒ½ä½¿å…¶å´©æºƒã€‚æƒ³è±¡ä¸€ä¸‹å‘é€ä¸€ä¸ª 10ï¼Œ000 å±‚æ·±åº¦çš„æŸ¥è¯¢â€”è¿™å°†æ˜¯ç¾éš¾æ€§çš„ï¼</p>
<p>è¿™å°±æ˜¯æ·±åº¦é™åˆ¶çš„ç”±æ¥ã€‚å®ƒä½¿ GraphQL æœåŠ¡å™¨èƒ½å¤Ÿæ£€æµ‹æ­¤ç±»æŸ¥è¯¢ï¼Œå¹¶é˜²æ­¢å®ƒä»¬è¢«å¤„ç†ã€‚</p>
<blockquote><p>è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç§°ä¸ºâ€œè¯·æ±‚è¶…æ—¶â€é”™è¯¯ï¼Œå¦‚æœè§£å†³æ—¶é—´å¤ªé•¿ï¼Œå®ƒä¼šé˜»æ­¢è§£æå™¨æ‰§è¡ŒæŸ¥è¯¢ã€‚</p></blockquote>
<h2>GraphQL API çš„æ·±åº¦é™åˆ¶</h2>
<p>è¿™æ˜¯ä¸€ä¸ªç›¸å½“ç®€å•çš„è¿‡ç¨‹ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code><a href="https://www.npmjs.com/package/graphql-depth-limit" target="_blank" rel="noopener">graphql-depth-limit</a></code>æ¥é™åˆ¶ GraphQL æŸ¥è¯¢çš„æ·±åº¦ã€‚</p>
<pre>import { GraphQLServer } from 'graphql-yoga'
import * as depthLimit from 'graphql-depth-limit'

const typeDefs = `
  type Query {
    hello(name: String!): String!
  }
`

const resolvers = {
  Query: {
    hello: (_, { name }) =&gt; `Hello ${name}`
  }
}

const server = new GraphQLServer({ 
  typeDefs, 
  resolvers,

  // easily set a depth limit on all the incoming graphql queries
  // here, we set a depth limit of 7
  validationRules: [depthLimit(7)]
})

server.start(() =&gt; console.log('Server is running on localhost:4000'))
</pre>
<p>æˆ‘ä»¬éƒ½å‡†å¤‡å¥½äº†ï¼ä½¿ç”¨æ·±åº¦é™åˆ¶æ¥é™åˆ¶æŸ¥è¯¢å¤æ‚æ€§è¿˜æœ‰è®¸å¤šå…¶ä»–æ–¹æ³•ã€‚</p>
<h2>ç»“è®º</h2>
<p>ä¸ºäº†é˜²æ­¢æ‚¨çš„ GraphQL æœåŠ¡å™¨è¢« API è¯·æ±‚æ·¹æ²¡ï¼Œå¿…é¡»å¯¹ GraphQL ç«¯ç‚¹è¿›è¡Œé€Ÿç‡é™åˆ¶å’Œæ·±åº¦é™åˆ¶ï¼Œè¿™ä¹Ÿå¯ä»¥ä¿æŠ¤æ‚¨çš„æœåŠ¡å™¨å…å—æ¶æ„æŸ¥è¯¢æ”»å‡»ï¼Œè¿™äº›æ”»å‡»å¯ä»¥å°†æ‚¨çš„è§£æå™¨ç½®äºæ°¸æ— æ­¢å¢ƒçš„è¯·æ±‚å¾ªç¯ä¸­ï¼Œç‰¹åˆ«æ˜¯å½“æ‚¨ä¸ºå®æ—¶åº”ç”¨ç¨‹åºéƒ¨ç½²æœåŠ¡å™¨æ—¶ã€‚</p><div class="code-block code-block-24">
<div class="blog-plug inline-plug graphql-plug"><h2>ç›‘æ§ç”Ÿäº§ä¸­å¤±è´¥å’Œç¼“æ…¢çš„ GraphQL è¯·æ±‚</h2><p>è™½ç„¶ GraphQL æœ‰ä¸€äº›è°ƒè¯•è¯·æ±‚å’Œå“åº”çš„ç‰¹æ€§ï¼Œä½†ç¡®ä¿ GraphQL å¯é åœ°ä¸ºæ‚¨çš„ç”Ÿäº§åº”ç”¨ç¨‹åºæä¾›èµ„æºæ˜¯ä¸€ä»¶æ¯”è¾ƒå›°éš¾çš„äº‹æƒ…ã€‚å¦‚æœæ‚¨å¯¹ç¡®ä¿å¯¹åç«¯æˆ–ç¬¬ä¸‰æ–¹æœåŠ¡çš„ç½‘ç»œè¯·æ±‚æˆåŠŸæ„Ÿå…´è¶£ï¼Œ</p><a href="https://lp.logrocket.com/blg/graphql-signup" target="_blank">try LogRocket</a><p>.</p><a class="signup" href="https://lp.logrocket.com/blg/graphql-signup" target="_blank" rel="noopener noreferrer"><img src="../Images/432a3823c85b3fb72a206e6236a29f48.png" data-lazy-src="https://files.readme.io/69aa835-Image_2019-11-09_at_1.28.05_PM.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://files.readme.io/69aa835-Image_2019-11-09_at_1.28.05_PM.png"/><noscript><img data-lazy-fallback="1" src="../Images/432a3823c85b3fb72a206e6236a29f48.png" data-original-src="https://files.readme.io/69aa835-Image_2019-11-09_at_1.28.05_PM.png"/></noscript><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a><a href="https://lp.logrocket.com/blg/graphql-signup" target="_blank" rel="noopener noreferrer">https://logrocket.com/signup/</a><p>LogRocket å°±åƒæ˜¯ç½‘ç»œå’Œç§»åŠ¨åº”ç”¨çš„ DVRï¼Œè®°å½•ä¸‹ä½ ç½‘ç«™ä¸Šå‘ç”Ÿçš„æ¯ä¸€ä»¶äº‹ã€‚æ‚¨å¯ä»¥æ±‡æ€»å¹¶æŠ¥å‘Šæœ‰é—®é¢˜çš„ GraphQL è¯·æ±‚ï¼Œä»¥å¿«é€Ÿäº†è§£æ ¹æœ¬åŸå› ï¼Œè€Œä¸æ˜¯çŒœæµ‹é—®é¢˜å‘ç”Ÿçš„åŸå› ã€‚æ­¤å¤–ï¼Œæ‚¨å¯ä»¥è·Ÿè¸ª Apollo å®¢æˆ·æœºçŠ¶æ€å¹¶æ£€æŸ¥ GraphQL æŸ¥è¯¢çš„é”®å€¼å¯¹ã€‚</p><p>LogRocket æ£€æµ‹æ‚¨çš„åº”ç”¨ç¨‹åºä»¥è®°å½•åŸºçº¿æ€§èƒ½è®¡æ—¶ï¼Œå¦‚é¡µé¢åŠ è½½æ—¶é—´ã€åˆ°è¾¾ç¬¬ä¸€ä¸ªå­—èŠ‚çš„æ—¶é—´ã€æ…¢é€Ÿç½‘ç»œè¯·æ±‚ï¼Œè¿˜è®°å½• Reduxã€NgRx å’Œ Vuex æ“ä½œ/çŠ¶æ€ã€‚</p><a class="signup" href="https://lp.logrocket.com/blg/graphql-signup" target="_blank" rel="noopener noreferrer">Start monitoring for free</a><p>.</p></div>


</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>