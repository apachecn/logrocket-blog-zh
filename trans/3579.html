<html>
<head>
<title>Building a real-time location app with Node.js and Socket.IO </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>ç”¨Node.jså’ŒSocketæ„å»ºå®æ—¶å®šä½appã€‚è¶…æ­£æè±¡ç®¡(Image Orthicon)</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.logrocket.com/building-real-time-location-app-node-js-socket-io/#0001-01-01">https://blog.logrocket.com/building-real-time-location-app-node-js-socket-io/#0001-01-01</a></blockquote><div><article class="article-post">
<p>æ’åº§ã€‚IOæä¾›webå®¢æˆ·ç«¯å’ŒNode.jsæœåŠ¡å™¨ä¹‹é—´çš„å®æ—¶é€šä¿¡ã€‚å¯¹äºä»Šå¤©çš„è®¸å¤šç”¨ä¾‹æ¥è¯´ï¼Œå¼€å‘äººå‘˜éœ€è¦ä¸æ–­åœ°å®æ—¶æ›´æ–°ä»–ä»¬åº”ç”¨ç¨‹åºçš„ä¿¡æ¯ï¼Œè¿™å°±éœ€è¦ä½¿ç”¨ä¸€ä¸ªåŒå‘é€šä¿¡å·¥å…·æ¥ä¿æŒæ•°æ®å³æ—¶æ›´æ–°ã€‚</p>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†äº†è§£å¦‚ä½•ä½¿ç”¨Socketã€‚ä½¿ç”¨Node.jsä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºæä¾›å®æ—¶æ•°æ®é€šä¿¡ï¼Œå°±åƒè¿™æ ·çš„ç”¨ä¾‹ã€‚</p>
<p><em>å‘å‰è·³è½¬:</em></p>

<h2 id="rest-api-websockets">REST APIä¸WebSockets</h2>
<p>å½“æˆ‘ä»¬æƒ³è¦æ£€ç´¢èµ„æºå¹¶ä¸”ä¸éœ€è¦æŒç»­æ›´æ–°æ—¶ï¼Œä¼ ç»Ÿçš„REST APIsæœ€æœ‰ç”¨ã€‚</p>
<p>å¦‚æœä½ çœ‹ä¸€ä¸ªåŠ å¯†äº¤æ˜“ï¼Œä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬å‡ºä»·è´­ä¹°ä¸€æšç¡¬å¸æ—¶ï¼Œå‡ºä»·ä¸å¤ªå¯èƒ½ç»å¸¸æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„REST APIç²¾ç¡®åœ°å»ºæ¨¡è¿™ç§è¡Œä¸ºã€‚</p>
<p>ç„¶è€Œï¼Œç¡¬å¸æœ¬èº«çš„å®é™…ä»·æ ¼æ˜¯éå¸¸ä¸ç¨³å®šçš„ï¼Œå› ä¸ºå®ƒåƒä»»ä½•èµ„äº§ä¸€æ ·å¯¹å¸‚åœºè¶‹åŠ¿åšå‡ºååº”ã€‚ä¸ºäº†è·å¾—æœ€æ–°çš„ä»·æ ¼ï¼Œæˆ‘ä»¬éœ€è¦å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶ä¸”å½“æˆ‘ä»¬çš„å“åº”åˆ°è¾¾æ—¶ï¼Œå®ƒå¾ˆæœ‰å¯èƒ½å†æ¬¡æ”¹å˜ï¼</p>
<p>åœ¨è¿™æ ·çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨èµ„äº§ä»·æ ¼å˜åŒ–æ—¶å¾—åˆ°é€šçŸ¥ï¼Œè¿™æ­£æ˜¯WebSocketsçš„äº®ç‚¹ã€‚</p>
<p>ç”¨äºæ„å»ºä¼ ç»ŸREST APIsçš„èµ„æºæ˜¯é«˜åº¦å¯ç¼“å­˜çš„ï¼Œå› ä¸ºå®ƒä»¬å¾ˆå°‘æ›´æ–°ã€‚ä¸æ­¤åŒæ—¶ï¼ŒWebSocketså¹¶æ²¡æœ‰ä»ç¼“å­˜ä¸­è·å¾—å¤ªå¤šå¥½å¤„ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚</p>
<p>æœ‰å¤§é‡çš„æŒ‡å—å¼ºè°ƒäº†ä¼ ç»ŸREST APIså’ŒWebSocketsçš„ä¸åŒç”¨ä¾‹ã€‚</p>
<p>åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Node.jså’ŒSocketæ„å»ºä¸€ä¸ªå®æ—¶çš„ä½ç½®å…±äº«åº”ç”¨ç¨‹åºã€‚IOæ˜¯æˆ‘ä»¬çš„ä½¿ç”¨æ¡ˆä¾‹ã€‚</p>
<p>ä»¥ä¸‹æ˜¯æˆ‘ä»¬å°†ä½¿ç”¨çš„æŠ€æœ¯:</p>
<ul>
<li><strong>æˆ‘ä»¬åº”ç”¨æœåŠ¡å™¨çš„Node.js/Express:</strong></li>
<li><strong>æ’åº§ã€‚IO: </strong>åœ¨å¹•åå®ç°WebSockets</li>
<li><strong> Postgres: </strong>å­˜å‚¨ç”¨æˆ·ä½ç½®æ•°æ®çš„é¦–é€‰æ•°æ®åº“</li>
<li>Postgis: è¿™ä¸ªæ‰©å±•ä½¿å¾—å¤„ç†æ•°æ®åº“ä¸­çš„ä½ç½®æˆä¸ºå¯èƒ½ï¼Œå¹¶æä¾›äº†é¢å¤–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚è®¡ç®—ä½ç½®å‘¨å›´çš„è·ç¦»</li>
</ul>
<h2 id="setting-express-js-server">è®¾ç½®Express.jsæœåŠ¡å™¨</h2>
<p>æˆ‘ä»¬å°†ä»è®¾ç½®ä¸€ä¸ªExpressåº”ç”¨ç¨‹åºå¼€å§‹ã€‚</p>
<p>ä¸ºæ­¤ï¼Œæˆ‘ä¿®æ”¹äº†æˆ‘ä»¬å°†ä½¿ç”¨çš„æ ·æ¿æ–‡ä»¶ã€‚è®©æˆ‘ä»¬æŒ‰ç…§è¿™äº›è¯´æ˜å¼€å§‹å§:</p>
<ol>
<li>å…‹éš†è¿™ä¸ªGitHubåº“</li>
<li><code>cd socket-location/</code></li>
<li><code>npm install</code></li>
<li>æœ€åï¼Œåœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª<code>.env</code>æ–‡ä»¶ï¼Œå¹¶å¤åˆ¶<code>env.</code>ç¤ºä¾‹æ–‡ä»¶çš„å†…å®¹ã€‚ä¸ºäº†è·å¾—è¿™äº›å€¼ï¼Œæˆ‘ä»¬å®é™…ä¸Šéœ€è¦å»ºç«‹ä¸€ä¸ªæœ¬åœ°æ•°æ®åº“ï¼Œæˆ–è€…ä½¿ç”¨åœ¨çº¿Postgresæ•°æ®åº“å¹³å°ï¼Œå¦‚<a href="https://www.elephantsql.com/"> Elephant </a>æˆ–Herokuã€‚è®¿é—®å¹³å°å¹¶å…è´¹åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œè·å–URLï¼Œå¡«å†™å‡­è¯ï¼Œå¹¶å¯åŠ¨åº”ç”¨ç¨‹åº</li>
</ol>
<h2 id="setting-websockets-socket-io">ä½¿ç”¨å¥—æ¥å­—è®¾ç½®WebSocketsã€‚è¶…æ­£æè±¡ç®¡(Image Orthicon)</h2>
<p>æ¥è®¾ç½®å¥—æ¥å­—ã€‚å¯¹äºæˆ‘ä»¬ç°æœ‰çš„starteræ–‡ä»¶ï¼Œä½¿ç”¨JavaScriptæå‡å¯¹æˆ‘ä»¬æ¥è¯´å¾ˆé‡è¦ï¼Œè¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿè·¨ä¸åŒçš„æ–‡ä»¶ä½¿ç”¨socketå®ä¾‹ã€‚</p>
<p>æˆ‘ä»¬å°†ä»å®‰è£…Socketå¼€å§‹ã€‚è¶…æ­£æè±¡ç®¡(Image Orthicon)</p>
<pre class="language-javascript hljs">npm install socket.io
</pre>
<p>æˆ‘ä»¬éœ€è¦åšçš„ä¸‹ä¸€ä»¶äº‹æ˜¯å°†å®ƒä¸æˆ‘ä»¬çš„expressåº”ç”¨ç¨‹åºé›†æˆã€‚åœ¨é¡¹ç›®ç›®å½•çš„æ ¹ç›®å½•ä¸‹æ‰“å¼€<code>app.js</code>æ–‡ä»¶ï¼ŒæŒ‰å¦‚ä¸‹æ–¹å¼ç¼–è¾‘:</p>
<pre class="language-javascript hljs">const express = require("express");
const { createServer } = require("http");
const { Server } = require("socket.io");
const { initializeRoutes } = require("./routes");

let app = express();
const port = 3000;
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

app = initializeRoutes(app);
app.get("/", (req, res) =&gt; {
  res.status(200).send({
    success: true,
    message: "welcome to the beginning of greatness",
  });
});

const httpServer = createServer(app);
const io = new Server(httpServer, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"],
  },
});

io.on("connection", (socket) =&gt; {
  console.log("We are live and connected");
  console.log(socket.id);
});

httpServer.listen(port, () =&gt; {
  console.log(`Example app listening on port ${port}`);
});
</pre>
<p>æˆ‘ä»¬å·²ç»æˆåŠŸåœ°å°†æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸å¥—æ¥å­—è¿æ¥èµ·æ¥ï¼›ç°åœ¨æˆ‘ä»¬éœ€è¦è¿æ¥æˆ‘ä»¬çš„å®¢æˆ·ç«¯æ¥å“åº”è¿™ä¸ªè¿æ¥ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ¥å›çš„é€šä¿¡ã€‚</p>
<p>æˆ‘ä»¬çš„å®¢æˆ·ç«¯å¯ä»¥æ˜¯ä¸€ä¸ªwebåº”ç”¨ç¨‹åºã€ä¸€ä¸ªç§»åŠ¨åº”ç”¨ç¨‹åºæˆ–ä»»ä½•å¯ä»¥é…ç½®ä¸ºä½¿ç”¨WebSocketsçš„è®¾å¤‡ã€‚</p>
<p>ä¸ºäº†ç®€æ´èµ·è§ï¼Œæˆ‘ä»¬å°†åœ¨è¿™ä¸ªåº”ç”¨ç¨‹åºä¸­ç”¨POSTMANæ¨¡æ‹Ÿå®¢æˆ·ç«¯è¡Œä¸ºã€‚</p>
<p>ä¸ºæ­¤ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œ:</p>
<ol>
<li>æ‰“å¼€Postmanï¼Œç‚¹å‡»å·¦ä¸Šè§’çš„â€œæ–°å»ºâ€æŒ‰é’®</li>
<li>ç„¶åå•å‡»å¼¹å‡ºçª—å£ä¸Šçš„â€œWebsocketè¯·æ±‚â€æŒ‰é’®</li>
<li>åº”è¯¥æœ‰æ–‡æœ¬æ˜¾ç¤ºâ€œrawâ€â€”â€”ä½¿ç”¨ä¸‹æ‹‰èœå•ï¼Œå°†å…¶æ›´æ”¹ä¸ºâ€œSocketâ€ã€‚æœ¨å«ä¸€"</li>
<li>å°†æ‚¨çš„è¿æ¥å­—ç¬¦ä¸²ç²˜è´´åˆ°é€‰é¡¹å¡ä¸Šâ€”åœ¨æœ¬ä¾‹ä¸­æ˜¯localhost:3000 â€”å¹¶å•å‡»connectæŒ‰é’®</li>
</ol>
<p>æ‚¨åº”è¯¥çœ‹åˆ°æ§åˆ¶å°æ‰“å°å‡ºä¸€ä¸ªå”¯ä¸€çš„IDï¼Œå¹¶ä¸”Postmané€‰é¡¹å¡åº”è¯¥æ˜¾ç¤ºâ€œå·²è¿æ¥â€ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€æ®µè§†é¢‘å±•ç¤ºäº†æˆ‘ä»¬çš„ç°çŠ¶ï¼Œå¹¶ç®€è¦å›é¡¾äº†æˆ‘ä»¬è¿„ä»Šä¸ºæ­¢æ‰€åšçš„å·¥ä½œã€‚</p>
<blockquote class="embedly-card" data-card-controls="1" data-card-align="center" data-card-theme="light">

<p>æ²¡æœ‰æè¿°</p>
</blockquote>
<p>æ›´å¤šæ¥è‡ªLogRocketçš„ç²¾å½©æ–‡ç« :</p><div class="code-block code-block-54">
<hr/>
<h3>è®¤è¯å’Œæˆæƒ</h3>

<hr/></div>
<h2 id="authentication-authorization">ç°åœ¨æˆ‘ä»¬å·²ç»æˆåŠŸåœ°è¿æ¥åˆ°æˆ‘ä»¬çš„æ’åº§ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦æä¾›æŸç§å½¢å¼çš„èº«ä»½éªŒè¯å’Œæˆæƒæ¥é˜»æ­¢ä¸éœ€è¦çš„ç”¨æˆ·ã€‚å½“æ‚¨è€ƒè™‘åˆ°æˆ‘ä»¬å…è®¸æ¥è‡ªä»»ä½•å®¢æˆ·ç«¯çš„è¿æ¥æ—¶ï¼Œæƒ…å†µå°¤å…¶å¦‚æ­¤ï¼Œæ­£å¦‚è¿æ¥æ—¶CORSé€‰é¡¹ä¸­çš„<code>*</code>æ‰€æŒ‡å®šçš„ã€‚</h2>
<p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªä¸­é—´ä»¶:</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ£€æŸ¥è¯·æ±‚å¤´ä¸­æ˜¯å¦æä¾›äº†ä»¤ç‰Œã€‚åœ¨å…è®¸ç”¨æˆ·è¿æ¥ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜ä¼šæ£€æŸ¥å®ƒæ˜¯å¦æ˜¯æœ‰æ•ˆçš„ä»¤ç‰Œï¼Œä»¥åŠç”¨æˆ·æ˜¯å¦å­˜åœ¨äºæˆ‘ä»¬çš„æ•°æ®åº“ä¸­â€”è¿™ç¡®ä¿äº†åªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·æ‰èƒ½è®¿é—®ã€‚</p>
<pre class="language-javascript hljs">io.use((socket, next) =&gt; {
  if (socket.handshake.headers.auth) {
    const { auth } = socket.handshake.headers;
    const token = auth.split(" ")[1];
    jwt.verify(token, process.env.JWT_SECRET_KEY, async (err, decodedToken) =&gt; {
      if (err) {
        throw new Error("Authentication error, Invalid Token supplied");
      }
      const theUser = await db.User.findByPk(decodedToken.id);
      if (!theUser)
        throw new Error(
          "Invalid Email or Password, Kindly contact the admin if this is an anomaly"
        );
      socket.theUser = theUser;
      return next();
    });
  } else {
    throw new Error("Authentication error, Please provide a token");
  }
});
</pre>
<p>ç”¨æˆ·ä¹‹é—´å…±äº«ä½ç½®</p>
<h2 id="sharing-location-users">ä¸ºäº†åœ¨ç”¨æˆ·ä¹‹é—´å…±äº«ä½ç½®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å¥—æ¥å­—è¿æ¥ã€‚æˆ‘ä»¬è¿˜éœ€è¦å‡†å¤‡æ•°æ®åº“æ¥æ¥å—å‡ ä½•å¯¹è±¡ï¼Œä¸ºæ­¤æˆ‘ä»¬å°†åœ¨æ•°æ®åº“ä¸Šå®‰è£…PostGISæ‰©å±•ã€‚åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨JavaScriptåœ°ç†å®šä½APIã€‚</h2>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†åœ¨æ•°æ®åº“ä¸Šå®‰è£…PostGISæ‰©å±•ã€‚</p>
<p>åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤:</p>
<p>ç„¶åï¼Œæ‰“å¼€ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶å¹¶ç²˜è´´ä»¥ä¸‹å†…å®¹:</p>
<pre class="language-javascript hljs"> npx sequelize-cli migration:generate --name install-postgis
</pre>
<p>å½“æˆ‘ä»¬è¿è¡Œè¿ç§»æ—¶ï¼Œä¸Šé¢çš„ä»£ç ç‰‡æ®µå°†åœ¨æˆ‘ä»¬çš„æ•°æ®åº“å®ä¾‹ä¸Šå®‰è£…<code>postgis</code>æ‰©å±•ã€‚</p>
<pre class="language-javascript hljs">"use strict";
/** @type {import('sequelize-cli').Migration} */
module.exports = {
  up: (queryInterface, Sequelize) =&gt; {
    return queryInterface.sequelize.query("CREATE EXTENSION postgis;");
  },
  down: (queryInterface, Sequelize) =&gt; {
    return queryInterface.sequelize.query("DROP EXTENSION postgis CASCADE;");
  },
};
</pre>
<p>(æ³¨æ„:åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œç”±äºæƒé™é—®é¢˜ï¼Œæˆ‘æ— æ³•æˆåŠŸè¿è¡Œè¿ç§»æ¥åœ¨ElephantSQLæä¾›çš„Postgreså®ä¾‹ä¸Šå®‰è£…PostGISæ‰©å±•ï¼Œä½†æ˜¯æˆ‘èƒ½å¤Ÿåœ¨Herokuå®ä¾‹ä¸ŠæˆåŠŸè¿è¡Œç›¸åŒçš„æ“ä½œ)</p>
<pre class="language-javascript hljs">npm run migrate
</pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡æ•°æ®åº“æ¥å­˜å‚¨ç”¨æˆ·ä½ç½®ä¿¡æ¯ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºå¦ä¸€ä¸ªè¿ç§»æ–‡ä»¶:</p>
<p>åˆ é™¤å†…å®¹å¹¶ç²˜è´´ä»¥ä¸‹å†…å®¹:</p>
<pre class="language-javascript hljs">npx sequelize-cli model:generate --name Geolocation --attributes socketID:string,location:string
</pre>
<p>â€¦ç„¶åæˆ‘ä»¬å†æ¬¡è¿è¡Œè¿ç§»:</p>
<pre class="language-javascript hljs">"use strict";

/** @type {import('sequelize-cli').Migration} */

module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.createTable("Geolocations", {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER,
        references: {
          model: "Users",
          key: "id",
          as: "id",
        },
      },
      socketID: {
        type: Sequelize.STRING,
        unique: true,
      },
      location: {
        type: Sequelize.GEOMETRY,
      },
      online: {
        type: Sequelize.BOOLEAN,
      },
      trackerID: {
        type: Sequelize.INTEGER,
        references: {
          model: "Users",
          key: "id",
          as: "id",
        },
      },
      createdAt: {
        allowNull: false,
        type: Sequelize.DATE,
      },
      updatedAt: {
        allowNull: false,
        type: Sequelize.DATE,
      },
    });
  },
  async down(queryInterface, Sequelize) {
    await queryInterface.dropTable("Geolocations");
  },
};
</pre>
<p>æˆ‘ä»¬è¿˜æƒ³åœ¨ä¸¤ä¸ªæ¨¡å‹ä¹‹é—´åˆ›å»ºä¸€ä¸ªå…³ç³»ï¼Œæ‰€ä»¥åœ¨models/user.jsä¸­ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨ç”¨æˆ·æ¨¡å‹å’Œåœ°ç†ä½ç½®æ¨¡å‹ä¹‹é—´åˆ›å»ºäº†ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚</p>
<pre class="language-javascript hljs">npm run migrate
</pre>
<p>ç„¶åï¼Œåœ¨models/geolocation.jsä¸­æ·»åŠ :</p>
<pre class="language-javascript hljs">...
static associate(models) {
      // define association here
      this.hasOne(models.Geolocation, { foreignKey: "id" });
    }
...
</pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºå®é™…çš„è·¯ç”±æ¥ä¿ƒè¿›è¿æ¥ã€‚ä¸ºæ­¤ï¼Œè¿›å…¥<code>routes</code>å¹¶åˆ›å»º<code>/track/track.js</code>ã€‚ç„¶åï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹:</p>
<pre class="language-javascript hljs">.... 
static associate(models) {
      // define association here
      this.belongsTo(models.User, { foreignKey: "id" });
    }
....
</pre>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜æƒ³ç¡®ä¿æˆ‘ä»¬æ¯æ¬¡æ³¨å†Œç”¨æˆ·æ—¶ï¼Œéƒ½ä¸ºä»–ä»¬åˆ›å»ºä¸€ä¸ªåœ°ç†ä½ç½®å¯¹è±¡ã€‚</p>
<pre class="language-javascript hljs">const { Router } = require("express");
const db = require("../../models");
const { handleJwt } = require("../../utils/handleJwt");
const trackerRouter = Router();
trackerRouter.post(
  "/book-ride",
  handleJwt.verifyToken,
  async (req, res, next) =&gt; {
    // search for user that is offline
    // assign the booker id to the
    const {
      user,
      body: { location },
    } = req;
    //returns the first user that meets the criteria
    const user2 = await db.User.findOne({
      where: { role: "driver" },
    });
    db.Geolocation.update(
      {
        trackerID: user2.id,
        online: true,
      },
      { where: { id: user.id }, returning: true }
    );
    db.Geolocation.update(
      {
        trackerID: user.id,
        location: {
          type: "Point",
          coordinates: [location.longitude, location.latitude],
        },
        online: true,
      },
      { where: { id: user2.id }, returning: true }
    );
    if (!user2)
      return res.status(404).send({
        success: false,
        message,
      });
    return res.status(200).send({
      success: true,
      message: "You have successfully been assigned a driver",
    });
  }
);
module.exports = { route: trackerRouter, name: "track" };
</pre>
<p>åœ¨routes/user/user.jsæ–‡ä»¶ä¸­åˆ›å»ºç”¨æˆ·æ—¶ï¼Œåœ¨å‘é€å“åº”ä¹‹å‰æ·»åŠ ä»¥ä¸‹å†…å®¹:</p>
<p>å¦‚æœæ‚¨ç°åœ¨æ‰“å¼€POSTMANå¹¶å‘é€è¯·æ±‚ï¼Œæ‚¨åº”è¯¥å¾—åˆ°å“åº”ï¼Œæ‚¨å·²ç»æˆåŠŸåœ°è¢«åˆ†é…äº†ä¸€ä¸ªé©±åŠ¨ç¨‹åºã€‚</p>
<pre class="language-javascript hljs">....
await db.Geolocation.create({ id: user.id });
const token = handleJwt.signToken(user.dataValues);
.....
</pre>
<p>å‘å‡ºå’Œæ¥æ”¶äº‹ä»¶</p>
<h2 id="emitting-receiving-events">æˆ‘ä»¬å°†å‘é€å’Œæ¥æ”¶è¡¨ç¤ºç”¨æˆ·åœ°ç†ä½ç½®çš„å¯¹è±¡ï¼Œè¿™å°†é€šè¿‡åœ°ç†ä½ç½®APIåœ¨webä¸Šå®Œæˆã€‚</h2>
<p>å®ƒä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œå¯¹äºç»å¤§å¤šæ•°ç°ä»£æ¶ˆè´¹è®¾å¤‡(å¦‚æ™ºèƒ½æ‰‹æœºå’Œç¬”è®°æœ¬ç”µè„‘)æ¥è¯´éå¸¸å‡†ç¡®ï¼Œå› ä¸ºå®ƒä»¬å†…ç½®äº†GPSã€‚</p>
<p>å½“æˆ‘ä»¬æ³¨é”€æ•è·æ­¤ä¿¡æ¯çš„å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬æœ‰:</p>
<p>å¦‚æœä½ ç”¨æ‰‹æœºè®¿é—®<a href="https://www.w3schools.com/js/js_api_geolocation.asp"> w3schools </a>ï¼Œè¾¹èµ°è¾¹çœ‹ç»çº¬åº¦ä¿¡æ¯ï¼Œä½ ä¼šå‘ç°ä½ çš„ä½ç½®åœ¨ä¸æ–­å˜åŒ–ï¼Œå®æ—¶åæ˜ ä½ æ‰€å¤„çš„ä½ç½®ã€‚</p>
<pre class="language-javascript hljs">position: {
          coords: {
                       accuracy: 7299.612787273156
                       altitude: null
                       altitudeAccuracy: null
                       heading: null
                       latitude: 6.5568768
                       longitude: 3.3488896
                       speed: null
           },
        timestamp: 1665474267691
}
</pre>
<p>è¿™æ˜¯å› ä¸ºå½“ä½ ç§»åŠ¨çš„æ—¶å€™ï¼Œä½ çš„æ–°ä½ç½®ä¿¡æ¯ä¼šè¢«è§¦å‘ï¼åœ¨ä½ç½®å¯¹è±¡ä¸­è¿˜æ•è·äº†å…¶ä»–ä¿¡æ¯ï¼ŒåŒ…æ‹¬é€Ÿåº¦å’Œé«˜åº¦ã€‚</p>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºå¥—æ¥å­—å¤„ç†ç¨‹åºï¼Œå®ƒå°†å®é™…å‘å‡ºå¹¶ç›‘å¬ç”¨æˆ·å’Œé©±åŠ¨ç¨‹åºä¹‹é—´çš„è¿™äº›äº‹ä»¶ã€‚</p>
<p>åœ¨æˆ‘ä»¬çš„app.jsä¸­ï¼Œç¼–è¾‘ä¸‹é¢ä¸€è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<p>ç„¶åï¼Œæˆ‘ä»¬å°†åœ¨åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—ç›®å½•ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹æ–‡ä»¶:</p>
<pre class="language-javascript hljs">const { onConnection } = require("./socket");

....
io.on("connection", onConnection(io));
....
</pre>
<p><code>driversocket.js</code></p>
<h3 id="driversocket-js">ä¸Šé¢çš„ä»£ç å¤„ç†ç”¨é©±åŠ¨ç¨‹åºä½ç½®æ›´æ–°æ•°æ®åº“ï¼Œå¹¶å°†å…¶å¹¿æ’­ç»™ç›‘å¬ç”¨æˆ·ã€‚</h3>
<pre class="language-javascript hljs">const { updateDbWithNewLocation } = require("./helpers");
const db = require("../models");
const hoistedIODriver = (io, socket) =&gt; {
  return async function driverLocation(payload) {
    console.log(`driver-move event has been received with ${payload} ğŸ¥ğŸ¥¶`);
    const isOnline = await db.Geolocation.findByPk(payload.id);
    if (isOnline.dataValues.online) {
      const recipient = await updateDbWithNewLocation(payload, isOnline);
      if (recipient.trackerID) {
        const deliverTo = await db.Geolocation.findOne({
          where: { trackerID: recipient.trackerID },
        });
        const { socketID } = deliverTo.dataValues;
        io.to(socketID).emit("driver:move", {
          location: recipient.location,
        });
      }
    }
  };
};
module.exports = { hoistedIODriver };
</pre>
<p><code>usersocket.js</code></p>
<h3 id="usersocket-js">ä¸Šé¢çš„ä»£ç å¤„ç†ç”¨ç”¨æˆ·ä½ç½®æ›´æ–°æ•°æ®åº“ï¼Œå¹¶å°†å…¶å¹¿æ’­ç»™ç›‘å¬é©±åŠ¨ç¨‹åºã€‚</h3>
<pre class="language-javascript hljs">const { updateDbWithNewLocation } = require("./helpers");
const db = require("../models");
const hoistedIOUser = (io, socket) =&gt; {
  return async function driverLocation(payload) {
    console.log(
      `user-move event has been received with ${JSON.stringify(payload)} ğŸ…ğŸ‹`
    );
    const isOnline = await db.Geolocation.findByPk(payload.id);
    if (isOnline.dataValues.online) {
      const recipient = await updateDbWithNewLocation(payload, isOnline);
      if (recipient.trackerID) {
        const deliverTo = await db.Geolocation.findOne({
          where: { trackerID: recipient.trackerID },
        });
        const { socketID } = deliverTo.dataValues;
        io.to(socketID).emit("user:move", {
          location: recipient.location,
        });
      }
    }
  };
};
module.exports = { hoistedIOUser };
</pre>
<p><code>index.js</code></p>
<h3 id="index-js">â€¦æœ€å:</h3>
<pre class="language-javascript hljs">const { hoistedIODriver } = require("./driversocket");
const { hoistedIOUser } = require("./usersocket");
const configureSockets = (io, socket) =&gt; {
  return {
    driverLocation: hoistedIODriver(io),
    userLocation: hoistedIOUser(io),
  };
};
const onConnection = (io) =&gt; (socket) =&gt; {
  const { userLocation, driverLocation } = configureSockets(io, socket);
  socket.on("user-move", userLocation);
  socket.on("driver-move", driverLocation);
};
module.exports = { onConnection };
</pre>
<p><code>helpers.js</code></p>
<h3 id="helpers-js">è¦è·å¾—å·¥ä½œä»£ç ç¤ºä¾‹ï¼Œè¯·è®¿é—®<a href="https://github.com/gbols/socket-location.git"> GitHubåº“</a>å¹¶åœ¨åˆ†æ”¯ä¹‹é—´å…‹éš†å’Œå¯¼èˆªã€‚</h3>
<pre class="language-javascript hljs">const db = require("../models");
const updateDbWithNewLocation = async (payload, oldGeoLocationInfo) =&gt; {
  const { id, socketID } = payload;
  const [, [newLocation]] = await db.Geolocation.update(
    {
      online: oldGeoLocationInfo.online,
      socketID,
      trackerID: oldGeoLocationInfo.trackerID,
      location: {
        type: "Point",
        coordinates: [payload.coords.longitude, payload.coords.latitude],
      },
    },
    { where: { id }, returning: true }
  );
  return newLocation;
};
module.exports = { updateDbWithNewLocation };
</pre>
<p>å¥½å§ï¼Œè®©æˆ‘ä»¬å…œä¸€åœˆï¼Œçœ‹çœ‹è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼</p>
<p>æ²¡æœ‰æè¿°</p>
<blockquote class="embedly-card" data-card-controls="1" data-card-align="center" data-card-theme="light">

<p>No Description</p>
</blockquote>
<p>ç»“è®º</p>
<h2 id="conclusion">æ„Ÿè°¢æ‚¨è·Ÿéšæœ¬æ•™ç¨‹å­¦ä¹ Node.jså’ŒSocketçš„ä½¿ç”¨ã€‚IOæ‰“é€ å®æ—¶å®šä½appã€‚</h2>
<p>æˆ‘ä»¬èƒ½å¤Ÿæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨åŸºæœ¬ä½†å¸¸è§çš„å·¥å…·ï¼Œå¼€å§‹å®ç°å¸¦æœ‰WebSocketsçš„ä½ç½®è·Ÿè¸ªåº”ç”¨ç¨‹åºçš„åŠŸèƒ½ã€‚</p>
<p>200åª<img src="../Images/61167b9d027ca73ed5aaf59a9ec31267.png" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png"/> <noscript> <img data-lazy-fallback="1" src="../Images/61167b9d027ca73ed5aaf59a9ec31267.png" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png"/> </noscript>æ˜¾ç¤ºå™¨å‡ºç°æ•…éšœï¼Œç”Ÿäº§ä¸­ç½‘ç»œè¯·æ±‚ç¼“æ…¢</p><div class="code-block code-block-23">
<div class="blog-plug inline-plug node-plug"><h2>éƒ¨ç½²åŸºäºèŠ‚ç‚¹çš„webåº”ç”¨ç¨‹åºæˆ–ç½‘ç«™æ˜¯å®¹æ˜“çš„éƒ¨åˆ†ã€‚ç¡®ä¿æ‚¨çš„èŠ‚ç‚¹å®ä¾‹ç»§ç»­ä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºæä¾›èµ„æºæ˜¯äº‹æƒ…å˜å¾—æ›´åŠ å›°éš¾çš„åœ°æ–¹ã€‚å¦‚æœæ‚¨å¯¹ç¡®ä¿å¯¹åç«¯æˆ–ç¬¬ä¸‰æ–¹æœåŠ¡çš„è¯·æ±‚æˆåŠŸæ„Ÿå…´è¶£ï¼Œ</h2><p>. </p><a href="https://lp.logrocket.com/blg/node-signup" target="_blank">try LogRocket</a><p>LogRocket å°±åƒæ˜¯ç½‘ç»œå’Œç§»åŠ¨åº”ç”¨ç¨‹åºçš„DVRï¼Œè®°å½•ä¸‹ç”¨æˆ·ä¸ä½ çš„åº”ç”¨ç¨‹åºäº¤äº’æ—¶å‘ç”Ÿçš„ä¸€åˆ‡ã€‚æ‚¨å¯ä»¥æ±‡æ€»å¹¶æŠ¥å‘Šæœ‰é—®é¢˜çš„ç½‘ç»œè¯·æ±‚ï¼Œä»¥å¿«é€Ÿäº†è§£æ ¹æœ¬åŸå› ï¼Œè€Œä¸æ˜¯çŒœæµ‹é—®é¢˜å‘ç”Ÿçš„åŸå› ã€‚</p><a class="signup" href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer"><img src="../Images/cae72fd2a54c5f02a6398c4867894844.png" alt="LogRocket Network Request Monitoring" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png"/><noscript><img data-lazy-fallback="1" src="../Images/cae72fd2a54c5f02a6398c4867894844.png" alt="LogRocket Network Request Monitoring" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png"/></noscript></a><a href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer">https://logrocket.com/signup/</a><p>LogRocketæ£€æµ‹æ‚¨çš„åº”ç”¨ç¨‹åºä»¥è®°å½•åŸºçº¿æ€§èƒ½è®¡æ—¶ï¼Œå¦‚é¡µé¢åŠ è½½æ—¶é—´ã€åˆ°è¾¾ç¬¬ä¸€ä¸ªå­—èŠ‚çš„æ—¶é—´ã€æ…¢é€Ÿç½‘ç»œè¯·æ±‚ï¼Œè¿˜è®°å½•Reduxã€NgRxå’ŒVuexæ“ä½œ/çŠ¶æ€ã€‚</p><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer">Start monitoring for free</a><p>. </p></div>
</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>