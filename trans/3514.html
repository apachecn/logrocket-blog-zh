<html>
<head>
<title>End-to-end testing in NestJS with TypeORM </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>ä½¿ç”¨TypeORMåœ¨NestJSä¸­è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/#0001-01-01">https://blog.logrocket.com/end-end-testing-nestjs-typeorm/#0001-01-01</a></blockquote><div><article class="article-post">
<p>è´¨é‡ä¿è¯ç­–ç•¥æ˜¯è½¯ä»¶å¼€å‘çš„ä¸€ä¸ªå…³é”®æ–¹é¢ã€‚é«˜ç«¯æµ‹è¯•ï¼Œæ¯”å¦‚å•å…ƒæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•ï¼Œæ˜¯QAç­–ç•¥çš„é‡è¦æ–¹é¢ã€‚</p>
<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬çš„é‡ç‚¹å°†æ˜¯åœ¨<a href="https://nestjs.com/" rel="noopener"> NestJS </a>ä¸­åˆ›å»ºç«¯åˆ°ç«¯æµ‹è¯•ã€‚NestJSè‡ªå¸¦Jestå’ŒSupertestæ¥åˆ›å»ºå•å…ƒæµ‹è¯•ã€‚æˆ‘ä»¬å°†æ¢ç´¢æµ‹è¯•é©±åŠ¨å¼€å‘å’Œå¼€å‘å•å…ƒæµ‹è¯•èƒŒåçš„æ€ç»´è¿‡ç¨‹ã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨å•å…ƒæµ‹è¯•æ¥æŒ‡å¯¼APIä¸­äº§å“åˆ›å»ºç‰¹æ€§çš„å¼€å‘ï¼Œè€Œç«¯åˆ°ç«¯æµ‹è¯•å°†æ¨¡æ‹Ÿåº”ç”¨ç¨‹åºçš„æœ€ç»ˆç”¨æˆ·ã€‚åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ï¼ŒTypeORM å’Œ<a href="https://www.postgresql.org/" rel="noopener"> PostgreSQL </a>æä¾›äº†æ•°æ®åº“è¿æ¥ã€‚</p>
<p>NestJSä¸ºæ„å»ºæœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºæä¾›äº†ä¸€ä¸ªæ¡†æ¶ã€‚NestJSä¾èµ–äºTypeScriptå’Œä¾èµ–æ³¨å…¥ï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿç¼–å†™æµ‹è¯•ã€‚NestJS CLI scaffoldsé¡¹ç›®æ”¯æŒåˆ›å»ºæ§åˆ¶å™¨å’ŒæœåŠ¡ï¼Œå¹¶åœ¨åˆ›å»ºæœåŠ¡å™¨æˆ–æ§åˆ¶å™¨æ—¶ç”Ÿæˆæµ‹è¯•æ–‡ä»¶ã€‚</p>
<p><em>å‘å‰è·³è½¬:</em></p>

<h2 id="what-test-driven-development">ä»€ä¹ˆæ˜¯æµ‹è¯•é©±åŠ¨å¼€å‘ï¼Ÿ</h2>
<p>æµ‹è¯•é©±åŠ¨å¼€å‘(TDD)ä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿåœ¨æµ‹è¯•çš„æŒ‡å¯¼ä¸‹æ„å»ºè½¯ä»¶ã€‚è¿™ä½¿å¾—å¿«é€Ÿæµ‹è¯•ã€ç¼–ç å’Œé‡æ„æˆä¸ºå¯èƒ½ã€‚Kent Beck åœ¨20ä¸–çºª90å¹´ä»£æ™šæœŸå¼€å‘äº†TDDã€‚</p>
<p>éµå¾ªæµ‹è¯•é©±åŠ¨å¼€å‘æœ‰ä¸‰ä¸ªç®€å•çš„è§„åˆ™:</p>
<ol>
<li>ä¸ºä¸‹ä¸€ä¸ªåŠŸèƒ½ç¼–å†™ä¸€ä¸ªæµ‹è¯•</li>
<li>åœ¨æµ‹è¯•é€šè¿‡ä¹‹å‰ï¼Œä»£ç å¿…é¡»æ˜¯æœ‰æ•ˆçš„</li>
<li>é‡æ„å¯¹äºç¡®ä¿æ–°æ—§ä»£ç ç»“æ„è‰¯å¥½è‡³å…³é‡è¦</li>
</ol>
<p>å®è·µæ—¶ï¼Œæµ‹è¯•é©±åŠ¨å¼€å‘æä¾›äº†å¾ˆå¤§çš„ä¼˜åŠ¿ã€‚ä½¿ç”¨TDDçš„å¼€å‘äººå‘˜å¿…é¡»å¯¹ä»£ç çš„æ¥å£å»ºæ¨¡ï¼Œè¿™ä½¿å¾—æ¥å£ä¸å®ç°åˆ†ç¦»ã€‚æµ‹è¯•æ˜¯ä»ç±»çš„å…¬å…±æ¥å£çš„è§’åº¦åˆ›å»ºçš„ï¼Œè¿™æ„å‘³ç€å…³é”®çš„ç„¦ç‚¹æ˜¯ç±»çš„è¡Œä¸ºè€Œä¸æ˜¯å®ç°ã€‚</p>
<p>åœ¨ç”Ÿäº§ç®¡é“ä¸­ï¼Œè¿™äº›æµ‹è¯•å‡ ä¹åœ¨æ¯ä¸ªæ„å»ºä¸Šè¿è¡Œï¼Œç¡®ä¿ä»£ç çš„è¡Œä¸ºã€‚å¦‚æœä¸€ä¸ªå›¢é˜Ÿæˆå‘˜å¯¹ä»£ç è¿›è¡Œäº†ä¿®æ”¹ï¼Œä»è€Œæ”¹å˜äº†è¡Œä¸ºï¼Œé‚£ä¹ˆæµ‹è¯•å°±ä¼šå¤±è´¥ï¼Œå‘å‡ºå‡ºé”™çš„ä¿¡å·ã€‚è¿™èŠ‚çœäº†è°ƒè¯•æ—¶é—´ã€‚</p>
<p>ä¸‹å›¾å¼ºè°ƒäº†æµ‹è¯•é©±åŠ¨å¼€å‘èƒŒåçš„ç†å¿µ:</p>
<p><img data-attachment-id="138584" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/tdd-cycle/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png" data-orig-size="730,1290" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="tdd-cycle" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-170x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-579x1024.png" decoding="async" class="aligncenter wp-image-138584 size-full jetpack-lazy-image" src="../Images/e661483797934202e0e5d05af60bca0b.png" alt="The TDD cycle" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-170x300.png 170w, https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-579x1024.png 579w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138584" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/tdd-cycle/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png" data-orig-size="730,1290" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="tdd-cycle" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-170x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-579x1024.png" decoding="async" loading="lazy" class="aligncenter wp-image-138584 size-full" src="../Images/e661483797934202e0e5d05af60bca0b.png" alt="The TDD cycle" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-170x300.png 170w, https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle-579x1024.png 579w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/tdd-cycle.png"/></noscript>
<p>è¦ä½¿ç”¨TDDï¼Œâ€œçº¢â€ã€â€œç»¿â€å’Œâ€œé‡æ„â€å¾ªç¯æ˜¯å¼ºåˆ¶æ€§çš„ã€‚è¯¥å¾ªç¯å°†ä¸€ç›´è¿è¡Œï¼Œç›´åˆ°æ–°ç‰¹æ€§å‡†å¤‡å¥½å¹¶ä¸”æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡ã€‚</p>
<p>è®©æˆ‘ä»¬æ¢ç´¢TDDæ–¹æ³•èƒŒåçš„æ­¥éª¤ã€‚</p>
<h2 id="test-driven-development-steps">æµ‹è¯•é©±åŠ¨çš„å¼€å‘æ­¥éª¤</h2>
<h3 id="think">1.æƒ³</h3>
<p>TDDçš„è¦ç‚¹æ˜¯åˆ›å»ºå°çš„æµ‹è¯•å¹¶ç¼–å†™è¿«ä½¿æµ‹è¯•é€šè¿‡çš„ä»£ç ã€‚è¿­ä»£è¿‡ç¨‹ä¸€ç›´æŒç»­åˆ°ç‰¹å¾å®Œæˆã€‚åœ¨â€œæ€è€ƒâ€æ­¥éª¤ä¸­ï¼Œé‡è¦çš„æ˜¯æƒ³è±¡å¹¶æ³¨æ„ä»£ç åº”è¯¥è¡¨ç°å‡ºä»€ä¹ˆè¡Œä¸ºã€‚éœ€è¦æœ€å°‘ä»£ç è¡Œçš„æœ€å°å¢é‡æ˜¯å…³é”®â€”â€”æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå°çš„æµ‹è¯•å•å…ƒï¼Œç›´åˆ°è¡Œä¸ºä»¥è¿™ç§æ–¹å¼å‡ºç°ã€‚</p>
<h3 id="red-bar">2.çº¢è‰²é…’å§</h3>
<p>åœ¨çº¢è‰²æ¡ä¸­ï¼Œå­˜åœ¨çš„å•å…ƒæµ‹è¯•åº”è¯¥è¦†ç›–è¡Œä¸ºçš„å½“å‰å¢é‡ã€‚æµ‹è¯•å¯ä»¥åŒ…å«å°šä¸å­˜åœ¨çš„æ–¹æ³•å’Œç±»åã€‚ç±»æ¥å£çš„è®¾è®¡æ˜¯ä»ç±»ç”¨æˆ·çš„è§’åº¦åˆ›å»ºçš„ã€‚</p>
<p>ä¸€æ—¦æµ‹è¯•å°±ç»ªï¼Œå¹¶ä¸”æ‚¨è¿è¡Œäº†æ•´ä¸ªå¥—ä»¶ï¼Œæ–°çš„æµ‹è¯•åº”è¯¥ä¼šå¤±è´¥ã€‚åœ¨å¤§å¤šæ•°TDDæµ‹è¯•å·¥å…·ä¸­ï¼Œå¤±è´¥çš„æµ‹è¯•ä¼šäº§ç”Ÿä¸€ä¸ªçº¢æ¡ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ·±å…¥äº†è§£å¤±è´¥çš„åŸå› ã€‚</p>
<h3 id="green-bar">3.ç»¿è‰²æ¡</h3>
<p>åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†é‡ç‚¹æ”¾åœ¨ç¼–å†™ç”Ÿäº§å°±ç»ªä»£ç ä»¥é€šè¿‡æµ‹è¯•ã€‚ä¸€æ—¦æµ‹è¯•è¿è¡Œï¼Œæˆ‘ä»¬çš„ç»“æœåº”è¯¥æ˜¯ä¸€ä¸ªç»¿è‰²çš„è¿›åº¦æ¡ï¼Œè¿™å–å†³äºæ­£åœ¨ä½¿ç”¨çš„TDDæµ‹è¯•å·¥å…·ã€‚ç»¿æ¡æ­¥éª¤æä¾›äº†å¦ä¸€ä¸ªæœºä¼šæ¥å¯¹ç…§ç°å®æ£€æŸ¥æˆ‘ä»¬çš„æ„å›¾ã€‚</p>
<h2 id="creating-application">åˆ›å»ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åº</h2>
<p>ç”¨<a href="https://docs.nestjs.com/cli/overview" rel="noopener"> NestJS CLI </a>åˆ›å»ºä¸€ä¸ªNestJSé¡¹ç›®ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªäº§å“ç®¡ç†åº”ç”¨ç¨‹åºã€‚</p>
<h3 id="prerequisites">å…ˆå†³æ¡ä»¶</h3>
<ul>
<li>npm :ç”¨äºå‘å…¬å…±npmæ³¨å†Œä¸­å¿ƒå‘å¸ƒå’Œå®‰è£…è½¯ä»¶åŒ…</li>
<li><a href="https://nodejs.org/en/" rel="noopener"> Node.js </a> v â‰¥ 12ï¼Œv 13é™¤å¤–</li>
</ul>
<h3 id="install-nest-js-cli">å®‰è£…NestJS CLI</h3>
<p>è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…NestJS CLI:</p>
<pre class="language-bash hljs">$ npm install -g @nestjs/cli</pre>
<h3 id="creating-unit-tests">åˆ›å»ºæˆ‘ä»¬çš„å•å…ƒæµ‹è¯•</h3>
<p>æˆ‘ä»¬å°†è¦æµ‹è¯•çš„ä»£ç åº“å¯ä»¥åœ¨GitHubåº“ä¸­æ‰¾åˆ°ã€‚å…‹éš†å¹¶å¯¼èˆªåˆ°é¡¹ç›®çš„æ ¹ç›®å½•ã€‚</p>
<p>æ ¹æ®åŒ…ç®¡ç†å™¨ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚</p>
<p>å¯¹äºçº±çº¿:</p>
<pre class="language-bash hljs">$ yarn</pre>
<p>å¯¹äºå›½å®¶é¢„é˜²æœºåˆ¶:</p>
<pre class="language-bash hljs">$ npm install</pre>
<p>å®‰è£…å®Œä¾èµ–é¡¹åï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨é¡¹ç›®ã€‚</p>
<pre class="language-bash hljs">$ yarn start:dev</pre>
<p>å¦‚æœæ²¡æœ‰ä¾èµ–é—®é¢˜æˆ–é”™è¯¯ï¼Œé¡¹ç›®åº”è¯¥åœ¨ç»ˆç«¯ä¸­å¼€å§‹:</p>
<p><img data-attachment-id="138587" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/project-terminal/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png" data-orig-size="730,204" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="project-terminal" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal-300x84.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png" decoding="async" class="aligncenter wp-image-138587 size-full jetpack-lazy-image" src="../Images/af788f999133bb8a7b331b7a8c8b76ce.png" alt="Project starting in the terminal" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal-300x84.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138587" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/project-terminal/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png" data-orig-size="730,204" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="project-terminal" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal-300x84.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png" decoding="async" loading="lazy" class="aligncenter wp-image-138587 size-full" src="../Images/af788f999133bb8a7b331b7a8c8b76ce.png" alt="Project starting in the terminal" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal-300x84.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/project-terminal.png"/></noscript>
<h2 id="developing-product-api-tdd">ç”¨TDDå¼€å‘æˆ‘ä»¬çš„äº§å“API</h2>
<p>äº§å“æ§åˆ¶å™¨å¤„ç†äº§å“çš„åˆ›å»ºå¹¶æ£€ç´¢äº§å“ã€‚</p>
<p>ä½¿ç”¨ç»ˆç«¯ï¼Œä½¿ç”¨CLIå·¥å…·åˆ›å»ºäº§å“æ§åˆ¶å™¨å’ŒæœåŠ¡ã€‚æ§åˆ¶å™¨å’ŒæœåŠ¡ç°åœ¨å¯ä»¥ä½¿ç”¨æµ‹è¯•æ–‡ä»¶äº†ã€‚</p>
<pre class="language-bash hljs">$ nest g controller product
$ nest g service product</pre>
<p>å½“ä½¿ç”¨Nest CLIåˆ›å»ºæ§åˆ¶å™¨å’ŒæœåŠ¡æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªé™„å¸¦çš„æµ‹è¯•æ–‡ä»¶:</p>
<p><img data-attachment-id="138590" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/test-file/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png" data-orig-size="730,727" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="test-file" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-300x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png" decoding="async" class="aligncenter wp-image-138590 size-full jetpack-lazy-image" src="../Images/fc58177df7792314076830f84823bd50.png" alt="Accompanying test file" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-300x300.png 300w, https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-150x150.png?crop=1 150w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138590" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/test-file/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png" data-orig-size="730,727" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="test-file" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-300x300.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png" decoding="async" loading="lazy" class="aligncenter wp-image-138590 size-full" src="../Images/fc58177df7792314076830f84823bd50.png" alt="Accompanying test file" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-300x300.png 300w, https://blog.logrocket.com/wp-content/uploads/2022/10/test-file-150x150.png?crop=1 150w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/test-file.png"/></noscript>
<p>æˆ‘ä»¬å¸Œæœ›äº§å“æ§åˆ¶è€…çš„ç¬¬ä¸€ä¸ªè¡Œä¸ºæ˜¯åˆ›é€ æ–°äº§å“çš„èƒ½åŠ›ã€‚ä¸ºäº†è€ƒè™‘äº§å“è¡¨ä¸­çš„æ•°æ®ç»“æ„ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªäº§å“æ¥å£å’Œå®ä½“å¯¹è±¡ã€‚</p>
<p>åœ¨ç»ˆç«¯çª—å£ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹:</p>
<pre class="language-bash hljs">$ mkdir src/product/models
$ touch src/product/models/product.interface.ts
$ touch src/product/models/product.entity.ts
$ code src/product/models/product.entity.ts</pre>
<p>æœ€åä¸€ä¸ªè„šæœ¬åœ¨ä»£ç ç¼–è¾‘å™¨ä¸­æ‰“å¼€<code>product.entity.ts</code>æ–‡ä»¶ã€‚å°†ä»¥ä¸‹ä»£ç å¤åˆ¶å¹¶ç²˜è´´åˆ°æ–‡ä»¶ä¸­:</p>
<pre class="language-typescript hljs">import {
  Column,
  CreateDateColumn,
  Entity,
  ManyToOne,
  PrimaryGeneratedColumn,
} from "typeorm";
import { UserEntity } from "../../auth/models/user.entity";

@Entity("product")
export class ProductEntity {
  @PrimaryGeneratedColumn()
  id: number;

  @Column({ default: "" })
  body: string;

  @CreateDateColumn()
  createdAt: Date;

  @ManyToOne(() =&gt; UserEntity, (userEntity) =&gt; userEntity.products)
  creator: UserEntity;
}
</pre>
<p>ç”¨ä¸‹é¢çš„å‘½ä»¤åœ¨ä»£ç ç¼–è¾‘å™¨ä¸­æ‰“å¼€<code>product.entity.ts</code>æ–‡ä»¶:</p>
<pre class="language-bash hljs">$ code src/product/models/product.interface.ts</pre>
<p>å°†ä¸‹é¢çš„ä»£ç å—ç²˜è´´åˆ°<code>product.interface.ts</code>æ–‡ä»¶ä¸­:</p>
<pre class="language-typescript hljs">import { User } from "src/auth/models/user.class";

export interface Product {
  id?: number;
  body?: string;
  createdAt: Date;
  creator?: User;
}
</pre>
<h3 id="create-product-feature">åˆ›å»ºäº§å“ç‰¹å¾</h3>
<p>åœ¨æˆ‘ä»¬åˆ›å»ºäº§å“åˆ›å»ºè·¯çº¿ä¹‹å‰ï¼Œéœ€è¦æœ‰ä¸€ä¸ªå•å…ƒæµ‹è¯•ã€‚è¿™ä¸ªå•å…ƒæµ‹è¯•ç¡®è®¤äº†å‡½æ•°çš„å®ç°ã€‚</p>
<p>åœ¨ç»ˆç«¯çª—å£ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨ä»£ç ç¼–è¾‘å™¨ä¸­æ‰“å¼€æµ‹è¯•æ–‡ä»¶:</p>
<pre class="language-bash hljs">$ code src/product/controllers/product.controller.spec.ts</pre>
<p>æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæµ‹è¯•éœ€è¦ç¡®è®¤äº§å“åˆ›å»ºæœåŠ¡åˆ›å»ºäº†ä¸€ä¸ªäº§å“ã€‚æµ‹è¯•æ¨¡æ‹Ÿ<code>UserService</code>å’Œ<code>ProductService</code>ã€‚Jeståˆ›å»ºäº†æœåŠ¡ä¸­å‡½æ•°å®ç°çš„æ¨¡æ‹Ÿã€‚</p>
<p>åœ¨<code>product.controller.spec.ts</code>ä¸­å®ç°çš„<code>describe</code>å—å¯ç”¨ã€‚æ‰“é€ äº§å“æœåŠ¡çš„<code>mockImplementation</code>ï¼›è¿™æ˜¯<code>createProduct</code>å®ç°çš„å®¿ä¸»ã€‚è¿™ä¸ª<code>createProduct</code>æ–¹æ³•æ¥å—ä¸€ä¸ªè¯·æ±‚å¹¶è¿”å›ä¸€ä¸ªåˆ›å»ºçš„äº§å“å’ŒIDã€‚</p><div class="code-block code-block-54">
<hr/>
<h3>æ›´å¤šæ¥è‡ªLogRocketçš„ç²¾å½©æ–‡ç« :</h3>

<hr/></div>
<p>ä¸ºäº†å¸®åŠ©æ¨¡ä»¿HTTPå¯¹è±¡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code><a href="https://www.npmjs.com/package/node-mocks-http" rel="noopener">node-mocks-http library</a></code>ã€‚å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°æˆ‘ä»¬çš„<code>product.controller.spec.ts</code>æ–‡ä»¶ä¸­:</p>
<pre class="language-typescript hljs">import { Test, TestingModule } from "@nestjs/testing";
import { DeleteResult, UpdateResult } from "typeorm";
import { User } from "../../auth/models/user.class";
import { JwtGuard } from "../../auth/guards/jwt.guard";
import { UserService } from "../../auth/services/user.service";
import { ProductController } from "./product.controller";
import { ProductService } from "../services/product.service";
import { Product } from "../models/product.interface";

const httpMocks = require("node-mocks-http");

describe("ProductController", () =&gt; {
  let productController: ProductController;

  const mockRequest = httpMocks.createRequest();
  mockRequest.user = new User();
  mockRequest.user = "DUE";

 const mockProduct: Product = {
    body: "nivea",
    createdAt: new Date(),
    creator: mockRequest.user,
  };

  const mockProductService = {
    createProduct: jest
      .fn()
      .mockImplementation((user: User, product: Product) =&gt; {
        return {
          id: 1,
          ...product,
        };
      })
  };
  const mockUserService = {};

  // create fake module
  beforeEach(async () =&gt; {
    const moduleRef: TestingModule = await Test.createTestingModule({
      controllers: [ProductController],
      providers: [
        ProductService,
        { provide: UserService, useValue: mockUserService },
        {
          provide: JwtGuard,
          useValue: jest.fn().mockImplementation(() =&gt; true),
        },
      ],
    })
      .overrideProvider(ProductService)
      .useValue(mockProductService)
      .compile();

    productController = moduleRef.get&lt;ProductController&gt;(ProductController);
  });
});
</pre>
<p>ä¸ºäº†ç»“æŸå•å…ƒæµ‹è¯•ï¼Œéœ€è¦è®¾ç½®åŠ¨ä½œåŠå…¶å“åº”ã€‚å°†ä»¥ä¸‹ä»£ç ç²˜è´´åœ¨<code>describe</code>å‡½æ•°çš„æœ«å°¾ã€‚</p>
<pre class="language-typescript hljs"> it("should create a product", () =&gt; {
    expect(productController.create(mockProduct, mockRequest)).toEqual({
      id: expect.any(Number),
      ...mockProduct,
    });
  });
</pre>
<p>åœ¨<code>product.controller.ts</code>æ–‡ä»¶ä¸­ï¼Œè®¾ç½®<code>create</code>æ–¹æ³•ã€‚å¯¼å…¥ä¾èµ–é¡¹ã€äº§å“ç•Œé¢å’Œäº§å“å®ä½“ã€‚</p>
<pre class="language-typescript hljs">import { Body, Controller, Post, Request, UseGuards } from "@nestjs/common";
import { Observable } from "rxjs";

import { JwtGuard } from "../auth/guards/jwt.guard";
import { Product } from "../product/models/product.interface";
import { ProductService } from "../product/services/product.service";

@Controller("product")
export class ProductController {
  constructor(private productService: ProductService) {}
  @UseGuards(JwtGuard)
  @Post()
  create(@Body() product: Product, @Request() req): Observable&lt;Product&gt; {
    return this.productService.createProduct(req.user, product);
  }
}
</pre>
<h3 id="run-first-unit-test">è¿è¡Œç¬¬ä¸€ä¸ªå•å…ƒæµ‹è¯•</h3>
<p>åœ¨æ–°çš„ç»ˆç«¯çª—å£ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œåˆ›å»ºçš„æµ‹è¯•:</p>
<pre class="language-bash hljs">$ yarn test product.controller</pre>
<p>æµ‹è¯•åº”è¯¥ä¼šå¤±è´¥ï¼Œå› ä¸ºå®ç°è¿˜æ²¡æœ‰å®Œæˆã€‚è¿™ä¸ºæˆ‘ä»¬å¦‚ä½•åˆ©ç”¨TDDæ¥æ”¹è¿›æˆ‘ä»¬çš„å¼€å‘å’Œæ•è·bugæä¾›äº†æ´å¯ŸåŠ›ã€‚æˆ‘ä»¬çš„æµ‹è¯•å¤±è´¥äº†ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•ä¸åœ¨<code>product.service.ts</code>æ–‡ä»¶ä¸­ã€‚</p>
<p><img data-attachment-id="138593" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/failing-test-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png" data-orig-size="730,106" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="failing-test" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test-300x44.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png" decoding="async" class="aligncenter wp-image-138593 size-full jetpack-lazy-image" src="../Images/2169599dac54cb37142ebef89d031d48.png" alt="Failing test" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test-300x44.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138593" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/failing-test-2/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png" data-orig-size="730,106" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="failing-test" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test-300x44.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png" decoding="async" loading="lazy" class="aligncenter wp-image-138593 size-full" src="../Images/2169599dac54cb37142ebef89d031d48.png" alt="Failing test" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test-300x44.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/failing-test.png"/></noscript>
<p>åœ¨ç»ˆç«¯çª—å£ä¸­ï¼Œæ‰“å¼€<code>product.service.ts</code>æ–‡ä»¶å¹¶ç²˜è´´ä¸‹é¢çš„ä»£ç å—:</p>
<pre class="language-typescript hljs">import { Inject, Injectable } from "@nestjs/common";
import { InjectRepository } from "@nestjs/typeorm";
import { from, Observable } from "rxjs";
import { DeleteResult, Repository, UpdateResult } from "typeorm";

import { User } from "src/auth/models/user.class";
import { ProductEntity } from "../models/product.entity";
import { Product } from "../models/product.interface";

@Injectable()
export class ProductService {
  constructor(
    @InjectRepository(ProductEntity)
    private readonly productRepository: Repository&lt;ProductEntity&gt;
  ) {}

  createProduct(user: User, product: Product): Observable&lt;Product&gt; {
    product.creator = user;
    return from(this.productRepository.save(product));
  }
}
</pre>
<p>åœ¨ç»ˆç«¯çª—å£ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡æ–°è¿è¡Œ<code>product.controller</code>æµ‹è¯•:</p>
<pre class="language-bash hljs">$ yarn test product.controller</pre>
<p>é€šè¿‡åœ¨æˆ‘ä»¬çš„æœåŠ¡ç±»ä¸­æ·»åŠ <code>createProduct</code>æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><img data-attachment-id="138597" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/fixing-issue/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png" data-orig-size="730,205" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="fixing-issue" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue-300x84.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png" decoding="async" class="aligncenter wp-image-138597 size-full jetpack-lazy-image" src="../Images/300923f6278345405a8c2593e1349f93.png" alt="Fixing the issue" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue-300x84.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138597" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/fixing-issue/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png" data-orig-size="730,205" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="fixing-issue" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue-300x84.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png" decoding="async" loading="lazy" class="aligncenter wp-image-138597 size-full" src="../Images/300923f6278345405a8c2593e1349f93.png" alt="Fixing the issue" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue-300x84.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/fixing-issue.png"/></noscript>
<p>è¿™ä¸ªå‘¨æœŸå¯¹äºå¼€å‘åº”ç”¨ç¨‹åºä¸­çš„æ–°åŠŸèƒ½æ¥è¯´æ›´é•¿ã€‚è¿™ä¸ªå¾ªç¯ä¿è¯äº†åˆ›å»ºçš„æ–¹æ³•æ˜¯ç»è¿‡æ·±æ€ç†Ÿè™‘çš„ã€‚</p>
<h3 id="creating-create-product-feature-nest-js-application">ä½¿ç”¨NestJSåº”ç”¨ç¨‹åºåˆ›å»ºåˆ›å»ºäº§å“åŠŸèƒ½</h3>
<p>Create Product routeæœ‰ä¸€ä¸ªç”¨äºä¿æŠ¤çš„AuthGuardï¼Œå› æ­¤ä¸ºäº†æµ‹è¯•å®ƒï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç”¨æˆ·å’Œç™»å½•å‡­è¯ã€‚ç™»å½•åï¼Œä»¤ç‰Œä¼šå¯¹åˆ›å»ºäº§å“çš„ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚</p>
<p>ä¸‹é¢çš„æˆªå›¾æ˜¾ç¤ºäº†å¦‚ä½•æ³¨å†Œå’Œç™»å½•ç”¨æˆ·ã€‚</p>
<p><img data-attachment-id="138601" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/register-login-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png" data-orig-size="730,473" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="register-login-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user-300x194.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png" decoding="async" class="aligncenter wp-image-138601 size-full jetpack-lazy-image" src="../Images/d7d17520ccafafb13b6db38cb8388726.png" alt="Register and login a user" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user-300x194.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138601" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/register-login-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png" data-orig-size="730,473" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="register-login-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user-300x194.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png" decoding="async" loading="lazy" class="aligncenter wp-image-138601 size-full" src="../Images/d7d17520ccafafb13b6db38cb8388726.png" alt="Register and login a user" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user-300x194.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/register-login-user.png"/></noscript>
<p>å¦‚ä½•æ³¨å†Œç”¨æˆ·:</p>
<p><img data-attachment-id="138603" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/how-register-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png" data-orig-size="730,411" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="how-register-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user-300x169.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png" decoding="async" class="aligncenter wp-image-138603 size-full jetpack-lazy-image" src="../Images/ea149a2f97f3d783939b6a93995669c6.png" alt="how to register the user" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user-300x169.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138603" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/how-register-user/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png" data-orig-size="730,411" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="how-register-user" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user-300x169.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png" decoding="async" loading="lazy" class="aligncenter wp-image-138603 size-full" src="../Images/ea149a2f97f3d783939b6a93995669c6.png" alt="how to register the user" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user-300x169.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/how-register-user.png"/></noscript>
<p>ç”¨æˆ·ç™»å½•åï¼Œæ£€ç´¢ä»¤ç‰Œå¹¶ä½¿ç”¨å®ƒæ¥åˆ›å»ºäº§å“ã€‚</p>
<p><img data-attachment-id="138606" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/create-product/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png" data-orig-size="730,486" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="create-product" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product-300x200.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png" decoding="async" class="aligncenter wp-image-138606 size-full jetpack-lazy-image" src="../Images/99dfa4e44de757f4ff2d22841181579a.png" alt="Create a product" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/create-product-300x200.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138606" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/create-product/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png" data-orig-size="730,486" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="create-product" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product-300x200.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png" decoding="async" loading="lazy" class="aligncenter wp-image-138606 size-full" src="../Images/99dfa4e44de757f4ff2d22841181579a.png" alt="Create a product" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/create-product-300x200.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/create-product.png"/></noscript>
<p><strong>åˆ›å»ºäº§å“</strong>åŠŸèƒ½è¿è¡Œé¡ºç•…ã€‚ğŸ‘Œ</p>
<h3 id="creating-get-product-feature">åˆ›å»ºè·å–äº§å“ç‰¹å¾</h3>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æ¢ç´¢æˆ‘ä»¬åˆšåˆšç”¨æ¥åˆ›å»ºGet Productç‰¹æ€§çš„TDDæŠ€æœ¯ã€‚â€œè·å–äº§å“â€åŠŸèƒ½å…è®¸æ ¹æ®è¾“å…¥å€¼æ£€ç´¢äº§å“ã€‚</p>
<p>åœ¨<code>product.controller.spec.ts</code>æ–‡ä»¶ä¸­ï¼Œä¼ æ’­ä¸€ä¸ªå•å…ƒæµ‹è¯•æ¥æµ‹è¯•æ£€ç´¢é¡¹ç›®çš„è¡Œä¸ºã€‚</p>
<p>åœ¨<code>product.controller.spec.ts</code>æ–‡ä»¶ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ¨¡æ‹Ÿè¯·æ±‚ï¼Œä½œä¸ºè¯·æ±‚ä¸­é¢„æœŸå¯¹è±¡çš„è¡¨ç¤ºï¼Œç„¶ååˆ›å»ºä¸€ä¸ª<code>mockProducts</code>å˜é‡ã€‚</p>
<pre class="language-typescript hljs">const mockProducts: Product[] = [
    mockProduct,
    { ...mockProduct, body: "Vanilla" },
    { ...mockProduct, body: "Ice" },
  ];
</pre>
<p><code>mockProductService</code>å¯¹è±¡æ‹¥æœ‰ä¸€ä¸ªæ–°æ–¹æ³•ï¼Œå¯ä»¥åœ¨æ£€ç´¢æœŸé—´æ¥æ”¶å€¼ã€‚</p>
<pre class="language-typescript hljs">  const mockProductService = {
    createProduct: jest
      .fn()
      .mockImplementation((user: User, product: Product) =&gt; {
        return {
          id: 1,
          ...product,
        };
      }),
    findProducts: jest
      .fn()
      .mockImplementation((numberToTake: number, numberToSkip: number) =&gt; {
        const productsAfterSkipping = mockProducts.slice(numberToSkip);
        const filteredProducts = productsAfterSkipping.slice(0, numberToTake);
        return filteredProducts;
      }),
  };
</pre>
<p>ä¸‹ä¸€æ­¥æ˜¯å®šä¹‰æˆ‘ä»¬æƒ³è¦è¿è¡Œçš„æµ‹è¯•ã€‚æˆ‘ä»¬çš„<code>take</code>å’Œ<code>skip</code>å€¼åˆ†åˆ«æ˜¯<code>2</code>å’Œ<code>1</code>ã€‚è¿™äº›å€¼ç”¨ä½œå‚æ•°ã€‚</p>
<pre class="language-typescript hljs"> it("should get 2 products, skipping the first", () =&gt; 
    expect(productController.findSelected(2, 1)).toEqual(mockProducts.slice(1));
  });
</pre>
<p>è¿è¡Œæµ‹è¯•ã€‚å®ƒåº”è¯¥ä¼šå¤±è´¥ï¼Œå› ä¸ºæ§åˆ¶å™¨ä¸­æ²¡æœ‰å¿…è¦çš„æ–¹æ³•ã€‚</p>
<p>åœ¨<code>product.controller.ts</code>æ–‡ä»¶ä¸­ï¼Œåˆ›å»º<code>GET</code>è·¯çº¿:</p>
<pre class="language-typescript hljs">import {
  Body,
  Controller,
  Get,
  Param,
  Post,
  Query,
  Req,
  Request,
  Res,
  UseGuards,
} from "@nestjs/common";
import { Observable } from "rxjs";
import { JwtGuard } from "../../auth/guards/jwt.guard";
import { Product } from "../models/product.interface";
import { ProductService } from "../services/product.service";

@Controller("product")
export class ProductController {
  constructor(private productService: ProductService) {}

  @UseGuards(JwtGuard)
  @Post()
  create(@Body() product: Product, @Request() req): Observable&lt;Product&gt; {
    return this.productService.createProduct(req.user, product);
  }

  @UseGuards(JwtGuard)
  @Get()
  findSelected(
    @Query("take") take: number = 1,
    @Query("skip") skip: number = 1
  ): Observable&lt;Product[]&gt; {
    take = take &gt; 20 ? 20 : take;
    return this.productService.findProducts(take, skip);
  }
}
</pre>
<p>åœ¨<code>product.service.ts</code>æ–‡ä»¶ä¸­ï¼Œå®šä¹‰<code>findProduct</code>æ–¹æ³•ï¼›<code>findSelected</code>è·¯çº¿è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p>
<pre class="language-typescript hljs">import { Inject, Injectable } from "@nestjs/common";
import { InjectRepository } from "@nestjs/typeorm";
import { from, Observable } from "rxjs";
import  Repository} from "typeorm";

import { User } from "src/auth/models/user.class";
import { ProductEntity } from "../models/product.entity";
import { Product } from "../models/product.interface";

@Injectable()
export class ProductService {
  constructor(
    @InjectRepository(ProductEntity)
    private readonly productRepository: Repository&lt;ProductEntity&gt;
  ) {}

  createProduct(user: User, product: Product): Observable&lt;Product&gt; {
    product.creator = user;
    return from(this.productRepository.save(product));
  }

  findProducts(take: number = 10, skip: number = 0): Observable&lt;Product[]&gt; {
    return from(
      this.productRepository
        .createQueryBuilder("product")
        .innerJoinAndSelect("product.creator", "creator")
        .orderBy("product.createdAt", "DESC")
        .take(take)
        .skip(skip)
        .getMany()
    );
  }
} 
</pre>
<p>åœ¨ç»ˆç«¯çª—å£ä¸­ï¼Œè¿è¡Œ<code>product.controller.spec</code>æµ‹è¯•ã€‚</p>
<pre class="language-bash hljs">$ yarn test product.controller</pre>
<p>æˆ‘ä»¬çš„æµ‹è¯•æˆåŠŸé€šè¿‡ã€‚</p>
<p><img data-attachment-id="138609" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/sucess/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png" data-orig-size="730,229" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="sucess" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess-300x94.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png" decoding="async" class="aligncenter wp-image-138609 size-full jetpack-lazy-image" src="../Images/445f4ff39d25ec0ce66f91ca6ddd84c4.png" alt="Successfully passing" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/sucess-300x94.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138609" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/sucess/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png" data-orig-size="730,229" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="sucess" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess-300x94.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png" decoding="async" loading="lazy" class="aligncenter wp-image-138609 size-full" src="../Images/445f4ff39d25ec0ce66f91ca6ddd84c4.png" alt="Successfully passing" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/sucess-300x94.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/sucess.png"/></noscript>
<h3 id="retrieving-product-nest-js-application">ä½¿ç”¨NestJSåº”ç”¨ç¨‹åºæ£€ç´¢äº§å“</h3>
<p>ä»¤ç‰Œåœ¨æ”¶åˆ°æˆåŠŸç™»å½•åå¯¹è·¯ç”±è¿›è¡Œèº«ä»½éªŒè¯ã€‚è¿™æ¡è·¯çº¿å¯ä»¥æ£€ç´¢å·²åˆ›å»ºäº§å“çš„åˆ—è¡¨ã€‚</p>
<p><img data-attachment-id="138614" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/the-route/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png" data-orig-size="730,497" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="the-route" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route-300x204.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png" decoding="async" class="aligncenter wp-image-138614 size-full jetpack-lazy-image" src="../Images/7ad688e74f01d23e02ee146a0a5a6d80.png" alt="the route" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/the-route-300x204.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138614" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/the-route/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png" data-orig-size="730,497" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="the-route" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route-300x204.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png" decoding="async" loading="lazy" class="aligncenter wp-image-138614 size-full" src="../Images/7ad688e74f01d23e02ee146a0a5a6d80.png" alt="the route" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/the-route-300x204.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/the-route.png"/></noscript>
<h2 id="what-end-to-end-tests">ä»€ä¹ˆæ˜¯ç«¯åˆ°ç«¯æµ‹è¯•ï¼Ÿ</h2>
<p>ç«¯åˆ°ç«¯æµ‹è¯•å¥—ä»¶ä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿæµ‹è¯•è½¯ä»¶äº§å“ã€‚è¯¥æµ‹è¯•çš„æœ€ç»ˆç›®æ ‡æ˜¯ç¡®ä¿åº”ç”¨ç¨‹åºçš„è¡Œä¸ºç¬¦åˆé¢„æœŸã€‚</p>
<p>æ¨¡æ‹Ÿç”¨æˆ·å¦‚ä½•åœ¨ç«¯åˆ°ç«¯æµ‹è¯•å¥—ä»¶ä¸­ä¸åº”ç”¨ç¨‹åºäº¤äº’æ˜¯å…³é”®ã€‚è¯¥æ¨¡æ‹Ÿä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿç¡®è®¤ç³»ç»Ÿåœ¨æµ‹è¯•ä¸­æ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚æˆ‘ä»¬å°†ä¸ºè®¤è¯æ§åˆ¶å™¨å»ºç«‹ä¸€ä¸ªç«¯åˆ°ç«¯çš„æµ‹è¯•å¥—ä»¶ã€‚</p>
<h2 id="end-to-end-tests-nest-js">NestJSä¸­çš„ç«¯åˆ°ç«¯æµ‹è¯•</h2>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒNestJSæä¾›E2Eæµ‹è¯•ã€‚ä¸ºäº†åˆ›å»ºåº”ç”¨ç¨‹åºçš„å®ä¾‹ï¼Œæˆ‘ä»¬ä¾èµ–Supertestã€‚<a href="https://www.npmjs.com/package/supertest"> Supertest </a>æ”¯æŒåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­æ£€æµ‹ç«¯ç‚¹å¹¶åˆ›å»ºè¯·æ±‚ã€‚</p>
<p>åˆ›å»ºE2Eæµ‹è¯•æ—¶ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä¾›æ¢ç´¢:</p>
<ol>
<li>æ¨¡æ‹Ÿæ‰€æœ‰æµ‹è¯•æ¨¡å—ï¼Œç„¶åè°ƒç”¨æ§åˆ¶å™¨å’ŒæœåŠ¡</li>
<li>ç”¨æ•°æ®åº“æµ‹è¯•ç«¯ç‚¹</li>
</ol>
<p>æˆ‘ä»¬çš„æ–¹æ³•æ”¯æŒå¯¹APIç«¯ç‚¹çš„ç›´æ¥è¯·æ±‚ã€‚</p>
<h2 id="creating-end-to-end-tests-auth-controller">åœ¨èº«ä»½éªŒè¯æ§åˆ¶å™¨ä¸Šåˆ›å»ºç«¯åˆ°ç«¯æµ‹è¯•</h2>
<p>åœ¨auth controllerä¸­ï¼Œæ³¨å†Œç”¨æˆ·å’Œç™»å½•çš„E2Eæµ‹è¯•çš„å®ç°æ˜¯å…³é”®ã€‚ä¸€ä¸ªæ–‡ä»¶ä¿å­˜äº†æˆ‘ä»¬éœ€è¦çš„E2Eæµ‹è¯•ã€‚</p>
<p>åœ¨æ ¹ç›®å½•ä¸­ï¼Œæ‰¾åˆ°æµ‹è¯•æ–‡ä»¶å¤¹ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª<code>auth.e2e-spec.ts</code>æ–‡ä»¶ã€‚<code>authController</code>çš„<code>describe</code>æ–¹æ³•å’Œè®¤è¯URLå°†ä¸æˆ‘ä»¬çš„E2Eæµ‹è¯•ä¸€èµ·ä¿å­˜åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚</p>
<pre class="language-bash hljs">$ touch test/auth.e2e-spec.ts
$ code test/auth.e2e-spec.ts</pre>
<p>å°†ä¸‹é¢çš„ä»£ç å—ç²˜è´´åˆ°<code>auth.e2e-spec.ts</code>æ–‡ä»¶ä¸­:</p>
<pre class="language-typescript hljs">import { HttpStatus } from '@nestjs/common';

import * as jwt from 'jsonwebtoken';
import * as request from 'supertest';

import { User } from '../src/auth/models/user.class';

describe('AuthController (e2e)', () =&gt; {
      const authUrl = `http://localhost:3000/api/auth`;
});
</pre>
<p>æµ‹è¯•æ³¨å†ŒæœåŠ¡å’Œæ§åˆ¶å™¨ï¼Œä»¥æ£€æŸ¥æ³¨å†Œåçš„<code>user</code>å¯¹è±¡ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å—æ˜¯è¦æµ‹è¯•çš„<code>registerAccount</code>æ–¹æ³•ã€‚</p>
<pre class="language-typescript hljs"> doesUserExist(email: string): Observable&lt;boolean&gt; {
    return from(this.userRepository.findOne({ email })).pipe(
      switchMap((user: User) =&gt; {
        return of(!!user);
      })
    );
  }

registerAccount(user: User): Observable&lt;User&gt; {
    const { givenName, familyName, email, password } = user;

    return this.doesUserExist(email).pipe(
      tap((doesUserExist: boolean) =&gt; {
        if (doesUserExist)
          throw new HttpException(
            "A user has already been created with this email address",
            HttpStatus.BAD_REQUEST
          );
      }),
      switchMap(() =&gt; {
        return this.hashPassword(password).pipe(
          switchMap((hashedPassword: string) =&gt; {
            return from(
              this.userRepository.save({
                givenName,
                familyName,
                email,
                password: hashedPassword,
              })
            ).pipe(
              map((user: User) =&gt; {
                delete user.password;
                return user;
              })
            );
          })
        );
      })
    );
  }
</pre>
<p>ä¸Šé¢çš„ä»£ç ç‰‡æ®µæä¾›äº†æ³¨å†Œç”¨æˆ·æ‰€éœ€å˜é‡çš„ä¿¡æ¯ã€‚è¿”å›çš„ç”¨æˆ·å¯¹è±¡è¡¨ç¤ºåœ¨å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¸­æ”¶åˆ°çš„å“åº”ã€‚</p>
<p>åœ¨<code>describe</code>å—ä¸­ï¼Œæœ‰ä¸€ä¸ªåµŒå¥—çš„<code>describe</code>å—ï¼Œç”¨äºå®šä½<code>'/auth/register/'</code>ç«¯ç‚¹ã€‚åœ¨<code>it</code>å—ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶ä½œä¸ºå“åº”çš„ä¸€éƒ¨åˆ†è¿”å›mockUserå¯¹è±¡ã€‚<code>expect</code>å˜é‡æ˜¯æ£€æŸ¥å“åº”æœ‰æ•ˆæ€§çš„å…³é”®ã€‚</p>
<pre class="language-typescript hljs">import { HttpStatus } from "@nestjs/common";

import * as jwt from "jsonwebtoken";
import * as request from "supertest";

import { User } from "../src/auth/models/user.class";

describe("AuthController (e2e)", () =&gt; {
  const authUrl = `http://localhost:6000/auth`;

  const mockUser: User = {
    givenName: "givenName",
    familyName: "familyName",
    email: "<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e3868e828a8fa38b8c8e97828a8fcd808c8e">[emailÂ protected]</a>",
    password: "password",
  };

  describe("/auth/register (POST)", () =&gt; {
    it("it should register a user and return the new user object", () =&gt; {
      return request(authUrl)
        .post("/register")
        .set("Accept", "application/json")
        .send(mockUser)
        .expect((response: request.Response) =&gt; {
          const {
            id,
            givenName,
            familyName,
            password,
            email,
            imagePath,
            role,
          } = response.body;

          expect(typeof id).toBe("number"),
            expect(givenName).toEqual(mockUser.givenName),
            expect(familyName).toEqual(mockUser.familyName),
            expect(email).toEqual(mockUser.email),
            expect(password).toBeUndefined();
          expect(imagePath).toBeNull();
          expect(role).toEqual("user");
        })
        .expect(HttpStatus.CREATED);
    });
  });
});
</pre>
<p>è¿è¡Œæµ‹è¯•:</p>
<pre class="language-bash hljs">$ yarn run test:e2e</pre>
<p>ç«¯ç‚¹ä¸Šçš„æµ‹è¯•ç»“æœå¦‚ä¸‹ã€‚</p>
<p><img data-attachment-id="138627" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/result-4/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png" data-orig-size="730,252" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="endpoint-result" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1-300x104.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png" decoding="async" class="wp-image-138627 size-full aligncenter jetpack-lazy-image" src="../Images/654d89027f5774a869898a8414d9e34e.png" alt="endpoint-result" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/result-1-300x104.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138627" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/result-4/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png" data-orig-size="730,252" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="endpoint-result" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1-300x104.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png" decoding="async" loading="lazy" class="wp-image-138627 size-full aligncenter" src="../Images/654d89027f5774a869898a8414d9e34e.png" alt="endpoint-result" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/result-1-300x104.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-1.png"/></noscript>
<h3 id="test-registration-service-ensure-new-users-registered-existing-email">æµ‹è¯•æ³¨å†ŒæœåŠ¡ï¼Œä»¥ç¡®ä¿æ–°ç”¨æˆ·æ²¡æœ‰ä½¿ç”¨ç°æœ‰çš„ç”µå­é‚®ä»¶æ³¨å†Œ</h3>
<p>åˆ›å»ºå¦ä¸€ä¸ª<code>it</code>å‡½æ•°æ¥æ£€æŸ¥æ³¨å†Œæ—¶ä½¿ç”¨ç°æœ‰ç”µå­é‚®ä»¶æ˜¯å¦ä¼šè§¦å‘é”™è¯¯è¯·æ±‚ã€‚</p>
<pre class="language-typescript hljs">it('it should not register a new user if the passed email already exists', () =&gt; {
      return request(authUrl)
        .post('/register')
        .set('Accept', 'application/json')
        .send(mockUser)
        .expect(HttpStatus.BAD_REQUEST);
    });
</pre>
<p>è¿è¡Œæµ‹è¯•:</p>
<pre class="language-bash hljs">$ yarn run test:e2e</pre>
<p>æˆ‘ä»¬çš„æµ‹è¯•è§¦å‘å¹¶è¿”å›ä»¥ä¸‹ç»“æœ:</p>
<p><img data-attachment-id="138623" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/result-test-3/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png" data-orig-size="730,344" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="result-test" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2-300x141.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png" decoding="async" class="alignnone wp-image-138623 size-full jetpack-lazy-image" src="../Images/96efedf9f5cc8d5e3ecef6c7a13f871f.png" alt="Result of running the test" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2-300x141.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="138623" data-permalink="https://blog.logrocket.com/end-end-testing-nestjs-typeorm/attachment/result-test-3/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png" data-orig-size="730,344" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="result-test" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2-300x141.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png" decoding="async" loading="lazy" class="alignnone wp-image-138623 size-full" src="../Images/96efedf9f5cc8d5e3ecef6c7a13f871f.png" alt="Result of running the test" srcset="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2-300x141.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/result-test-2.png"/></noscript>
<h2>ç»“è®º</h2>
<p>å®ç°çš„æµ‹è¯•æ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”ä¸€ä¸ªæ–°çš„è´¨é‡ä¿è¯å±‚æ˜¯å¯ç”¨çš„ã€‚åœ¨NestJSä¸­éœ€è¦æ³¨æ„çš„ä¸€ä¸ªå…³é”®ç‚¹æ˜¯å°†ä¾èµ–é¡¹ä½œä¸ºç›¸å¯¹è·¯å¾„å¯¼å…¥ã€‚æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿæˆä¸ºåœ¨æ‚¨çš„åº”ç”¨ç¨‹åºä¸­åˆ›å»ºå¤§é‡E2Eæµ‹è¯•çš„å¯é æŒ‡å—ã€‚</p><div class="code-block code-block-21">
<div class="blog-plug inline-plug typescript-plug"><h2><a class="signup" href="https://lp.logrocket.com/blg/typescript-signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>:å…¨é¢äº†è§£æ‚¨çš„ç½‘ç»œå’Œç§»åŠ¨åº”ç”¨</h2>
<a href="https://lp.logrocket.com/blg/typescript-signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p>LogRocket æ˜¯ä¸€ä¸ªå‰ç«¯åº”ç”¨ç¨‹åºç›‘æ§è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥è®©æ‚¨å›æ”¾é—®é¢˜ï¼Œå°±åƒé—®é¢˜å‘ç”Ÿåœ¨æ‚¨è‡ªå·±çš„æµè§ˆå™¨ä¸­ä¸€æ ·ã€‚LogRocketä¸éœ€è¦çŒœæµ‹é”™è¯¯å‘ç”Ÿçš„åŸå› ï¼Œä¹Ÿä¸éœ€è¦å‘ç”¨æˆ·è¯¢é—®æˆªå›¾å’Œæ—¥å¿—è½¬å‚¨ï¼Œè€Œæ˜¯è®©æ‚¨é‡æ”¾ä¼šè¯ä»¥å¿«é€Ÿäº†è§£å“ªé‡Œå‡ºé”™äº†ã€‚å®ƒå¯ä»¥ä¸ä»»ä½•åº”ç”¨ç¨‹åºå®Œç¾é…åˆï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆæ¡†æ¶ï¼Œå¹¶ä¸”æœ‰æ’ä»¶å¯ä»¥è®°å½•æ¥è‡ªReduxã€Vuexå’Œ@ngrx/storeçš„é¢å¤–ä¸Šä¸‹æ–‡ã€‚</p>
<p>é™¤äº†è®°å½•Reduxæ“ä½œå’ŒçŠ¶æ€ï¼ŒLogRocketè¿˜è®°å½•æ§åˆ¶å°æ—¥å¿—ã€JavaScripté”™è¯¯ã€å †æ ˆè·Ÿè¸ªã€å¸¦æœ‰å¤´+æ­£æ–‡çš„ç½‘ç»œè¯·æ±‚/å“åº”ã€æµè§ˆå™¨å…ƒæ•°æ®å’Œè‡ªå®šä¹‰æ—¥å¿—ã€‚å®ƒè¿˜ä½¿ç”¨DOMæ¥è®°å½•é¡µé¢ä¸Šçš„HTMLå’ŒCSSï¼Œç”šè‡³ä¸ºæœ€å¤æ‚çš„å•é¡µé¢å’Œç§»åŠ¨åº”ç”¨ç¨‹åºé‡æ–°åˆ›å»ºåƒç´ çº§å®Œç¾è§†é¢‘ã€‚</p>
<a class="signup" href="https://lp.logrocket.com/blg/typescript-signup" target="_blank" rel="noopener noreferrer">Try it for free</a><p>.</p></div>
</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>