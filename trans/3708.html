<html>
<head>
<title>Using Docker containers to beat flaky tests </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>ä½¿ç”¨Dockerå®¹å™¨å‡»è´¥ç‰‡çŠ¶æµ‹è¯•</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.logrocket.com/using-docker-containers-beat-flaky-tests/#0001-01-01">https://blog.logrocket.com/using-docker-containers-beat-flaky-tests/#0001-01-01</a></blockquote><div><article class="article-post">
<p>å³ä½¿æ–¹æ³•å‚æ•°å’Œæºä»£ç (æ–­è¨€æ˜¯é’ˆå¯¹å®ƒä»¬ç¼–å†™çš„)æ²¡æœ‰æ”¹å˜ï¼Œæ˜“å˜çš„æµ‹è¯•åœ¨ä¸åŒçš„è¿è¡Œä¸­ä¹Ÿä¼šäº§ç”Ÿä¸åŒçš„ç»“æœã€‚å‰¥è½å¯èƒ½æ˜¯ç”±å¤šç§å› ç´ é€ æˆçš„ï¼ŒåŒ…æ‹¬éšæœºæ€§ã€ç«äº‰æ¡ä»¶æˆ–å¤–éƒ¨æœåŠ¡ç­‰ä¾èµ–æ€§ã€‚</p>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æµ‹è¯•ä¸€ä¸ªç”±<a href="https://blog.logrocket.com/organizing-express-js-project-structure-better-productivity/"> Express.js </a>é©±åŠ¨çš„<a href="https://blog.logrocket.com/tag/node/"> Node.jsåº”ç”¨ç¨‹åº</a>ï¼Œå®ƒèƒ½å¤Ÿå­˜å‚¨å’Œè¯»å–å·¥ä½œåˆ—è¡¨ã€‚æˆ‘ä»¬å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨Dockerå®¹å™¨æ¥å‡»è´¥è„†å¼±çš„æµ‹è¯•ã€‚ä¸ºäº†ç®€æ´èµ·è§ï¼Œæˆ‘ä»¬å°†åªè®¨è®ºä¸»é¢˜èŒƒå›´å†…çš„ç›¸å…³ä»£ç ã€‚ä»£ç å¯ä»¥åœ¨<a href="https://github.com/creatrixity/simple-job-board"> GitHubåº“</a>ä¸­æ‰¾åˆ°ã€‚</p>
<p><em>å‘å‰è·³è½¬:</em></p>

<h2 id="avoid-flaky-tests">ä¸ºä»€ä¹ˆè¦é¿å…å¤æ€ªçš„æµ‹è¯•ï¼Ÿ</h2>
<p>é¿å…ä¸å¯é çš„æµ‹è¯•æ˜¯è‡³å…³é‡è¦çš„ï¼Œå› ä¸ºä¸å¯é çš„æµ‹è¯•ä¼šæŸå®³è½¯ä»¶çš„å®Œæ•´æ€§ã€‚ç‰‡çŠ¶æµ‹è¯•è¿˜ä¼šé™ä½å¼€å‘é€Ÿåº¦ï¼Œå› ä¸ºåœ¨è¿è¡Œç¼“æ…¢çš„CIç¯å¢ƒä¸­ä¼šå‘ç”Ÿå¤šæ¬¡å¤±è´¥ã€‚</p>
<p>å½“ç‰¹å®šçš„æ–­è¨€åœ¨è¢«æä¾›ç‰¹å®šçš„å‚æ•°æ—¶è¿”å›ç‰¹å®šçš„ç»“æœæ—¶ï¼Œæµ‹è¯•å°±æ˜¯ç¡®å®šçš„ã€‚å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„çº¯å‡½æ•°æ˜¯ç”¨ä¸ç¡®å®šæ€§æµ‹è¯•ç›¸åŒçš„è§„åˆ™ç¼–å†™çš„ã€‚è½¯ä»¶æ¨¡å—ä¸å…¶ä»–æ¨¡å—äº¤äº’ï¼Œå¹¶åœ¨åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸå†…å…±äº«çŠ¶æ€ã€‚å†™å¾—ä¸å¥½çš„æµ‹è¯•æœ‰æ—¶ä¼šé€šè¿‡äº¤å‰æ±¡æŸ“å¼•å…¥çŠ¶æ€ä¸ä¸€è‡´ï¼Œå³å‰ä¸€æ¬¡æµ‹è¯•è¿è¡Œçš„çŠ¶æ€ä¼šå½±å“æ­£åœ¨è¿è¡Œçš„æµ‹è¯•ã€‚ç”±äºæµ‹è¯•å˜å¾—ä¸ç¡®å®šï¼Œè¿™å¯èƒ½å¯¼è‡´æµ‹è¯•å‰¥è½ã€‚</p>
<p>æ˜“å˜è¡Œä¸ºçš„å…¶ä»–åŸå› åŒ…æ‹¬<code>async</code>è¡Œä¸ºã€å¹¶å‘é—®é¢˜å’Œç½‘ç»œäº¤äº’(æ˜“å˜ç³»ç»Ÿ)ã€‚ä¸ºäº†å‡è½»è¿™äº›åœºæ™¯çš„é£é™©ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿æµ‹è¯•è¢«é€‚å½“åœ°éš”ç¦»ï¼Œå¹¶ä¸”å…±äº«çš„èµ„æºä½¿ç”¨è¢«æœ€å°åŒ–ã€‚</p>
<h2 id="use-docker-containers-testing">æµ‹è¯•æ—¶ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Dockerå®¹å™¨ï¼Ÿ</h2>
<p>Dockerå®¹å™¨å¸®åŠ©æˆ‘ä»¬ä¿æŒæµ‹è¯•ç¯å¢ƒçš„ç¡®å®šæ€§ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Dockerå®¹å™¨å°†åº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¶ç¯å¢ƒä¸å…¶ä¸»æœºæ“ä½œç³»ç»Ÿéš”ç¦»å¼€æ¥ã€‚è¿™å…è®¸æˆ‘ä»¬éš”ç¦»æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€ç³»ç»Ÿè°ƒç”¨å’Œèµ„æºä½¿ç”¨ã€‚</p>
<p>å®¹å™¨æ˜¯è½»é‡çº§çš„è¿›ç¨‹ï¼Œæˆæœ¬ä½å»‰ï¼Œæ˜“äºåˆ›å»ºå’Œæ‹†å¸ã€‚è¿™äº›å“è´¨ä½¿å®ƒä»¬æˆä¸º<a href="https://blog.logrocket.com/comparing-best-node-js-unit-testing-frameworks/">éš”ç¦»æµ‹è¯•</a>çš„ç†æƒ³é€‰æ‹©ã€‚ä½¿ç”¨åƒ<a href="https://docs.docker.com/compose/install/"> Docker Compose </a>è¿™æ ·çš„å®¹å™¨ç¼–æ’å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªæ¸…å•ä¸­å®šä¹‰ä¾èµ–æœåŠ¡ï¼Œè¿™ä½¿å¾—å®ƒéå¸¸é€‚åˆä¸ºå¤–éƒ¨æœåŠ¡æ—‹è½¬æ¨¡æ‹Ÿå®¹å™¨ã€‚</p>
<p>æœ¬æ–‡çš„ä¸‹ä¸€éƒ¨åˆ†å°†æ¼”ç¤ºç”¨<a href="https://blog.logrocket.com/tag/docker/"> Docker </a>ã€<a href="https://blog.logrocket.com/node-js-docker-improve-dx-docker-compose/"> Docker Compose </a>ã€<a href="https://knexjs.org/"> Knex.js </a>å’Œ<a href="https://blog.logrocket.com/tag/postgresql/"> PostgreSQL </a>è¿›è¡Œæµ‹è¯•ã€‚</p>
<h2 id="testing-node-js-application">æµ‹è¯•Node.jsåº”ç”¨ç¨‹åº</h2>
<p>ä¿è¯ç”Ÿäº§ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„è¡Œä¸ºéå¸¸é‡è¦ã€‚ä¸ºäº†å¢åŠ æˆ‘ä»¬çš„ä¿¡å¿ƒæ°´å¹³ï¼Œæˆ‘ä»¬è¿è¡Œæ‰‹åŠ¨å’Œ<a href="https://blog.logrocket.com/how-automate-api-tests-postman/">è‡ªåŠ¨æµ‹è¯•</a>ã€‚ä¸ºäº†åœ¨æˆ‘ä»¬çš„æµ‹è¯•å¥—ä»¶ä¸­è·å¾—ä¿¡å¿ƒï¼Œæˆ‘ä»¬éœ€è¦æµ‹è¯•è¾“å‡ºæ˜¯å¯é¢„æµ‹çš„å’Œç¡®å®šçš„ã€‚</p>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æµ‹è¯•ä¸€ä¸ªåŸºäºExpress.sçš„Node.jsåº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬å°†ä½¿ç”¨<code>Postgres</code>æ¥å®ç°æŒä¹…æ€§ï¼Œä½†æ˜¯æˆ‘ä»¬å°†ä½¿ç”¨<code>knex</code>æ¥ç®¡ç†è¿ç§»ã€ç§å­å’Œæ„å»ºæŸ¥è¯¢å¯¹è±¡ã€‚</p>
<h3 id="setup-installation">è®¾ç½®å’Œå®‰è£…</h3>
<p>é¦–å…ˆï¼Œå…‹éš†<code>simple-job-board</code> repoå¹¶å®‰è£…å¿…è¦çš„ä¾èµ–é¡¹:</p>
<pre class="language-bash hljs">git clone https://github.com/creatrixity/simple-job-board
cd simple-job-board
cp .env.example .env
npm install</pre>
<p>ç”±äºåº”ç”¨ç¨‹åºå°†<code>PostgreSQL</code>ä½œä¸ºæœåŠ¡ä¾èµ–é¡¹ï¼Œæˆ‘ä»¬å°†ä¸º<code>PostgreSQL</code>è¿è¡Œä¸€ä¸ª<a href="https://blog.logrocket.com/docker-for-front-end-developers/"> Dockerå®¹å™¨</a>:</p>
<pre class="language-bash hljs"># We need to create an isolated bridge network to allow us connect to our instances
docker create network simple-job-board --driver bridge
docker pull postgres
docker run --name simple-job-board-postgres -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=5uperIn5ecurePa55word -e POSTGRES_DB=simple-job-board -p 5432:5432 -d postgres
</pre>
<p>åœ¨ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œæˆ‘ä»¬ä¸ºåº”ç”¨ç¨‹åºå®šä¹‰äº†ä¸€ä¸ª<a href="https://docs.docker.com/network/bridge/">éš”ç¦»ç½‘æ¡¥ç½‘ç»œ</a>ã€‚æˆ‘ä»¬è¿˜æå–äº†å®˜æ–¹çš„<code>postgres</code>æ˜ åƒï¼Œå¹¶åœ¨å®¹å™¨åˆå§‹åŒ–æ—¶ä¼ é€’äº†ä¸€äº›é…ç½®é€‰é¡¹ã€‚</p>
<p>åœ¨PostgreSQLå®¹å™¨è¿è¡Œå¹¶ç›‘å¬è¿æ¥çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å°è¯•è¿æ¥åˆ°æ­£åœ¨è¿è¡Œçš„å®ä¾‹ã€‚å®‰è£…äº†<code>psql</code> CLIåï¼Œæ‰§è¡Œ:</p>
<pre class="language-bash hljs">psql -h 127.0.0.1 -p 5432 -U postgres -d simple-job-board</pre>
<p>æˆ‘ä»¬åº”è¯¥ä¼šçœ‹åˆ°ä¸‹é¢çš„æç¤ºï¼Œè¡¨ç¤ºè¿æ¥æˆåŠŸ:</p>
<pre class="language-bash hljs"># psql (13.3, server 15.0 (Debian 15.0-1.pgdg110+1))
# WARNING: psql major version 13, server major version 15.
#         Some psql features might not work.
# Type "help" for help.

# simple-job-board=# 
</pre>
<h3 id="defining-application-testing-config">å®šä¹‰<code>application</code>å’Œ<code>testing</code>é…ç½®</h3>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code>dotenv</code>æ¥è·å–ç¯å¢ƒå˜é‡ã€‚æˆ‘ä»¬è¿˜å°†è®¾ç½®ä¸€ä¸ªå°çš„<code>getEnvVariable</code>åŠ©æ‰‹æ¥ä¸ºç¯å¢ƒå˜é‡æä¾›åå¤‡ã€‚ç„¶åæˆ‘ä»¬ä¸º<code>server port</code>å’Œæ•°æ®åº“ä¸»æœºå®šä¹‰é”®ï¼Œç”¨<code>localhost</code>ä½œä¸º<code>fallback</code>ã€‚<code>config</code>æ–‡ä»¶åœ¨<code>src/config.ts</code>å¯ç”¨:</p>
<pre class="language-typescript hljs">import dotenv from "dotenv";
dotenv.config();

function getEnvVariable(name: string, fallback: string = ""): string {
  const envVariable = process.env[name];
  const fallbackProvided = fallback.length;
  if (!envVariable &amp;&amp; !fallbackProvided) {
    throw new Error(`Environment variable ${name} has not been set.`);
  }
  return envVariable || fallback;
}

const config = {
  server: {
    port: Number(getEnvVariable("PORT")),
  },
  database: {
    host: getEnvVariable("DATABASE_HOST", "localhost"),
  },
};

export default config;
</pre>
<p>ç„¶åï¼Œåœ¨<code>./knexfile.ts</code>ä¸­ï¼Œå®šä¹‰<code>development</code>å’Œ<code>testing</code>ç¯å¢ƒçš„é…ç½®ã€‚å®šä¹‰è¿™ä¸¤ç§ç¯å¢ƒæ˜¯ç›¸ä¼¼çš„ï¼Œé™¤äº†åœ¨<code>testing</code>ä¸­å®šä¹‰<code>host</code>å‚æ•°:</p>
<pre class="language-typescript hljs">import type { Knex } from "knex";
import appConfig from "./src/config";

// Update with your config settings.

const config: { [key: string]: Knex.Config } = {
  development: {
    client: "postgresql",
    connection: {
      user: "postgres",
      password: "5uperIn5ecurePa55word",
      port: 5432,
    },
    pool: {
      min: 2,
      max: 10,
    },
    migrations: {
      tableName: "knex_migrations",
    },
  },

  testing: {
    client: "postgresql",
    connection: {
      user: "postgres",
      password: "5uperIn5ecurePa55word",
      host: appConfig.database.host,
      port: 5432,
    },
    pool: {
      min: 2,
      max: 10,
    },
    migrations: {
      tableName: "knex_migrations",
    },
  },
};

module.exports = config;
</pre>
<h3 id="bootstrapping-node-js-application">å¼•å¯¼Node.jsåº”ç”¨ç¨‹åº</h3>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨<code>src/index.ts</code>ä¸­å¼•å¯¼æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚ä¸ºäº†ä¿æŒNode.jsåº”ç”¨ç¨‹åºå¼•å¯¼ä»£ç çš„å¯é‡ç”¨æ€§ï¼Œæˆ‘ä»¬å°†åœ¨åä¸º<code>createServer</code>çš„å·¥å‚å‡½æ•°ä¸­åˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åºå®ä¾‹ã€‚</p>
<p><code>createServer</code>å·¥å‚å°†æ¥å—ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± æ–‡ä»¶æè¿°ç¬¦çš„å¼•ç”¨å’Œä¸€ä¸ªå¯é€‰çš„<code>port</code>å·ï¼Œä»¥åœ¨å…¶ä¸­å…¬å¼€åº”ç”¨ç¨‹åºã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œ<code>knex</code>æä¾›äº†æ•°æ®åº“è¿æ¥çš„æŠ½è±¡:</p>
<pre class="language-typescript hljs">// src/index.ts
import knex from "knex";
import config from "./config";
import { createServer } from "./createServer";
const knexConfig = require("../knexfile");
const knexSetup = knex(knexConfig.development);

createServer(knexSetup, config.server.port);
</pre>
<p>åœ¨æ£€æŸ¥äº†å¯¼å‡º<code>createServer</code>å·¥å‚çš„<code>src/createServer.ts</code>æ–‡ä»¶åï¼Œæˆ‘ä»¬å°†å¤åˆ¶ä¸€ä»½æ•°æ®åº“è¿æ¥å¼•ç”¨ã€‚é€šè¿‡å­˜å‚¨åœ¨<code>app.locals</code>å†…ï¼Œå…¶ä»–<a href="https://blog.logrocket.com/nestjs-vs-express-js/">å¿«é€Ÿæ¨¡å—</a>ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿæœ‰æ¡ä»¶åœ°ç›‘å¬æä¾›çš„<code>port</code>å·ã€‚æˆ‘ä»¬æ‰“ç®—åœ¨æˆ‘ä»¬çš„æµ‹è¯•è®¾ç½®ä¸­é‡ç”¨<code>createServer</code>å·¥å‚ï¼Œå¦‚æœæ²¡æœ‰æä¾›å·¥å‚ï¼Œ<code>superagent</code>å°†æŠŠåº”ç”¨ç¨‹åºç»‘å®šåˆ°ä¸€ä¸ªéšæœºçš„<code>port</code>:</p>
<pre class="language-typescript hljs">// src/createServer.ts
export function createServer(dbConnection: Knex, port?: number): Express {
  const app: Express = express();
  app.use(bodyParser.json());

  // Cache a copy of the dbConnection socket
  app.locals.dbConnection = dbConnection;

  app.use("/jobs", jobsRouter);
  app.get("/", (_req: Request, res: Response) =&gt; {
    res.json({ message: "Hello ğŸ‘‹ ! Welcome to the simple job board app" });
  });

  if (port) {
    app.listen(port, () =&gt; {
      console.log(`â˜ï¸ Server is running at https://localhost:${port}`);
    });
  }

  return app;
}
</pre>
<h3 id="writing-integration-tests">ç¼–å†™é›†æˆæµ‹è¯•</h3>
<p>æˆ‘ä»¬å°†ä¸º<code>job</code>æ¨¡å—æ·»åŠ å‡ ä¸ª<a href="https://blog.logrocket.com/unit-and-integration-testing-for-node-js-apps/">é›†æˆæµ‹è¯•</a>ã€‚åœ¨æ¯ä¸ªæµ‹è¯•å¥—ä»¶è¿è¡Œä¹‹å‰ï¼Œæˆ‘ä»¬å°†:</p>
<ul>
<li>ä¸ºçŸ­æš‚æµ‹è¯•æ„é€ ä¸€ä¸ªéšæœºçš„å”¯ä¸€åç§°<code>database</code></li>
<li>è·å¾—ä¸€ä¸ª<code>Postgres</code>è¿æ¥</li>
<li>ç”¨ç”Ÿæˆçš„éšæœºæƒŸä¸€åç§°åˆ›å»ºä¸€ä¸ªä¸´æ—¶æµ‹è¯•<code>database</code></li>
<li>è·å–ä¸€ä¸ªå¼•ç”¨<code>database</code>çš„æ–°<code>Postgres</code>è¿æ¥</li>
<li>è¿ç§»å¹¶æ’­ç§æ–°åˆ›å»ºçš„<code>database</code></li>
<li>è°ƒç”¨<code>createServer</code>æ¥å¸®åŠ©åˆ›å»ºExpressåº”ç”¨ç¨‹åºçš„æ–°å®ä¾‹ï¼Œå¹¶å°†æ–°å®ä¾‹åˆ†é…ç»™é¡¶çº§<code>app</code>å˜é‡:</li>
</ul>
<pre class="language-typescript hljs">  // src/modules/job/job.test.ts
  // -------------------------------------------------------------------------
  // Setup up
  // -------------------------------------------------------------------------
  let app: Express;
  let knexSetup: Knex;
  let databaseName: string;

  beforeAll(async () =&gt; {
    databaseName = uniqueNamesGenerator({
      dictionaries: [colors, adjectives, animals],
    });
    knexSetup = knex(knexConfig.testing);
    await knexSetup.raw(`CREATE DATABASE ${databaseName}`);
    knexSetup = knex({
      ...knexConfig.testing,
      database: databaseName,
    });
    await knexSetup.migrate.latest();
    await knexSetup.seed.run();
    app = createServer(knexSetup);
  });
</pre>
<p>åœ¨æ¯ä¸ªæµ‹è¯•å¥—ä»¶è¿è¡Œä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡ä¸¢å¼ƒçŸ­æš‚çš„<code>database</code>å¹¶å…³é—­åˆ°<code>database</code>çš„è¿æ¥æ¥è¿›è¡Œæ¸…ç†ï¼Œä»¥é¿å…æ± é¥¥é¥¿ï¼Œå¹¶å°†èµ„æºåˆ©ç”¨ç‡ä¿æŒåœ¨æœ€ä½³æ°´å¹³:</p>
<pre class="language-typescript hljs">  // src/modules/job/job.test.ts
  // -------------------------------------------------------------------------
  // Tear Down
  // -------------------------------------------------------------------------
  afterAll(async () =&gt; {
    await knexSetup.raw(`DROP DATABASE ${databaseName}`);
    await knexSetup.destroy();
  });
</pre>
<p>å¯¹äº<code>test</code>çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯¹æŸ¥è¯¢åœ¨å‰é¢æ­¥éª¤ä¸­æ¤å…¥åˆ°<code>database</code>ä¸­çš„<code>jobs</code>åˆ—è¡¨è¿”å›çš„æ•°æ®è¿è¡Œæ–­è¨€ã€‚æˆ‘ä»¬é€šè¿‡<code>superagent</code>å‘å‡º<code>POST</code>è¯·æ±‚æ¥åˆ›å»ºæ–°çš„å·¥ä½œè®°å½•ã€‚æˆ‘ä»¬è¿˜æ–­è¨€æˆ‘ä»¬çš„æ–°ä½œä¸šè®°å½•ï¼Œè¯¥è®°å½•æ˜¯åœ¨æŸ¥è¯¢åœ¨<code>database</code>ä¸­å¯ç”¨çš„<code>jobs</code>åˆ—è¡¨æ—¶è¿”å›çš„:</p>
<pre class="language-typescript hljs">// src/modules/job/job.test.ts
import { jobData } from "../../../seeds/jobs";

describe("/jobs", () =&gt; {
  // -------------------------------------------------------------------------
  // Test cases
  // -------------------------------------------------------------------------
  test("GET: / should return a success status", async () =&gt; {
    await request(app).get("/").expect("Content-Type", /json/).expect(200);
  });

  test("GET: /jobs should return a list of jobs", async () =&gt; {
    const result = await request(app).get("/jobs");
    expect(
      result.get("Content-Type").includes("application/json")
    ).toBeTruthy();
    expect(result.statusCode).toEqual(200);
    expect(result.body.results).toEqual(
      expect.arrayContaining(jobData.map((job) =&gt; expect.objectContaining(job)))
    );
  });

  test("POST: /jobs should create a new job", async () =&gt; {
    const jobCreationData = {
      role: "Virtual Reality Designer",
      location: "Seattle",
      organization: "Microsoft",
      description: "Reimagine virtual reality experiences",
    };

    const jobCreationResponse = await request(app)
      .post("/jobs")
      .send(jobCreationData)
      .set("Accept", "application/json");

    expect(jobCreationResponse.statusCode).toEqual(201);

    const jobsResponse = await request(app).get("/jobs");
    const jobs = jobsResponse.body.results;
    expect(jobs[jobs.length - 1]).toMatchObject(jobCreationData);
  });
});
</pre>
<p>è¿è¡Œ<code>npm test</code>åº”è¯¥ä¼šç»™å‡ºå¦‚ä¸‹è¾“å‡º:</p>
<pre class="language-typescript hljs">PASS  src/modules/job/job.test.ts
  /jobs
    âœ“ GET: / should return a success status (267 ms)
    âœ“ GET: /jobs should return a list of jobs (64 ms)
    âœ“ POST: /jobs should create a new job (97 ms)

Test Suites: 1 passed, 1 total
Tests:       3 passed, 3 total
Snapshots:   0 total
Time:        3.705 s, estimated 14 s
Ran all test suites.

Watch Usage: Press w to show more.
</pre>
<p>æˆ‘ä»¬å·²ç»åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­æˆåŠŸæµ‹è¯•äº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ã€‚</p>
<h2 id="running-tests-docker-containers">åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œæµ‹è¯•</h2>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä»åˆ›å»ºæˆ‘ä»¬çš„<code>Dockerfile</code>å¼€å§‹ï¼Œå…¶ä¸­åŒ…å«æ„å»ºæˆ‘ä»¬çš„<a href="https://blog.logrocket.com/node-js-docker-improve-dx-docker-compose/#dockerize-app-docker-multi-stage-build">åº”ç”¨ç¨‹åºæ˜ åƒ</a>çš„æŒ‡ä»¤:</p>
<pre class="language-dockerfile hljs">FROM node:alpine

WORKDIR /usr/app
COPY ./ /usr/app

RUN npm install

# Define the command to run the test
CMD ["npm", "test"]
</pre>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªæœåŠ¡çš„<code>docker-compose.yml</code>æ¸…å•:ä¸ºæˆ‘ä»¬çš„Expressåº”ç”¨ç¨‹åºè¿è¡Œæµ‹è¯•çš„<code>simple-job-board</code>æœåŠ¡å’Œè¿è¡Œåœ¨å®¹å™¨ä¸­çš„PostgreSQLæ•°æ®åº“<code>db</code>æœåŠ¡:</p>
<pre class="language-yaml hljs">version: "3"
services:
  simple-job-board:
    build: .
    environment:
      DATABASE_HOST: db
    links:
      - db
  db:
    image: postgres:11
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 5uperIn5ecurePa55word
      POSTGRES_DB: simple-job-board
    ports:
      - "5432:5432"
</pre>
<p>ç„¶åï¼Œæˆ‘ä»¬å°†é€šè¿‡è¿è¡Œ<code>docker-compose run test</code>æ¥å¯åŠ¨æµ‹è¯•è¿è¡Œï¼Œä»¥ç¡®ä¿æˆ‘ä»¬çš„æ•°æ®åº“æœåŠ¡åœ¨æµ‹è¯•å¼€å§‹è¿è¡Œä¹‹å‰å¯åŠ¨:</p>
<p><img data-attachment-id="146117" data-permalink="https://blog.logrocket.com/using-docker-containers-beat-flaky-tests/attachment/postgresql-running-container/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container.png" data-orig-size="730,420" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="The running PostgreSQL container" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container-300x173.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container.png" decoding="async" class="aligncenter size-full wp-image-146117 jetpack-lazy-image" src="../Images/0c9fd86d554b6815b4da4e48c654e35c.png" alt="The Running PostgreSQL Container" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container-300x173.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="146117" data-permalink="https://blog.logrocket.com/using-docker-containers-beat-flaky-tests/attachment/postgresql-running-container/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container.png" data-orig-size="730,420" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="The running PostgreSQL container" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container-300x173.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-146117" src="../Images/0c9fd86d554b6815b4da4e48c654e35c.png" alt="The Running PostgreSQL Container" srcset="https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container-300x173.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/12/postgresql-running-container.png"/></noscript>
<p>æˆ‘ä»¬çš„æµ‹è¯•ç»“æœå°†é€šè¿‡Dockerå®¹å™¨ä¸­è¿è¡Œçš„ç»¿è‰²å¤é€‰æ ‡è®°ã€‚æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œåœ¨æˆ‘ä»¬çš„æµ‹è¯•è¿è¡Œä¹‹å‰ï¼Œç­‰å¾…æ—¶é—´ç•¥æœ‰å¢åŠ ã€‚è¿™æ˜¯å› ä¸ºå½“æˆ‘ä»¬å¯åŠ¨Dockerå®¹å™¨æ—¶ä¼šäº§ç”Ÿå¼€é”€:</p>
<p><img data-attachment-id="146119" data-permalink="https://blog.logrocket.com/using-docker-containers-beat-flaky-tests/attachment/docker-container-passing-tests/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests.png" data-orig-size="730,420" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Passing tests running in a Docker container" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests-300x173.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests.png" decoding="async" class="aligncenter size-full wp-image-146119 jetpack-lazy-image" src="../Images/d81a34d3e7025de90083b5be607588a6.png" alt="Passing Tests Running in a Docker Container" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests-300x173.png 300w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="146119" data-permalink="https://blog.logrocket.com/using-docker-containers-beat-flaky-tests/attachment/docker-container-passing-tests/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests.png" data-orig-size="730,420" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Passing tests running in a Docker container" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests-300x173.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests.png" decoding="async" loading="lazy" class="aligncenter size-full wp-image-146119" src="../Images/d81a34d3e7025de90083b5be607588a6.png" alt="Passing Tests Running in a Docker Container" srcset="https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests.png 730w, https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests-300x173.png 300w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/12/docker-container-passing-tests.png"/></noscript>
<h2>ç»“è®º</h2>
<p>æœ‰äº†Dockerå®¹å™¨å’Œæµ‹è¯•éš”ç¦»ï¼Œæˆ‘ä»¬å¤§å¤§å‡å°‘äº†é‡åˆ°è„†å¼±æµ‹è¯•çš„æœºä¼šã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªæµ‹è¯•è¿è¡Œåˆ›å»ºäº†æ–°çš„è¿æ¥å’Œæ–°çš„æ•°æ®åº“ï¼Œä»¥ä¿è¯æ¯ä¸ªè¿è¡Œéƒ½æ˜¯å¹²å‡€çš„ã€‚æˆ‘ä»¬è¿˜æ¶ˆé™¤äº†ä½œä¸ºç‰‡çŠ¶å‰¥è½æ¥æºçš„å·æ±¡æŸ“ã€‚ç„¶è€Œï¼Œè¯·è®°ä½ï¼Œè¿˜æœ‰å…¶ä»–çš„å‰¥è½æ¥æºï¼Œæ¯”å¦‚<code>async</code>è¡Œä¸ºã€å¹¶å‘é—®é¢˜å’Œç½‘ç»œäº¤äº’ã€‚é‡è¦çš„æ˜¯è¦è®¤è¯†åˆ°æµ‹è¯•ç¢ç‰‡åœ¨æœ¬è´¨ä¸Šæ˜¯å¤šå˜é‡çš„ã€‚</p>
<p>è¯·éšæ„ä»æœ¬æ•™ç¨‹ä¸­å…‹éš†è¿™ä¸ªé¡¹ç›®å¹¶è¿›è¡Œæµ‹è¯•ã€‚</p><div class="code-block code-block-4">
<div class="blog-plug base-cta"><h2>ä½¿ç”¨<a class="signup" href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>æ¶ˆé™¤ä¼ ç»Ÿé”™è¯¯æŠ¥å‘Šçš„å¹²æ‰°</h2>
<a href="https://lp.logrocket.com/blg/signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p><a href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>æ˜¯ä¸€ä¸ªæ•°å­—ä½“éªŒåˆ†æè§£å†³æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥ä¿æŠ¤æ‚¨å…å—æ•°ç™¾ä¸ªå‡é˜³æ€§é”™è¯¯è­¦æŠ¥çš„å½±å“ï¼Œåªé’ˆå¯¹å‡ ä¸ªçœŸæ­£é‡è¦çš„é¡¹ç›®ã€‚LogRocketä¼šå‘Šè¯‰æ‚¨åº”ç”¨ç¨‹åºä¸­å®é™…å½±å“ç”¨æˆ·çš„æœ€å…·å½±å“åŠ›çš„bugå’ŒUXé—®é¢˜ã€‚</p>
<p>ç„¶åï¼Œä½¿ç”¨å…·æœ‰æ·±å±‚æŠ€æœ¯é¥æµ‹çš„ä¼šè¯é‡æ”¾æ¥ç¡®åˆ‡åœ°æŸ¥çœ‹ç”¨æˆ·çœ‹åˆ°äº†ä»€ä¹ˆä»¥åŠæ˜¯ä»€ä¹ˆå¯¼è‡´äº†é—®é¢˜ï¼Œå°±åƒä½ åœ¨ä»–ä»¬èº«åçœ‹ä¸€æ ·ã€‚</p>
<p>LogRocketè‡ªåŠ¨èšåˆå®¢æˆ·ç«¯é”™è¯¯ã€JSå¼‚å¸¸ã€å‰ç«¯æ€§èƒ½æŒ‡æ ‡å’Œç”¨æˆ·äº¤äº’ã€‚ç„¶åLogRocketä½¿ç”¨æœºå™¨å­¦ä¹ æ¥å‘Šè¯‰ä½ å“ªäº›é—®é¢˜æ­£åœ¨å½±å“å¤§å¤šæ•°ç”¨æˆ·ï¼Œå¹¶æä¾›ä½ éœ€è¦ä¿®å¤å®ƒçš„ä¸Šä¸‹æ–‡ã€‚</p>
<p>å…³æ³¨é‡è¦çš„bugâ€”<a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">ä»Šå¤©å°±è¯•è¯•LogRocketã€‘ã€‚</a></p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>