<html>
<head>
<title>Improve Node.js app performance with TypeDI and the strategy pattern </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>ä½¿ç”¨TypeDIå’Œç­–ç•¥æ¨¡å¼æé«˜Node.jsåº”ç”¨ç¨‹åºçš„æ€§èƒ½</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.logrocket.com/improve-node-js-app-performance-typedi-strategy-pattern/#0001-01-01">https://blog.logrocket.com/improve-node-js-app-performance-typedi-strategy-pattern/#0001-01-01</a></blockquote><div><article class="article-post">
<p>ä¿æŒåº”ç”¨ç¨‹åºçš„é«˜æ€§èƒ½å¯¹äºæœ‰æ•ˆçš„è¿è¥ç›®æ ‡è‡³å…³é‡è¦ã€‚ç¼“å­˜å’Œå†…å­˜åŒ–æœ‰åŠ©äºé¿å…å†—ä½™è®¡ç®—ï¼Œä¿æŒåº”ç”¨ç¨‹åºå¹³ç¨³è¿è¡Œã€‚ä»¥äº‘ä¸ºä¸­å¿ƒçš„æ¶æ„æ¨¡å¼å¼ºè°ƒå®¹é”™ï¼Œå¹¶å°†çŠ¶æ€å­˜å‚¨åœ¨åˆ†å¸ƒå¼ç¼“å­˜æœåŠ¡ä¸­ï¼Œå¦‚Rediså’ŒMemcachedã€‚</p>
<p>æœ¬æ•™ç¨‹å°†ç ”ç©¶å¦‚ä½•ä½¿ç”¨<a href="https://docs.typestack.community/typedi/v/develop/01-getting-started"> TypeDI </a>å’Œç­–ç•¥æ¨¡å¼æ¥æé«˜Node.jsåº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªAPIæœåŠ¡æ¥æ”¯æŒRediså’ŒMemcachedä¹‹é—´çš„åˆ‡æ¢ï¼Œå¹¶ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ¥ä¿æŒæœåŠ¡æä¾›è€…è®¾è®¡çš„çµæ´»æ€§ã€‚æˆ‘ä»¬è¿˜å°†ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œå¹¶ä¾èµ–TypeDIåŒ…æ¥æä¾›æ§åˆ¶åè½¬(IoC)å®¹å™¨ã€‚ä½ å¯ä»¥åœ¨<a href="https://github.com/creatrixity/simple-wallet"> GitHubåº“</a>ä¸­é˜…è¯»å®Œæ•´çš„ä»£ç ã€‚</p>
<p><em>å‘å‰è·³è½¬:</em></p>

<h2 id="what-strategy-pattern">ä»€ä¹ˆæ˜¯ç­–ç•¥æ¨¡å¼ï¼Ÿ</h2>
<p>ç­–ç•¥æ¨¡å¼æ˜¯ä¸€ç§<a href="https://blog.logrocket.com/understanding-design-patterns-typescript-node-js/">è½¯ä»¶è®¾è®¡æ¨¡å¼</a>ï¼Œå®ƒå°†ç›¸å…³çš„å®ç°(ç­–ç•¥)ç»„åˆåœ¨ä¸€èµ·ï¼Œå¹¶å…è®¸å…¶ä»–æ¨¡å—ä½¿ç”¨ä¸€ä¸ªåä¸º<code>Context</code>çš„ä¸­å¿ƒç±»è¿›è¡Œäº¤äº’ã€‚ä½¿ç”¨è¿™ç§æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­æ”¯æŒå¤šä¸ªæ”¯ä»˜å’Œæ¶ˆæ¯æä¾›è€…ã€‚</p>
<h2 id="dependency-injection-loose-coupling">ä¾èµ–æ³¨å…¥å’Œæ¾æ•£è€¦åˆ</h2>
<p><a href="https://blog.logrocket.com/dependency-injection-node-js-typedi/">ä¾èµ–æ³¨å…¥</a>æ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ¨¡å¼ï¼Œå®ƒä½¿ä¸€ä¸ªæ–¹æ³•èƒ½å¤Ÿæ¥æ”¶ä¸€ä¸ªä¾èµ–ä½œä¸ºå‚æ•°ã€‚ä¾èµ–æ³¨å…¥å¯¹äºé¿å…ç´§å¯†è€¦åˆçš„è½¯ä»¶è®¾è®¡æ˜¯è‡³å…³é‡è¦çš„ï¼Œå¹¶å¸®åŠ©æ‚¨åœ¨è®¾è®¡è½¯ä»¶æ—¶é¿å…ç³Ÿç³•çš„æ¶æ„å†³ç­–ã€‚</p>
<h2 id="why-use-typedi-dependency-injection-container-node-js">ä¸ºä»€ä¹ˆè¦åœ¨Node.jsä¸­ä½¿ç”¨TypeDIä½œä¸ºä¾èµ–æ³¨å…¥å®¹å™¨ï¼Ÿ</h2>
<p>æ­£ç¡®çš„IoCéœ€è¦ä¾èµ–å…³ç³»è§£æã€‚ä¾èµ–æ€§è§£æè¿‡ç¨‹å°†ä¾èµ–æ€§å»ºæ¨¡ä¸ºå…·æœ‰èŠ‚ç‚¹å’Œè¿æ¥è¾¹çš„å›¾ã€‚è·å¾—è¿™ç§æƒåˆ©ä»¥é˜²æ­¢æ— æ„ä¸­å¼•å…¥å¾ªç¯ä¾èµ–æ˜¯è‡³å…³é‡è¦çš„ã€‚</p>
<p>TypeDIæ˜¯æ­£ç¡®æ‰§è¡Œä¾èµ–å…³ç³»è§£æè¿‡ç¨‹çš„ä¼˜ç§€å·¥å…·ï¼Œå®ƒå…è®¸æˆ‘ä»¬é€šè¿‡æ„é€ å‡½æ•°å°†å€¼æ³¨å…¥åˆ°ç±»å±æ€§ä¸­ã€‚TypeDIä½¿æˆ‘ä»¬èƒ½å¤Ÿå®šä¹‰ä¸å˜çš„<a href="https://blog.logrocket.com/youre-wrong-about-singletons/">å•ä½“æœåŠ¡</a>å’Œç¬æ€æœåŠ¡ï¼Œè¿™åœ¨æ„å»ºåˆ©ç”¨è¯·æ±‚-å“åº”æ¨¡å‹çš„è½¯ä»¶æ—¶å¾ˆæœ‰å¸®åŠ©ã€‚</p>
<h2 id="creating-proof-concept-api-typedi-strategy-pattern">ä½¿ç”¨TypeDIå’Œç­–ç•¥æ¨¡å¼åˆ›å»ºæ¦‚å¿µéªŒè¯API</h2>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåŸºäºExpress.jsçš„Node.jsåº”ç”¨ç¨‹åºæ¥å­˜å‚¨å’Œè¯»å–äº¤æ˜“è®°å½•ï¼Œç±»ä¼¼äºè´¢åŠ¡åº”ç”¨ç¨‹åºä¸­çš„è®°å½•ã€‚</p>
<p>æˆ‘ä»¬å°†ä»é«˜æ€§èƒ½ç¼“å­˜ä¸­è¯»å†™äº‹åŠ¡è®°å½•ï¼Œè¿™äº›ç¼“å­˜ä½¿ç”¨æœºå™¨ä¸Šå¯ç”¨çš„RAMï¼Œè€Œä¸æ˜¯è¯»å–ç£ç›˜æ•°æ®æ—¶é€šå¸¸é‡åˆ°çš„ç¼“æ…¢ä¸”ä¸ç¡®å®šçš„é¡ºåºI/Oã€‚</p>
<p>ä¸ºäº†å…è®¸ç¯å¢ƒå˜é‡çš„è¦†ç›–ï¼Œæˆ‘ä»¬å°†é»˜è®¤ç¼“å­˜æä¾›è€…è®¾ç½®ä¸º<code>Redis</code>ï¼Œå¹¶æ”¯æŒ<code>Redis</code>å’Œ<code>Memcached</code>ä½œä¸ºæˆ‘ä»¬çš„é«˜æ€§èƒ½ç¼“å­˜ã€‚</p>
<h3 id="set-up-installation">è®¾ç½®å’Œå®‰è£…</h3>
<p>æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå…·æœ‰ä»¥ä¸‹å¤–éƒ¨ä¾èµ–æ€§:</p>

<p>æˆ‘æ›´å–œæ¬¢å°†Memcachedå’ŒRedisä½œä¸ºDockerå®¹å™¨è¿è¡Œã€‚è¦å°†å®ƒä»¬ç›´æ¥å®‰è£…åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:</p>
<pre class="language-bash hljs">mkdir simple-wallet
cd simple-wallet
npm init -y
npm i typescript concurrently @types/dotenv @types/memcached @types/express @types/node nodemon --save-dev
npm i redis memcached memcache-plus typedi express body-parser dotenv --save
</pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æˆ‘ä»¬çš„å·¥ä½œç›®å½•ä¸­å¯åŠ¨ä¸€ä¸ª<a href="https://blog.logrocket.com/tag/typescript/">ç±»å‹è„šæœ¬é¡¹ç›®</a>ã€‚å¦‚æœæ‚¨å·²ç»å…¨å±€å®‰è£…äº†TypeScriptï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤:</p>
<pre class="language-bash hljs">tsc --init
</pre>
<p>å¦‚æœæ‚¨å¸Œæœ›å°†TypeScriptä¿ç•™ä¸ºæœ¬åœ°å®‰è£…ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤:</p>
<pre class="language-bash hljs">./node_modules/.bin/tsc --init
</pre>
<p>ç„¶åï¼Œç¼–è¾‘<code>tsconfig.json</code>å¹¶å…è®¸è¯¸å¦‚è£…é¥°å™¨å’Œå‘å‡ºè£…é¥°å™¨å…ƒæ•°æ®ä¹‹ç±»çš„ç±»å‹è„šæœ¬ç‰¹æ€§:</p>
<pre class="language-json hljs">{
  "compilerOptions": {
    "outDir": "./dist",
    "baseUrl": "./",
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true,
    "skipLibCheck": true,
    "strict": true,
    "esModuleInterop": true,
    "strictPropertyInitialization": true
  }
}
</pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä¸º<code>Redis</code>å’Œ<code>Memcached</code>è®¾ç½®Dockerå®¹å™¨ã€‚æˆ‘æ›´å–œæ¬¢ä½¿ç”¨ä¸‹é¢æœ€å°çš„<code>alpine</code>å›¾ç‰‡:</p>
<pre class="language-bash hljs"># We need to create an isolated bridge network to allow us to connect to our instances 
docker create network simple-wallet-network --driver bridge
docker pull redis:alpine memcached:alpine
docker run --name simple-wallet-redis -d -p 6379:6379 redis:alpine
docker run --name simple-wallet-memcached -d -p 11211:11211 memcached:alpine
</pre>
<p><img decoding="async" class="aligncenter size-full wp-image-138197 jetpack-lazy-image" src="../Images/29e3009d803fb0cd94a8a412582dded4.png" alt="Injectable Docker Node.js Caching Example" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/cached-injectable-node-js-example.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/cached-injectable-node-js-example.png"/></p><noscript><img data-lazy-fallback="1" decoding="async" loading="lazy" class="aligncenter size-full wp-image-138197" src="../Images/29e3009d803fb0cd94a8a412582dded4.png" alt="Injectable Docker Node.js Caching Example" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/cached-injectable-node-js-example.png"/></noscript>
<p>è¿è¡Œæˆ‘ä»¬çš„<code>Redis</code>å’Œ<code>Memcached</code>å®ä¾‹ï¼Œç”¨ä¸‹é¢çš„ä»£ç è¿æ¥å®ƒä»¬:</p>
<pre class="language-bash hljs">npx redis-cli -p 6379
npx memcached-cli localhost:11211
</pre>
<p>ç„¶åï¼Œæ·»åŠ ä¸€ä¸ª<code>declarations.d.ts</code>æ–‡ä»¶æ¥å£°æ˜ç¬¬ä¸‰æ–¹åŒ…çš„ç±»å‹ï¼Œå¹¶å°†ä»¥ä¸‹å†…å®¹è¾“å…¥åˆ°<code>.env</code>:</p>
<pre>PORT=3050
CACHE_PROVIDER=redis
REDIS_PORT=6379
MEMCACHED_PORT=11211
</pre>
<h3 id="configuring-application">é…ç½®Express.jsåº”ç”¨ç¨‹åº</h3>
<p>æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª<code>config singleton</code>å¯¹è±¡æ¥å¯¼å‡ºåœ¨å…¶ä»–æ¨¡å—ä¸­ä½¿ç”¨çš„å€¼ã€‚åˆ›å»º<code>src/config.ts</code>å¹¶ç²˜è´´ä»¥ä¸‹ä»£ç :</p>
<pre class="language-typescript hljs">import dotenv from "dotenv";
dotenv.config();

function getEnvVariable(name: string, fallback: string = ""): string {
  const envVariable = process.env[name];
  const fallbackProvided = fallback.length;
  if (!envVariable &amp;&amp; !fallbackProvided) {
    throw new Error(`Environment variable ${name} has not been set.`);
  }
  return envVariable || fallback;
}

const config = {
  server: {
    port: getEnvVariable("PORT"),
  },
  cache: {
    provider: getEnvVariable("CACHE_PROVIDER", "redis"),
  },
  redis: {
    port: getEnvVariable("REDIS_PORT"),
  },
  memcached: {
    port: getEnvVariable("MEMCACHED_PORT"),
  },
};

export default config;
</pre>
<p>ç„¶åï¼Œæˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å»ºç«‹åˆ°Rediså’ŒMemcachedæœåŠ¡çš„æŒä¹…TCPè¿æ¥ï¼Œå¹¶å°†è¿™äº›è¿æ¥å…¬å¼€ç»™åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†ã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨<code>memcache-plus</code>ä½œä¸ºåŸºæœ¬<code>memcache</code>åŒ…çš„åŒ…è£…å™¨ï¼Œå› ä¸º<code>memcache-plus</code>ä¸ºæˆ‘ä»¬æä¾›äº†è¯­æ³•ç³–ï¼Œæ¯”å¦‚async/awaitï¼Œè€Œä¸æ˜¯å›è°ƒã€‚å°†è¿™äº›æ·»åŠ åˆ°<code>src/connections</code>:</p>
<pre class="language-typescript hljs">import MemcachePlus from "memcache-plus";
import { createClient } from "redis";
import { RedisClientType } from "@redis/client";

let redisClient;

// The Redis client must be created in an async closure
(async () =&gt; {
  redisClient = createClient();
  redisClient.on("error", (err) =&gt;
    console.log("ğŸ•â€ğŸ¦º[Redis] Redis Client Error: ", err)
  );
  await redisClient.connect();
  console.log("ğŸ•â€ğŸ¦º[Redis]: Successfully connected to the Redis server");
})();

const createMemcachedClient = (location: string) =&gt; {
  const handleNetworkError = function () {
    console.error(
      `ğŸ–ï¸[Memcached]: Unable to connect to server due to network error`
    );
  };
  const memcache = new MemcachePlus({
    hosts: [location],
    onNetError: handleNetworkError,
  });
  console.log("ğŸ–ï¸[Memcached]: Successfully connected to the Memcached server");
  return memcache;
};

export default {
  redis: redisClient,
  memcached: createMemcachedClient("localhost:11211"),
};
</pre>
<h3 id="boostrapping-application">å¼•å¯¼æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº</h3>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨<code>src/index.ts</code>ä¸­å¼•å¯¼æˆ‘ä»¬çš„Expressåº”ç”¨ç¨‹åºã€‚å› ä¸º<code>TypeDI</code>ä½¿ç”¨å®éªŒæ€§çš„ç±»å‹è„šæœ¬<code>Reflection</code> APIï¼Œæˆ‘ä»¬å°†é¦–å…ˆå¯¼å…¥<code>reflect-metadata</code>ã€‚ä¸ºæ­¤ï¼Œå°†ä¸‹é¢çš„ä»£ç æ·»åŠ åˆ°<code>src/index.ts</code>:</p>
<pre class="language-typescript hljs">import "reflect-metadata";
import express, { Express, Request, Response } from "express";
import config from "./config";
import transactionsRouter from "./modules/transaction/transaction.routes";
import bodyParser from "body-parser";

const app: Express = express();
const { server } = config;

app.use(bodyParser.json());
app.use("/transactions", transactionsRouter);

app.get("/", (_req: Request, res: Response) =&gt; {
  res.send("Hello! Welcome to the simple wallet app");
});

app.listen(server.port, () =&gt; {
  console.log(`â˜ï¸ Server is running at http://localhost:${server.port}`);
});
</pre>
<p>å®Œæˆå¼•å¯¼åï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®äº‹åŠ¡æ¨¡å—ã€‚åœ¨è¿™æ ·åšä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºç¼“å­˜æ„å»ºä¸€ä¸ªæŠ½è±¡ï¼Œå°†ç¼“å­˜æä¾›è€…å®šä¹‰ä¸ºåœ¨ä¸¤è€…ä¹‹é—´åˆ‡æ¢çš„ç­–ç•¥ã€‚</p>
<h3 id="building-cache-provider">æ„å»ºç¼“å­˜æä¾›ç¨‹åº</h3>
<p>è¦æ„å»ºç¼“å­˜æä¾›è€…ï¼Œå°†ç¬¬ä¸€ä¸ªç±»å®šä¹‰ä¸º<code>Context</code>ã€‚æ‚¨å¯ä»¥å°†<code>Context</code>è§†ä¸ºç¼“å­˜æä¾›è€…çš„å¤§è„‘ï¼Œå½“ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ—¶ï¼Œå®ƒè¯†åˆ«æ‰€æœ‰å¯ç”¨çš„ç­–ç•¥ï¼Œå¹¶ä¸ºæ¶ˆè´¹è€…æä¾›åœ¨å®ƒä»¬ä¹‹é—´åˆ‡æ¢çš„æ–¹æ³•ã€‚</p>
<p>æˆ‘ä»¬å°†åœ¨<code>src/providers/cache/cache.definitions.ts</code>å®šä¹‰ç¼“å­˜æä¾›è€…ä¸­ä½¿ç”¨çš„<code>Strategy</code>ç±»æ¥å£å’Œç±»å‹:</p>
<pre class="language-typescript hljs">export interface Strategy {
  get(key: string): Promise&lt;string&gt;;
  has(key: string): Promise&lt;boolean&gt;;
  set(key: string, value: string): void;
}

export type strategiesList = {
  [key: string]: Strategy;
};
</pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå¯ä¾›<code>Context</code>é€‰æ‹©çš„ç­–ç•¥åˆ—è¡¨ï¼Œæˆ‘ä»¬å°†ä¸º<code>Redis</code>å’Œ<code>Memcached</code>ç­–ç•¥åˆ›å»ºå…·ä½“çš„å®ç°ç±»ã€‚</p>
<p>ç¼–è¾‘<code>src/providers/cache/cache.context.ts</code>å¹¶æ·»åŠ :</p>
<pre class="language-typescript hljs">import { Service } from "typedi";
import connections from "../../connections";
import config from "../../config";
import { Strategy, strategiesList } from "./cache.definitions";
import RedisStrategy from "./strategies/redis.strategy";
import MemcachedStrategy from "./strategies/memcached.strategy";
import { RedisClientType } from "@redis/client";
</pre>
<p>æˆ‘ä»¬çš„ç­–ç•¥ç±»å®ç°å°†æ¥æ”¶ä¸€ä¸ªè¿æ¥å®ä¾‹ï¼Œä»¥ä½¿æˆ‘ä»¬çš„ç­–ç•¥å°½å¯èƒ½çµæ´»:</p>
<pre class="language-typescript hljs">const strategies: strategiesList = {
  redis: new RedisStrategy(connections.redis as RedisClientType),
  memcached: new MemcachedStrategy(connections.memcached),
};
</pre>
<p>åœ¨<code>CacheContext</code>ä¸­ï¼Œå°†ç¯å¢ƒä¸­é»˜è®¤çš„ç¼“å­˜æä¾›è€…å€¼æ³¨å…¥åˆ°æ„é€ å‡½æ•°ä¸­ï¼Œå¹¶æ‰§è¡Œæ–¹æ³•å§”æ‰˜æˆ–ä»£ç†ã€‚</p>
<p>å°½ç®¡æˆ‘ä»¬æ‰‹åŠ¨å§”æ‰˜ç»™æ‰€é€‰çš„ç­–ç•¥ç±»ï¼Œä½†è¿™ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨<a href="https://blog.logrocket.com/use-es6-proxies-to-enhance-your-objects/"> ES6ä»£ç†</a>æ¥åŠ¨æ€å®ç°ã€‚æˆ‘ä»¬å°†å‰©ä½™çš„<code>CacheContext</code>æ·»åŠ åˆ°ä¸‹é¢çš„å—ä¸­:</p>
<pre class="language-typescript hljs">@Service()
class CacheContext {
  private selectedStrategy: Strategy;
  private strategyKey: keyof strategiesList;

  constructor(strategyKey: keyof strategiesList = config.cache.provider) {
    this.strategyKey = strategyKey;
    this.selectedStrategy = strategies[strategyKey];
  }

  public setSelectedStrategy(strategy: keyof strategiesList) {
    this.selectedStrategy = strategies[strategy];
  }

  public async has(key: string) {
    const hasKey = await this.selectedStrategy.has(key);
    return hasKey
  }

  public async get(key: string) {
    console.log(`Request for cache key: ${key} was served by ${this.strategyKey}`);
    const value = await this.selectedStrategy.get(key);
    return value;
  }

  public async set(key: string, value: string) {
    await this.selectedStrategy.set(key, value);
  }
}

export default CacheContext;
</pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡å‘<code>src/providers/cache/strategies/redis.strategy.ts</code>æ·»åŠ ä¸‹é¢çš„ä»£ç æ¥åˆ›å»º<code>RedisStrategy</code>çš„æœ€å°å®ç°:</p>
<pre class="language-typescript hljs">import { RedisClientType } from "@redis/client";
import { Strategy } from "../cache.definitions";

class RedisStrategy implements Strategy {
  private connection;

  constructor(connection: RedisClientType) {
    this.connection = connection;
  }

  public async get(key: string): Promise&lt;string | null&gt; {
    const result = await this.connection.get(key);
    return result;
  }

  public async has(key: string): Promise&lt;boolean&gt; {
    const result = await this.connection.get(key);
    return result !== undefined &amp;&amp; result !== null;
  }

  public async set(key: string, value: string) {
    await this.connection.set(key, value);
  }
}

export default RedisStrategy;
</pre>
<p>å› ä¸º<code>MemcachedStrategy</code>ç±»ä¼¼äº<code>RedisStrategy</code>ï¼Œæˆ‘ä»¬å°†è·³è¿‡å®ƒçš„å®ç°ã€‚å¦‚éœ€æŸ¥çœ‹<code>MemcachedStrategy</code>ï¼Œå¯ç‚¹å‡»æŸ¥çœ‹å®æ–½<a href="https://github.com/creatrixity/simple-wallet">ã€‚</a></p>
<h3 id="setting-up-transaction-module">ä½¿ç”¨TypeDIè®¾ç½®äº‹åŠ¡æ¨¡å—</h3>
<p>éœ€è¦å…¬å¼€APIç«¯ç‚¹æ¥ä¿å­˜å’Œæ£€ç´¢äº‹åŠ¡ã€‚ä¸ºæ­¤ï¼Œä»TypeDIå¯¼å…¥<code>TransactionController</code>å’Œ<code>Container</code>ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬æ˜¯åœ¨<code>TransactionController</code>å†…éƒ¨åŠ¨æ€æ³¨å…¥<code>TransactionService</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä»TypeDIå®¹å™¨ä¸­è·å–ä¸€ä¸ª<code>TransactionController</code>å®ä¾‹ã€‚</p>
<p>åˆ›å»º<code>src/modules/transactions/transaction.routes.ts</code>å¹¶æ·»åŠ ä»¥ä¸‹ä»£ç :</p>
<pre class="language-typescript hljs">import { Request, Response, NextFunction, Router } from "express";
import Container from "typedi";
import TransactionController from "./transaction.controller";

const transactionsRouter = Router();
const transactionController = Container.get(TransactionController);

transactionsRouter.post(
  "/",
  (req: Request, res: Response, next: NextFunction) =&gt;
    transactionController.saveTransaction(req, res, next)
);

transactionsRouter.get("/", (req: Request, res: Response, next: NextFunction) =&gt;
  transactionController.getRecentTransactions(req, res, next)
);

export default transactionsRouter;
</pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å®šä¹‰<code>TransactionController</code>ã€‚å½“æˆ‘ä»¬å°†<code>TransactionService</code>æ³¨å…¥åˆ°æ„é€ å‡½æ•°ä¸­æ—¶ï¼Œä¾èµ–å…³ç³»ä¼šè‡ªåŠ¨è§£å†³ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»ç”¨<code>Service</code>è£…é¥°å™¨å°†è¯¥ç±»æ³¨é‡Šä¸ºä¸€ä¸ª<code>typedi</code>æœåŠ¡ã€‚</p>
<p>åˆ›å»º<code>src/modules/transactions/transaction.service.ts</code>å¹¶æ·»åŠ ä»¥ä¸‹ä»£ç :</p>
<pre class="language-typescript hljs">import { NextFunction, Request, Response } from "express";
import { Service } from "typedi";
import TransactionService from "./transaction.service";

@Service()
class TransactionController {
  constructor(private readonly transactionService: TransactionService) {}

  async getRecentTransactions(
    _req: Request,
    res: Response,
    next: NextFunction
  ) {
    try {
      const results = await this.transactionService.getTransactions();
      return res
        .status(200)
        .json({ message: `Found ${results.length} transaction(s)`, results });
    } catch (e) {
      next(e);
    }
  }

  async saveTransaction(req: Request, res: Response, next: NextFunction) {
    try {
      const transaction = req.body;
      await this.transactionService.saveTransaction(transaction);
      return res.send("Transaction was saved successfully");
    } catch (e) {
      next(e);
    }
  }
}

export default TransactionController;
</pre>
<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»º<code>TransactionService</code>å¹¶æ³¨å…¥<code>CacheProvider</code>ã€‚</p>
<p>ç„¶åï¼Œåœ¨<code>saveTransaction</code>æ–¹æ³•ä¸­ï¼Œä»ç¼“å­˜ä¸­ååºåˆ—åŒ–ä»»ä½•ç°æœ‰çš„äº‹åŠ¡è®°å½•ï¼Œæ›´æ–°äº‹åŠ¡åˆ—è¡¨ï¼Œå¹¶åºåˆ—åŒ–æ›´æ–°åçš„åˆ—è¡¨ã€‚</p>
<p>åˆ›å»º<code>/src/modules/transaction/transaction.service.ts</code>å¹¶æ·»åŠ ä»¥ä¸‹ä»£ç :</p>
<pre class="language-typescript hljs">import { Service } from "typedi";
import CacheProvider from "../../providers/cache";
import Transaction from "./transaction.model";

@Service()
class TransactionService {
  constructor(private readonly cacheProvider: CacheProvider) {}

  async saveTransaction(transaction: Transaction[]) {
    let cachedTransactions = await this.cacheProvider.get("transactions");
    let updatedTransactions: Transaction[] = [];

    if (cachedTransactions &amp;&amp; cachedTransactions.length &gt; 0) {
      updatedTransactions = [...JSON.parse(cachedTransactions), transaction];
    }

    await this.cacheProvider.set(
      "transactions",
      JSON.stringify(updatedTransactions)
    );
  }

  async getTransactions(): Promise&lt;Transaction[]&gt; {
    const cachedTransactions = await this.cacheProvider.get("transactions");
    if (!cachedTransactions) return [];
    return JSON.parse(cachedTransactions);
  }
</pre>
<h3 id="manually-testing-application">æ‰‹åŠ¨æµ‹è¯•åº”ç”¨ç¨‹åº</h3>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡å¥½æ‰‹åŠ¨æµ‹è¯•åº”ç”¨ç¨‹åºäº†ã€‚ç»§ç»­å¯åŠ¨ç»ˆç«¯ï¼Œç”¨<code>curl</code>æ‰§è¡Œä¸€äº›HTTPè¯·æ±‚:</p>
<pre class="language-bash hljs">curl -X "POST" --data '{"amount":10,"recipient":"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="31535e53715449505c415d541f525e5c">[emailÂ protected]</a>","sender":"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0e6f62676d6b4e6b766f637e626b206d6163">[emailÂ protected]</a>"}' http://localhost:3050/transactions
</pre>
<p>ç„¶åï¼Œæ·»åŠ ç¬¬äºŒä¸ªäº‹åŠ¡:</p>
<pre class="language-bash hljs">curl -X "POST" --data '{"amount":499,"recipient":"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="22564d4c5b62475a434f524e470c414d4f">[emailÂ protected]</a>","sender":"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="57363b3e343217322f363a273b327934383a">[emailÂ protected]</a>"}' http://localhost:3050/transactions
</pre>
<p>å¦‚æœæˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­è®¿é—®<code>localhost:3050/transactions</code>ï¼Œæˆ‘ä»¬åº”è¯¥ä¼šçœ‹åˆ°ä¸‹é¢çš„å“åº”:</p>
<p><img decoding="async" class="aligncenter size-full wp-image-138199 jetpack-lazy-image" src="../Images/2521ddc9af90e90dae356f6b203fcb2d.png" alt="Final Product Using Node.js and the Strategy Pattern" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2022/10/node-js-injectable-caching-host-browser-response.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/node-js-injectable-caching-host-browser-response.png"/></p><noscript><img data-lazy-fallback="1" decoding="async" loading="lazy" class="aligncenter size-full wp-image-138199" src="../Images/2521ddc9af90e90dae356f6b203fcb2d.png" alt="Final Product Using Node.js and the Strategy Pattern" data-original-src="https://blog.logrocket.com/wp-content/uploads/2022/10/node-js-injectable-caching-host-browser-response.png"/></noscript>
<h2>ç»“è®º</h2>
<p>è®¾è®¡æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼ä¸€æ ·ï¼Œæ˜¯è§£å†³éœ€è¦å¤šç§å®ç°çš„é—®é¢˜çš„ä¾¿åˆ©å·¥å…·ã€‚ä¾èµ–æ³¨å…¥æ˜¯ä¸€ç§æœ‰ä»·å€¼çš„æŠ€æœ¯ï¼Œæœ‰åŠ©äºä¿æŒæ¨¡å—éšæ—¶é—´æ¨ç§»çš„å¯ç»´æŠ¤æ€§ï¼Œå…·æœ‰å›é€€åŠŸèƒ½çš„åˆ†å¸ƒå¼ç¼“å­˜æœ‰åŠ©äºæé«˜æ„å»ºäº‘åº”ç”¨ç¨‹åºæ—¶çš„æ€§èƒ½ã€‚</p>
<p>æˆ‘å¼ºçƒˆå»ºè®®æ¢ç´¢å…¶ä»–åŠŸèƒ½è®¾è®¡æ¨¡å¼ï¼Œå¦‚ä»£ç†å’Œé€‚é…å™¨æ¨¡å¼ã€‚è¯·éšæ„ä»è¿™ä¸ªæ•™ç¨‹ä¸­å…‹éš†è¿™ä¸ªé¡¹ç›®ï¼Œå¹¶å°è¯•ä¸€ä¸‹ã€‚</p><div class="code-block code-block-23">
<div class="blog-plug inline-plug node-plug"><h2>200åª<img src="../Images/61167b9d027ca73ed5aaf59a9ec31267.png" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png"/> <noscript> <img data-lazy-fallback="1" src="../Images/61167b9d027ca73ed5aaf59a9ec31267.png" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/10/green-check.png"/> </noscript>æ˜¾ç¤ºå™¨å‡ºç°æ•…éšœï¼Œç”Ÿäº§ä¸­ç½‘ç»œè¯·æ±‚ç¼“æ…¢</h2><p>éƒ¨ç½²åŸºäºèŠ‚ç‚¹çš„webåº”ç”¨ç¨‹åºæˆ–ç½‘ç«™æ˜¯å®¹æ˜“çš„éƒ¨åˆ†ã€‚ç¡®ä¿æ‚¨çš„èŠ‚ç‚¹å®ä¾‹ç»§ç»­ä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºæä¾›èµ„æºæ˜¯äº‹æƒ…å˜å¾—æ›´åŠ å›°éš¾çš„åœ°æ–¹ã€‚å¦‚æœæ‚¨å¯¹ç¡®ä¿å¯¹åç«¯æˆ–ç¬¬ä¸‰æ–¹æœåŠ¡çš„è¯·æ±‚æˆåŠŸæ„Ÿå…´è¶£ï¼Œ</p><a href="https://lp.logrocket.com/blg/node-signup" target="_blank">try LogRocket</a><p>. </p><a class="signup" href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer"><img src="../Images/cae72fd2a54c5f02a6398c4867894844.png" alt="LogRocket Network Request Monitoring" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class=" jetpack-lazy-image" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png"/><noscript><img data-lazy-fallback="1" src="../Images/cae72fd2a54c5f02a6398c4867894844.png" alt="LogRocket Network Request Monitoring" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/12/network-request-filter-2-1.png"/></noscript></a><a href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer">https://logrocket.com/signup/</a><p>LogRocket å°±åƒæ˜¯ç½‘ç»œå’Œç§»åŠ¨åº”ç”¨ç¨‹åºçš„DVRï¼Œè®°å½•ä¸‹ç”¨æˆ·ä¸ä½ çš„åº”ç”¨ç¨‹åºäº¤äº’æ—¶å‘ç”Ÿçš„ä¸€åˆ‡ã€‚æ‚¨å¯ä»¥æ±‡æ€»å¹¶æŠ¥å‘Šæœ‰é—®é¢˜çš„ç½‘ç»œè¯·æ±‚ï¼Œä»¥å¿«é€Ÿäº†è§£æ ¹æœ¬åŸå› ï¼Œè€Œä¸æ˜¯çŒœæµ‹é—®é¢˜å‘ç”Ÿçš„åŸå› ã€‚</p><p>LogRocketæ£€æµ‹æ‚¨çš„åº”ç”¨ç¨‹åºä»¥è®°å½•åŸºçº¿æ€§èƒ½è®¡æ—¶ï¼Œå¦‚é¡µé¢åŠ è½½æ—¶é—´ã€åˆ°è¾¾ç¬¬ä¸€ä¸ªå­—èŠ‚çš„æ—¶é—´ã€æ…¢é€Ÿç½‘ç»œè¯·æ±‚ï¼Œè¿˜è®°å½•Reduxã€NgRxå’ŒVuexæ“ä½œ/çŠ¶æ€ã€‚</p><a class="signup" href="https://lp.logrocket.com/blg/node-signup" target="_blank" rel="noopener noreferrer">Start monitoring for free</a><p>. </p></div>
</div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>