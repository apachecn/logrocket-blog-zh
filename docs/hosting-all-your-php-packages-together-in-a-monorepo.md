# åœ¨ monorepo ä¸­æ‰˜ç®¡æ‰€æœ‰ PHP åŒ…

> åŸæ–‡ï¼š<https://blog.logrocket.com/hosting-all-your-php-packages-together-in-a-monorepo/>

å½“ä¸€ä¸ª PHP é¡¹ç›®å˜å¾—åºå¤§è€Œå¤æ‚æ—¶ï¼Œå®ƒå°±å˜å¾—éš¾ä»¥ç®¡ç†ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†é¡¹ç›®åˆ†å‰²æˆç‹¬ç«‹çš„åŒ…ï¼Œå¹¶ä½¿ç”¨ Composer å°†æ‰€æœ‰åŒ…å¯¼å…¥åˆ°é¡¹ç›®ä¸­ã€‚ç„¶åï¼Œä¸åŒçš„åŠŸèƒ½å¯ä»¥ç”±ä¸åŒçš„å›¢é˜Ÿå®ç°å’Œç»´æŠ¤ï¼Œä¹Ÿå¯ä»¥ç”±å…¶ä»–é¡¹ç›®é‡ç”¨ã€‚

Composer ä½¿ç”¨ [Packagist](https://packagist.org/) æ³¨å†Œè¡¨æ¥åˆ†å‘ PHP åŒ…ã€‚Packagist è¦æ±‚æˆ‘ä»¬åœ¨å‘å¸ƒæ–°è½¯ä»¶åŒ…æ—¶æä¾›ä¸€ä¸ªå­˜å‚¨åº“ URLã€‚

å› æ­¤ï¼Œå°†ä¸€ä¸ªé¡¹ç›®åˆ†å‰²æˆåŒ…ä¹Ÿä¼šå½±å“å®ƒä»¬çš„æ‰˜ç®¡æ–¹å¼:ä»æ‰˜ç®¡æ•´ä¸ªä»£ç çš„å•ä¸ªå­˜å‚¨åº“åˆ°æ‰˜ç®¡æ¯ä¸ªåŒ…çš„ä»£ç çš„å¤šä¸ªå­˜å‚¨åº“ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»è§£å†³äº†ç®¡ç†é¡¹ç›®ä»£ç çš„é—®é¢˜ï¼Œä½†ä»£ä»·æ˜¯äº§ç”Ÿäº†ä¸€ä¸ªæ–°é—®é¢˜:ç°åœ¨æˆ‘ä»¬å¿…é¡»ç®¡ç†ä»£ç çš„æ‰˜ç®¡ã€‚

## åˆ†æ•£åŒ…æ‰˜ç®¡çš„é—®é¢˜æ˜¯

æˆ‘ä»¬çš„åŒ…å°†è¢«ç‰ˆæœ¬åŒ–ï¼ŒåŒ…çš„æ¯ä¸ªç‰ˆæœ¬å°†ä¾èµ–äºå¦ä¸€ä¸ªåŒ…çš„æŸä¸ªç‰¹å®šç‰ˆæœ¬ï¼Œè€Œå¦ä¸€ä¸ªåŒ…æœ¬èº«åˆä¾èµ–äºå¦ä¸€ä¸ªåŒ…çš„æŸä¸ªç‰ˆæœ¬ï¼Œç­‰ç­‰ã€‚

è¿™åœ¨ä¸ºæ‚¨çš„é¡¹ç›®æäº¤æ‹‰è¯·æ±‚æ—¶ä¼šæˆä¸ºä¸€ä¸ªé—®é¢˜ï¼›å¾ˆå¯èƒ½ï¼Œæ‚¨è¿˜éœ€è¦ä¿®æ”¹æŸä¸ªåŒ…ä¸­çš„ä»£ç ï¼Œå› æ­¤æ‚¨éœ€è¦ä¸ºè¯¥åŒ…åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯ï¼Œå¹¶åœ¨æ‚¨çš„`composer.json`ä¸­æŒ‡å‘å®ƒã€‚

ç„¶åï¼Œå¦‚æœè¿™ä¸ªåŒ…ä¾èµ–äºå…¶ä»–ä¹Ÿå¿…é¡»ä¿®æ”¹çš„åŒ…ï¼Œæ‚¨éœ€è¦ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯ï¼Œå¹¶æ›´æ–°ç¬¬ä¸€ä¸ªåŒ…çš„`composer.json`æ¥æŒ‡å‘å®ƒã€‚

å¦‚æœè¿™ä¸ªåŒ…ä¾èµ–äºå…¶ä»–åŒ…ï¼Œä½ å°±æ˜ç™½äº†ã€‚

ç„¶åï¼Œä¸€æ—¦æ‚¨æ‰¹å‡†äº† pull è¯·æ±‚ï¼Œæ‚¨éœ€è¦æ’¤é”€æ‰€æœ‰`composer.json`æ–‡ä»¶ä¸­çš„æ‰€æœ‰ä¿®æ”¹ï¼Œä»¥æŒ‡å‘åŒ…çš„æ–°å‘å¸ƒç‰ˆæœ¬ã€‚

è¿™ä¸€åˆ‡å˜å¾—å¦‚æ­¤éš¾ä»¥å®ç°ï¼Œä»¥è‡³äºä½ å¾ˆå¯èƒ½ä¼šå®Œå…¨åœæ­¢ä½¿ç”¨ç‰¹æ€§åˆ†æ”¯å¹¶ç›´æ¥å‘å¸ƒåˆ°`master`ï¼Œè¿™æ ·ä½ å°†æ— æ³•è·Ÿè¸ªè·¨åŒ…çš„å˜åŒ–ã€‚é‚£ä¹ˆï¼Œå¦‚æœå°†æ¥æ‚¨éœ€è¦æ¢å¤æ›´æ”¹ï¼Œç¥æ‚¨å¥½è¿ï¼Œæ‰¾åˆ°æ‰€æœ‰åŒ…ä¸­è¢«ä¿®æ”¹çš„æ‰€æœ‰ä»£ç ç‰‡æ®µã€‚

æˆ‘ä»¬èƒ½åšäº›ä»€ä¹ˆå‘¢ï¼Ÿ

## monorepo ç®€ä»‹

è¿™å°±æ˜¯ monorepo æ‹¯æ•‘ä¸–ç•Œçš„åœ°æ–¹ã€‚æˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰çš„åŒ…æ‰˜ç®¡åœ¨ä¸€ä¸ªå­˜å‚¨åº“ä¸­ï¼Œè€Œä¸æ˜¯å°†æˆ‘ä»¬çš„ä»£ç åˆ†å¸ƒåœ¨å¤šä¸ªå­˜å‚¨åº“ä¸­ã€‚

monorepo å…è®¸æˆ‘ä»¬ä¸€èµ·å¯¹æ‰€æœ‰çš„åŒ…è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œå› æ­¤åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯å’Œæäº¤ä¸€ä¸ª pull è¯·æ±‚å°†åœ¨ä¸€ä¸ªåœ°æ–¹å®Œæˆï¼ŒåŒ…æ‹¬æ‰€æœ‰å¯èƒ½å—å®ƒå½±å“çš„åŒ…çš„ä»£ç ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬ä»ç„¶å—åˆ° Packagist çš„çº¦æŸ:å‡ºäºåˆ†å‘çš„ç›®çš„ï¼Œæ¯ä¸ªåŒ…éƒ½éœ€è¦å­˜åœ¨äºå®ƒè‡ªå·±çš„å­˜å‚¨åº“ä¹‹ä¸‹ã€‚

æˆ‘ä»¬ç°åœ¨è¦å¹²å˜›ï¼Ÿ

### è§£å†³åŒ…è£…é™åˆ¶

è§£å†³æ–¹æ¡ˆæ˜¯åˆ†ç¦»ä»£ç çš„å¼€å‘å’Œåˆ†å‘:

*   ä½¿ç”¨ monorepo å¼€å‘ä»£ç 
*   ä½¿ç”¨å¤šä¸ªå­˜å‚¨åº“(æ¯ä¸ªåŒ…ä¸€ä¸ªå›è´­)æ¥åˆ†å‘å®ƒ(è‘—åçš„â€œ[åªè¯»]â€å›è´­)

ç„¶åï¼Œæˆ‘ä»¬å¿…é¡»ä¿æŒæ‰€æœ‰çš„æºåº“å’Œåˆ†å¸ƒåº“åŒæ­¥ã€‚

å½“åœ¨ monorepo ä¸­å¼€å‘ä»£ç æ—¶ï¼Œåœ¨ä¸€ä¸ªæ–°çš„ pull è¯·æ±‚è¢«åˆå¹¶ä¹‹åï¼Œæ¯ä¸ªåŒ…çš„æ–°ä»£ç å¿…é¡»è¢«å¤åˆ¶åˆ°å®ƒè‡ªå·±çš„å­˜å‚¨åº“ä¸­ï¼Œä»é‚£é‡Œå®ƒå¯ä»¥è¢«åˆ†å‘ã€‚

è¿™è¢«ç§°ä¸ºåˆ†å‰²å•ä¸€å›è´­åè®®ã€‚

## å¦‚ä½•æ‹†åˆ†å•ä¸€å›è´­åè®®

ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯[ä½¿ç”¨`git subtree split`åˆ›å»ºä¸€ä¸ªè„šæœ¬](https://stackoverflow.com/questions/359424/detach-move-subdirectory-into-separate-git-repository/17864475#17864475)ï¼Œç„¶åå°†åŒ…ä»£ç åŒæ­¥åˆ°å®ƒè‡ªå·±çš„ repo ä¸­ã€‚

ä¸€ä¸ªæ›´å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ä¸€ä¸ªå·¥å…·æ¥å®Œæˆè¿™é¡¹å·¥ä½œï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é¿å…æ‰‹åŠ¨æ“ä½œã€‚æœ‰å‡ ç§å·¥å…·å¯ä¾›é€‰æ‹©:

ç”±æ­¤ï¼Œæˆ‘é€‰æ‹©ä½¿ç”¨ Monorepo builderï¼Œå› ä¸ºå®ƒæ˜¯ç”¨ PHP ç¼–å†™çš„ï¼Œæ‰€ä»¥æˆ‘å¯ä»¥ç”¨è‡ªå®šä¹‰åŠŸèƒ½æ¥æ‰©å±•å®ƒã€‚(ç›¸æ¯”ä¹‹ä¸‹ï¼Œ`splitsh/lite`æ˜¯ç”¨ Go å†™çš„ï¼Œ`dflydev/git-subsplit`æ˜¯ Bash è„šæœ¬ã€‚)

> **æ³¨æ„**ï¼ŒMonorepo builder ä»…é€‚ç”¨äº PHP åŒ…ã€‚å¦‚æœæ‚¨éœ€è¦ç®¡ç† JavaScript åŒ…æˆ–å…¶ä»–ä»»ä½•ä¸œè¥¿ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨å¦ä¸€ä¸ªå·¥å…·ã€‚

## ç»„ç»‡å•ä¸€å›è´­ç»“æ„

æ‚¨å¿…é¡»åˆ›å»ºä¸€ä¸ªç»“æ„æ¥ç»„ç»‡ monorepo ä¸­çš„ä»£ç ã€‚åœ¨æœ€ç®€å•çš„æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥æœ‰ä¸€ä¸ªæ ¹`packages/`æ–‡ä»¶å¤¹ï¼Œå¹¶å°†æ¯ä¸ªåŒ…æ·»åŠ åˆ°å®ƒè‡ªå·±çš„å­æ–‡ä»¶å¤¹ä¸­ã€‚

å¦‚æœæ‚¨çš„ä»£ç æ›´å¤æ‚ï¼Œä¸ä»…åŒ…å«åŒ…ï¼Œè¿˜åŒ…å«æŸã€åˆåŒæˆ–å…¶ä»–å†…å®¹ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå¤šçº§ç»“æ„ã€‚

ä¾‹å¦‚ï¼ŒSymfony åœ¨å…¶ monorepo `[symfony/symfony](https://github.com/symfony/symfony)`ä¸­ä½¿ç”¨äº†ä»¥ä¸‹ç»“æ„:

![Symfony Monorepo Multilevel Structure](img/001eac55fbec2b731638c691297588c0.png)

Symfony monorepo structure

å°±æˆ‘è‡ªå·±è€Œè¨€ï¼Œæˆ‘æœ€è¿‘æ‰å»ºç«‹äº†ä¸€ä¸ª monorepo æ¥æ‰˜ç®¡æˆ‘æ‰€æœ‰çš„é¡¹ç›®ã€‚(åŸå› æ˜¯æˆ‘æœ‰ä¸€ä¸ªæ½œåœ¨çš„è´¡çŒ®è€…ï¼Œä»–ä¸èƒ½è®¾æ³•å»ºç«‹å¼€å‘ç¯å¢ƒï¼Œæ‰€ä»¥ä»–ç¦»å¼€äº†ğŸ˜¢ã€‚)

æˆ‘çš„æ•´ä¸ªé¡¹ç›®åŒ…å«å¤šä¸ªå±‚æ¬¡:WordPress çš„ GraphQL API æ’ä»¶ä½äºæœåŠ¡å™¨[ä¹‹ä¸Šï¼ŒGraphQL by PoP](https://graphql-by-pop.com) ä½äºæ¡†æ¶[ä¹‹ä¸Šã€‚](https://github.com/leoloso/PoP)

è™½ç„¶è¿™äº›æ˜¯ç›¸å…³çš„ï¼Œä½†å®ƒä»¬ä¹Ÿæ˜¯ç‹¬ç«‹çš„:æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ PoP æ¥é©±åŠ¨å…¶ä»–åº”ç”¨ç¨‹åºï¼Œè€Œä¸ä»…ä»…æ˜¯ GraphQL by PoPPoP çš„ GraphQL å¯ä»¥æ”¯æŒä»»ä½• CMSï¼Œè€Œä¸ä»…ä»…æ˜¯ WordPressã€‚

å› æ­¤ï¼Œæˆ‘å†³å®šå°†è¿™äº›è§†ä¸ºâ€œå±‚â€ï¼Œå…¶ä¸­æ¯ä¸€å±‚[å¯èƒ½ä¼šçœ‹åˆ°å¹¶ä½¿ç”¨å¦ä¸€å±‚ï¼Œä½†å…¶ä»–å±‚](https://github.com/leoloso/PoP#dependency-graph)ä¸ä¼šã€‚

åœ¨åˆ›å»º monorepo ç»“æ„æ—¶ï¼Œæˆ‘å¤åˆ¶äº†è¿™ä¸ªæƒ³æ³•ï¼Œå°†ä»£ç åˆ†ä¸¤ä¸ªå±‚æ¬¡:é¦–å…ˆæ˜¯`layers/`ï¼Œç„¶åæ˜¯`packages/`(å¯¹äºä¸€ä¸ªç‰¹å®šçš„æƒ…å†µï¼Œè¿˜æœ‰`plugins/`):

![Monorepo Structure Code Distribute Levels Layers Packages](img/4b5b9c4a558d1ffcc4d540429c658227.png)

PoP monorepo structure

æˆ‘æ²¡æœ‰åˆ›å»ºä¸€ä¸ªæ–°çš„åº“ï¼Œè€Œæ˜¯å†³å®šé‡ç”¨æ¥è‡ª PoP çš„åº“ï¼Œåœ¨ [`leoloso/PoP`](https://github.com/leoloso/PoP) ä¸‹ï¼Œå› ä¸ºå®ƒæ˜¯æ•´ä¸ªä»£ç çš„åŸºç¡€(ä¹Ÿå› ä¸ºæˆ‘ä¸æƒ³å¤±å»å®ƒè¢«èµ‹äºˆçš„æ˜Ÿæ˜ŸğŸ˜).

ä¸€æ—¦å®šä¹‰äº† monorepo ç»“æ„ï¼Œå°±å¯ä»¥ä»æ¯ä¸ªåŒ…çš„å­˜å‚¨åº“ä¸­è¿ç§»ä»£ç ã€‚

## å¯¼å…¥ä»£ç ï¼ŒåŒ…æ‹¬ Git å†å²

å¦‚æœæ‚¨ä»å¤´å¼€å§‹ monorepoï¼Œæ‚¨å¯ä»¥è¿è¡Œ [`monorepo-builder init`](https://github.com/symplify/monorepo-builder#0-are-you-new-to-monorepo) æ¥è®¾ç½®å®ƒï¼Œå¹¶ä¸ºæ‚¨çš„æ¯ä¸ªæ–°åŒ…åˆ›å»ºä¸€ä¸ªæ–°çš„å­˜å‚¨åº“ã€‚å¦åˆ™ï¼Œå¦‚æœæ‚¨å·²ç»åœ¨å®ƒä»¬è‡ªå·±çš„å­˜å‚¨åº“ä¸­å¼€å‘äº†æ‚¨çš„åŒ…ï¼Œæ‚¨å°†éœ€è¦æŠŠå®ƒä»¬ç§»æ¤åˆ° monorepoã€‚

æœ€æœ‰å¯èƒ½çš„æƒ…å†µæ˜¯ï¼Œåœ¨è¿ç§»åŒ…æ—¶ï¼Œæ‚¨è¿˜ä¼šå¸Œæœ›ç§»æ¤å®ƒä»¬çš„ Git å†å²å’Œæäº¤æ•£åˆ—ï¼Œä»¥ä¾¿å°†å®ƒä»¬ä½œä¸ºæ–‡æ¡£æ¥æµè§ˆï¼Œå¹¶è·Ÿè¸ªè°åšäº†ä»€ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™åšçš„ï¼Œä»¥åŠä¸ºä»€ä¹ˆåšã€‚

Monorepo builder ä¸ä¼šå¸®åŠ©æ‚¨å®Œæˆè¿™é¡¹ä»»åŠ¡ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªå·¥å…·:

åœ¨æ‚¨è¿ç§»äº†ä»£ç ä¹‹åï¼Œæ‚¨å¯ä»¥å¼€å§‹ä½¿ç”¨ Monorepo builder æ¥ç®¡ç†å®ƒï¼Œæ­£å¦‚å…¶è‡ªè¿°æ–‡ä»¶ä¸­æ‰€è§£é‡Šçš„é‚£æ ·ã€‚

## å•ä¸€çš„`composer.json`æ¥ç»Ÿæ²»ä»–ä»¬æ‰€æœ‰äºº

æ¯ä¸ª PHP åŒ…éƒ½æœ‰è‡ªå·±çš„`composer.json`æ–‡ä»¶ï¼Œå®šä¹‰äº†å®ƒçš„ä¾èµ–å…³ç³»ã€‚

monorepo ä¹Ÿæœ‰è‡ªå·±çš„`composer.json`æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰ PHP åŒ…çš„æ‰€æœ‰ä¾èµ–é¡¹ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä» monorepo æ ¹æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œå¯¹æ‰€æœ‰åŒ…ä¸­çš„æ‰€æœ‰ä»£ç è¿è¡Œ PHPUnit æµ‹è¯•ã€PHPStan é™æ€åˆ†ææˆ–ä»»ä½•å…¶ä»–ä¸œè¥¿ã€‚

ä¸ºæ­¤ï¼ŒPHP åŒ…å¿…é¡»åŒ…å«ç›¸åŒä¾èµ–é¡¹çš„ç›¸åŒç‰ˆæœ¬ï¼é‚£ä¹ˆå¦‚æœ A åŒ…è¦æ±‚ PHPUnit 7.5ï¼ŒB åŒ…è¦æ±‚ PHPUnit 9.3ï¼Œå°±ä¸è¡Œäº†ã€‚

Monorepo builder æä¾›äº†ä»¥ä¸‹å‘½ä»¤:

*   `monorepo-builder validate`æ£€æŸ¥æ‰€æœ‰`composer.json`ä¸­çš„ä¾èµ–å…³ç³»æ˜¯å¦ä¸å†²çª
*   `monorepo-builder merge`ä»æ‰€æœ‰`composer.json`ä¸­æå–æ‰€æœ‰ä¾èµ–é¡¹(å’Œå…¶ä»–ä¿¡æ¯),å¹¶å°†å®ƒä»¬åˆå¹¶åˆ° monorepo è‡ªå·±çš„`composer.json`ä¸­

æˆ‘èŠ±äº†ä¸€ç‚¹æ—¶é—´æ‰æ„è¯†åˆ°ï¼Œä½ ä¸èƒ½æ‰‹åŠ¨ç¼–è¾‘æ ¹ç›®å½•`composer.json`ï¼ç”±äºè¯¥æ–‡ä»¶æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå¦‚æœæ²¡æœ‰é€šè¿‡å·¥å…·çš„é…ç½®æ–‡ä»¶æ·»åŠ ï¼Œæ‚¨å¯èƒ½ä¼šä¸¢å¤±è‡ªå®šä¹‰æ›´æ”¹ã€‚

æœ‰è¶£çš„æ˜¯ï¼Œå¤„ç† Monorepo æ„å»ºå™¨æœ¬èº«å°±æ˜¯è¿™ç§æƒ…å†µã€‚è¦åœ¨æ‚¨çš„é¡¹ç›®ä¸­å®‰è£…è¿™ä¸ªåº“ï¼Œæ‚¨å¯ä»¥åƒå¾€å¸¸ä¸€æ ·åœ¨ monorepo æ ¹ç›®å½•ä¸­è¿è¡Œ`composer require symplify/monorepo-builder --dev`ã€‚ä½†æ˜¯ç´§æ¥ç€ï¼Œæ‚¨åº”è¯¥[åœ¨é…ç½®æ–‡ä»¶](https://github.com/leoloso/PoP/blob/18712eb48d8002baf1fbf457cd61caa6f13115a0/composer.json#L35) [`monorepo-builder.php`](https://github.com/leoloso/PoP/blob/ba20f72ef087f743962bb315003022924bf60a8c/monorepo-builder.php#L69:L72) ä¸­é‡æ–°åˆ›å»ºä¾èµ–å…³ç³»:

```
return static function (ContainerConfigurator $containerConfigurator): void {
  $parameters = $containerConfigurator->parameters();
  $parameters->set(Option::DATA_TO_APPEND, [
    'require-dev' => [
      'symplify/monorepo-builder' => '^9.0',
    ]
  ]);
}

```

## åˆ†å‰²å•ä¸€æŠ¥å‘Š

å› æ­¤ï¼Œæ‚¨å·²ç»åˆå¹¶äº†ä¸€ä¸ªæ‹‰å–è¯·æ±‚ã€‚ç°åœ¨æ˜¯æ—¶å€™å°†æ–°ä»£ç åŒæ­¥åˆ°åŒ…å­˜å‚¨åº“ä¸­äº†ã€‚è¿™å°±å«åˆ†è£‚ã€‚

å¦‚æœæ‚¨åœ¨ GitHub ä¸Šæ‰˜ç®¡æ‚¨çš„ monorepoï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªåœ¨`master`(æˆ–`main`)åˆ†æ”¯çš„`push`äº‹ä»¶ä¸Šè§¦å‘çš„åŠ¨ä½œæ¥æ‰§è¡Œ Monorepo Split çš„ [GitHub åŠ¨ä½œï¼ŒæŒ‡ç¤ºå“ªä¸ªæ˜¯æºåŒ…ç›®å½•ï¼Œä»¥åŠè¦å°†å†…å®¹å¤åˆ¶åˆ°å“ªä¸ªå­˜å‚¨åº“:](https://github.com/symplify/monorepo-split-github-action)

```
name: 'Monorepo Split'

on:
  push:
    branches:
      - master

jobs:
  monorepo_split_test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/[emailÂ protected]
        with:
          fetch-depth: 0

      - uses: "symplify/[emailÂ protected]"
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        with:
          # â†“ split "packages/your-package-name" directory
          package-directory: 'packages/your-package-name'

          # â†“ into https://github.com/your-organization/your-package-name repository
          split-repository-organization: 'your-organization'
          split-repository-name: 'your-package-name'

          # â†“ the user signed under the split commit
          user-name: "your-github-username"
          user-email: "[emailÂ protected]"

```

ä¸ºäº†è®©è¿™ä¸ªå·¥ä½œï¼Œä½ è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„è®¿é—®ä»¤ç‰Œï¼Œä½œç”¨åŸŸä¸ºâ€œå›è´­â€å’Œâ€œå·¥ä½œæµâ€ï¼Œå¦‚è¿™é‡Œçš„æ‰€è§£é‡Šçš„[ï¼Œå¹¶åœ¨ç§˜å¯†`ACCESS_TOKEN`ä¸‹è®¾ç½®è¿™ä¸ªä»¤ç‰Œï¼Œå¦‚è¿™é‡Œçš„](https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token)æ‰€è§£é‡Šçš„[ã€‚](https://docs.github.com/en/actions/reference/encrypted-secrets)

ä¸Šé¢çš„ä¾‹å­é€‚ç”¨äºåˆ†å‰²å•ä¸ªåŒ…ã€‚æˆ‘ä»¬å¦‚ä½•è®¾æ³•åˆ†å‰²å¤šä¸ªåŒ…ï¼Ÿæˆ‘ä»¬å¿…é¡»ä¸ºå®ƒä»¬ä¸­çš„æ¯ä¸€ä¸ªå£°æ˜ä¸€ä¸ªå·¥ä½œæµå—ï¼Ÿ

å½“ç„¶ä¸æ˜¯ã€‚GitHub åŠ¨ä½œæ”¯æŒ[å®šä¹‰ä¸åŒä½œä¸šé…ç½®çš„çŸ©é˜µ](https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix)ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªçŸ©é˜µæ¥å¹¶è¡Œå¯åŠ¨è®¸å¤š runner å®ä¾‹ï¼Œæ¯ä¸ªåŒ…ä¸€ä¸ª runner æ¥æ‹†åˆ†:

```
jobs:
  provide_packages_json:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/[emailÂ protected]

      - uses: shivammathur/[emailÂ protected]
        with:
          php-version: 7.4
          coverage: none

      - uses: "ramsey/[emailÂ protected]"

      # get package json list
      - id: output_data
        run: echo "::set-output name=matrix::$(vendor/bin/monorepo-builder packages-json)"

    outputs:
      matrix: ${{ steps.output_data.outputs.matrix }}

  split_monorepo:
    needs: provide_packages_json

    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{fromJson(needs.provide_packages_json.outputs.matrix)}}

    steps:
      - uses: actions/[emailÂ protected]

      - name: Monorepo Split of ${{ matrix.package }}
        uses: symplify/[emailÂ protected]
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        with:
          package-directory: 'packages/${{ matrix.package }}'
          split-repository-organization: 'your-organization'
          split-repository-name: '${{ matrix.package }}'
          user-name: "your-github-username"
          user-email: "[emailÂ protected]"

```

ç°åœ¨ï¼ŒåŒ…åä¸å†æ˜¯ç¡¬ç¼–ç ï¼Œè€Œæ˜¯æ¥è‡ªæ¯ä½“(â€œç°å®æ˜¯ï¼Œå‹ºå­ä¸å­˜åœ¨â€)ã€‚

æ­¤å¤–ï¼Œç”±äºåŒ…åˆ—è¡¨æ˜¯é€šè¿‡`monorepo-builder.php`é…ç½®æ–‡ä»¶æä¾›çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä»é‚£é‡Œæå–å®ƒã€‚è¿™æ˜¯é€šè¿‡æ‰§è¡Œå‘½ä»¤`vendor/bin/monorepo-builder packages-json`å®Œæˆçš„ï¼Œå®ƒäº§ç”Ÿä¸€ä¸ªåŒ…å«æ‰€æœ‰åŒ…çš„å­—ç¬¦ä¸²åŒ–çš„ JSON è¾“å‡º:

![Monorepo Builder Configuration File Stringified JSON Output](img/e1a5c025e6143bb078e46c4824989bf9.png)

Retrieving the list of packages.

## å‘å¸ƒæ–°ç‰ˆæœ¬(é’ˆå¯¹æ‰€æœ‰è½¯ä»¶åŒ…)

monorepo é€šè¿‡å¯¹æ‰€æœ‰åŒ…ä¸€èµ·è¿›è¡Œç‰ˆæœ¬æ§åˆ¶æ¥ä¿æŒç®€å•ï¼Œå¯¹æ‰€æœ‰åŒ…ä½¿ç”¨ç›¸åŒçš„ç‰ˆæœ¬ã€‚å› æ­¤ï¼Œç‰ˆæœ¬ä¸º 0.7 çš„åŒ… A å°†ä¾èµ–äºç‰ˆæœ¬ä¸º 0.7 çš„åŒ… Bï¼Œä¾æ­¤ç±»æ¨ã€‚

è¿™æ„å‘³ç€æˆ‘ä»¬å°†æ ‡è®°åŒ…ï¼Œå³ä½¿åŒ…ä¸­çš„ä»£ç æ²¡æœ‰æ”¹å˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåŒ… A å·²è¢«ä¿®æ”¹ï¼Œå®ƒå°†è¢«æ ‡è®°ä¸º 0.7ï¼Œä½†åŒ… B ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå³ä½¿å®ƒä¸åŒ…å«ä»»ä½•ä¿®æ”¹ã€‚

Monorepo builder ä½¿æ ‡è®°æ‰€æœ‰åŒ…å˜å¾—éå¸¸å®¹æ˜“ã€‚æˆ‘ä»¬é¦–å…ˆéœ€è¦æœ‰ä¸€ä¸ª[å·¥ä½œæµæ¥åœ¨æ ‡è®°äº†](https://github.com/leoloso/PoP/blob/c090d436b9558b877d3dea8fa3398a1a782757a7/.github/workflows/split_monorepo_tagged.yaml)çš„æ—¶å€™åˆ†å‰² monorepo(åŸºæœ¬ä¸Šä¸ä¸Šé¢çš„å·¥ä½œæµç›¸åŒï¼ŒåŠ ä¸Š[å°†æ ‡è®°ä¼ é€’ç»™](https://github.com/leoloso/PoP/blob/c090d436b9558b877d3dea8fa3398a1a782757a7/.github/workflows/split_monorepo_tagged.yaml#L73) `symplify/github-action-monorepo-split`)ã€‚

ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡[è¿è¡Œå‘½ä»¤](https://github.com/symplify/monorepo-builder#6-release-flow)å°† monorepo æ ‡è®°ä¸ºç‰ˆæœ¬`0.7`:

```
vendor/bin/monorepo-builder release "0.7" 
```

æ‰§è¡Œè¿™ä¸ªå‘½ä»¤çœŸçš„å¾ˆç¥å¥‡ã€‚å®ƒé¦–å…ˆå‘å¸ƒç”¨äºç”Ÿäº§çš„ä»£ç :

*   å°†åŒ…ä¹‹é—´çš„ç›¸äº’ä¾èµ–æå‡åˆ°`0.7`
*   ç”¨`0.7`æ ‡è®° monorepo
*   ç”¨æ ‡ç­¾`0.7`åšä¸€ä¸ª`git push`

ç„¶åï¼Œå®ƒå°†ä»£ç è¿˜åŸç”¨äºå¼€å‘:

*   å°†æ‰€æœ‰åŒ…ä¸­`dev-master`çš„åˆ†æ”¯åˆ«åæ›´æ–°ä¸º`0.8-dev`
*   å°†ç›¸äº’ä¾èµ–æå‡åˆ°`0.8-dev`
*   åšä¸€ä¸ª`git push`

è§‚çœ‹å®ƒçš„å®é™…æ“ä½œä¸€ç›´è®©æˆ‘ç€è¿·ã€‚æ£€æŸ¥åœ¨æ‰§è¡Œä¸€ä¸ªå‘½ä»¤æ—¶ï¼Œæ•´ä¸ªç¯å¢ƒçœ‹èµ·æ¥æ˜¯å¦‚ä½•è‡ªç”Ÿè‡ªç­çš„:

![Monorepo Builder Command Run Tag Packages](img/c319794c991477c1a6d16724f537a624.png)

## ä»åŒ…ä¸­åˆ é™¤å·¥ä½œæµ

å³ä½¿æˆ‘ä»¬åœ¨ monorepo ä¸­ä¸ºæ‰€æœ‰åŒ…è¿è¡Œ PHPUnitï¼Œæˆ‘ä»¬å¯èƒ½ä»ç„¶å¸Œæœ›åœ¨æ¯ä¸ªåŒ…è¢«åˆ†å‰²åï¼Œåœ¨å®ƒè‡ªå·±çš„å­˜å‚¨åº“ä¸­å¯¹æ¯ä¸ªåŒ…è¿è¡Œ PHPUnitï¼Œå³ä½¿åªæ˜¯ä¸ºäº†æ˜¾ç¤ºä¸€ä¸ªæˆåŠŸå¾½ç« ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬ä¸èƒ½å†è¿™æ ·ä¸‹å»äº†ã€‚æˆ–è€…è‡³å°‘ä¸é‚£ä¹ˆå®¹æ˜“ã€‚

äº‹å®ä¸Šï¼Œæ‰€æœ‰çš„åŒ…éƒ½è¢«ä¸€èµ·ç‰ˆæœ¬åŒ–å¹¶åŒæ—¶å‘å¸ƒï¼Œå¹¶ä¸”æ¯ä¸ªåŒ…çš„æ–°ç‰ˆæœ¬éœ€è¦ä¸€ç‚¹æ—¶é—´æ‰èƒ½åœ¨ Packagist ä¸Šå¯ç”¨â€”â€”æ¯”å¦‚è¯´äº”åˆ†é’Ÿâ€”â€”è¿™æ„å‘³ç€åœ¨è¿è¡Œ`composer install`æ—¶ä¾èµ–é¡¹å¯èƒ½ä¸å¯ç”¨ï¼Œå¯¼è‡´ PHPUnit å·¥ä½œæµå¤±è´¥ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœåŒ… A ä¾èµ–äºåŒ… Bï¼Œç”¨ç‰ˆæœ¬ 0.3 æ ‡è®°å®ƒä»¬æ„å‘³ç€åŒ… A çš„ç‰ˆæœ¬ 0.3 å°†ä¾èµ–äºåŒ… B çš„ç‰ˆæœ¬ 0.3ã€‚ä½†æ˜¯ï¼Œç”±äºä¸¤è€…åŒæ—¶è¢«æ‹†åˆ†å’Œæ ‡è®°ï¼Œå½“åŒ… A è¿è¡Œä¸€ä¸ªç”±æ¨é€åˆ°`master`è§¦å‘çš„åŠ¨ä½œæ—¶ï¼ŒåŒ… B çš„ 0.3 ç‰ˆæœ¬è¿˜ä¸å¯ç”¨ï¼Œå·¥ä½œæµä¼šå¤±è´¥ã€‚

æ€»ä¹‹:æ‚¨å°†éœ€è¦ä»æ¯ä¸ªåŒ…çš„å­˜å‚¨åº“ä¸­åˆ é™¤è¿è¡Œè¿™äº›å·¥ä½œæµï¼Œå¹¶ä¸”åªä¾èµ– monorepo ä¸­çš„å·¥ä½œæµã€‚

æˆ–è€…ï¼Œå¦‚æœä½ çœŸçš„æƒ³è¦é‚£ä¸ªæˆåŠŸå¾½ç« ï¼Œä¸ºå®ƒæ‰¾ä¸€äº›çªé—¨(æ¯”å¦‚å»¶è¿Ÿ 10 åˆ†é’Ÿå·¥ä½œæµçš„æ‰§è¡Œ)ã€‚

## ç»“è®º

monorepo æœ‰åŠ©äºç®¡ç†å¤§å‹ä»£ç åº“çš„å¤æ‚æ€§ã€‚å®ƒä½¿å¾—ç»´æŠ¤æ•´ä¸ªé¡¹ç›®çš„ä¸€è‡´å¿«ç…§æˆ–çŠ¶æ€å˜å¾—å®¹æ˜“ï¼Œå…è®¸æäº¤ä¸€ä¸ªåŒ…å«æ¥è‡ªå¤šä¸ªåŒ…çš„ä»£ç çš„ pull è¯·æ±‚ï¼Œå¹¶ä¸”æ¬¢è¿ç¬¬ä¸€æ¬¡çš„è´¡çŒ®è€…æ¥è®¾ç½®é¡¹ç›®è€Œä¸æ‰“å—ã€‚

æ‰€æœ‰è¿™äº›ç‰¹å¾ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨å¤§é‡çš„å­˜å‚¨åº“æ¥è·å¾—ï¼Œä½†æ˜¯åœ¨å®è·µä¸­ï¼Œå®ƒä»¬å¾ˆéš¾æ‰§è¡Œã€‚

å•ä¸€å›è´­åè®®æœ¬èº«å¿…é¡»å¾—åˆ°ç®¡ç†ã€‚å…³äº PHP åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Monorepo builder åº“æ¥å®ç°ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•è®¾ç½®è¿™ä¸ªå·¥å…·ï¼Œé…ç½®å®ƒï¼Œå¹¶ä½¿ç”¨å®ƒå‘å¸ƒæˆ‘ä»¬çš„åŒ…ã€‚

## ä½¿ç”¨ [LogRocket](https://lp.logrocket.com/blg/signup) æ¶ˆé™¤ä¼ ç»Ÿé”™è¯¯æŠ¥å‘Šçš„å¹²æ‰°

[![LogRocket Dashboard Free Trial Banner](img/d6f5a5dd739296c1dd7aab3d5e77eeb9.png)](https://lp.logrocket.com/blg/signup)

[LogRocket](https://lp.logrocket.com/blg/signup) æ˜¯ä¸€ä¸ªæ•°å­—ä½“éªŒåˆ†æè§£å†³æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥ä¿æŠ¤æ‚¨å…å—æ•°ç™¾ä¸ªå‡é˜³æ€§é”™è¯¯è­¦æŠ¥çš„å½±å“ï¼Œåªé’ˆå¯¹å‡ ä¸ªçœŸæ­£é‡è¦çš„é¡¹ç›®ã€‚LogRocket ä¼šå‘Šè¯‰æ‚¨åº”ç”¨ç¨‹åºä¸­å®é™…å½±å“ç”¨æˆ·çš„æœ€å…·å½±å“åŠ›çš„ bug å’Œ UX é—®é¢˜ã€‚

ç„¶åï¼Œä½¿ç”¨å…·æœ‰æ·±å±‚æŠ€æœ¯é¥æµ‹çš„ä¼šè¯é‡æ”¾æ¥ç¡®åˆ‡åœ°æŸ¥çœ‹ç”¨æˆ·çœ‹åˆ°äº†ä»€ä¹ˆä»¥åŠæ˜¯ä»€ä¹ˆå¯¼è‡´äº†é—®é¢˜ï¼Œå°±åƒä½ åœ¨ä»–ä»¬èº«åçœ‹ä¸€æ ·ã€‚

LogRocket è‡ªåŠ¨èšåˆå®¢æˆ·ç«¯é”™è¯¯ã€JS å¼‚å¸¸ã€å‰ç«¯æ€§èƒ½æŒ‡æ ‡å’Œç”¨æˆ·äº¤äº’ã€‚ç„¶å LogRocket ä½¿ç”¨æœºå™¨å­¦ä¹ æ¥å‘Šè¯‰ä½ å“ªäº›é—®é¢˜æ­£åœ¨å½±å“å¤§å¤šæ•°ç”¨æˆ·ï¼Œå¹¶æä¾›ä½ éœ€è¦ä¿®å¤å®ƒçš„ä¸Šä¸‹æ–‡ã€‚

å…³æ³¨é‡è¦çš„ bugâ€”[ä»Šå¤©å°±è¯•è¯• LogRocketã€‘ã€‚](https://lp.logrocket.com/blg/signup-issue-free)