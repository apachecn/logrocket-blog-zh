<html>
<head>
<title>JWT authentication with Apollo Server 2: tips and tricks - LogRocket Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Apollo Server 2çš„JWTè®¤è¯:æŠ€å·§å’Œçªé—¨</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.logrocket.com/jwt-authentication-with-apollo-server-2-tips-and-tricks/#0001-01-01">https://blog.logrocket.com/jwt-authentication-with-apollo-server-2-tips-and-tricks/#0001-01-01</a></blockquote><div><article class="article-post">
<p>åœ¨æ„å»ºç«¯ç‚¹(GraphQLæˆ–REST API)æ—¶çš„æŸä¸ªæ—¶åˆ»ï¼Œæ‚¨ä¼šå¸Œæœ›æ ¹æ®ç”¨æˆ·æ˜¯å¦ç»è¿‡èº«ä»½éªŒè¯æ¥é™åˆ¶å¯¹åº”ç”¨ç¨‹åºæŸäº›éƒ¨åˆ†çš„è®¿é—®ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨JSON Webä»¤ç‰Œ(JWT)å’ŒBcryptæ¥å®ç°è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬å°†åœ¨ä¸€ä¸ªä½¿ç”¨Prismaä½œä¸ºORMé€‰æ‹©çš„ApolloæœåŠ¡å™¨ä¸Šå®ç°å®ƒï¼Œä½†æ˜¯å…¶ä»–ä»»ä½•ORMéƒ½å¯ä»¥ã€‚</p>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨æ‰§è¡Œç”¨æˆ·èº«ä»½éªŒè¯å¹¶ç¡®å®šä»–ä»¬æ˜¯å¦ç™»å½•çš„æœ€æœ‰æ•ˆå’Œå¯ä¼¸ç¼©çš„æ–¹æ³•ä¹‹ä¸€ã€‚</p>
<p>æœ‰å‡ ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹:å¦‚æœä½ æ˜¯ä¸¥æ ¼åœ°ä¸ºä¸€ä¸ªç½‘é¡µæ„å»ºï¼Œé€šè¿‡cookieæˆ–è€…å¦‚æœä½ æ˜¯é’ˆå¯¹ä¸€ä¸ªAPIï¼Œé€šè¿‡headerã€‚</p>
<p>æœ¬æ–‡å‡è®¾æ‚¨ç†Ÿæ‚‰åœ¨GraphQLä¸­æ‰§è¡ŒæŸ¥è¯¢å’Œå˜å¼‚çš„åŸºç¡€çŸ¥è¯†ï¼Œä»¥åŠä¸Šä¸‹æ–‡å’Œè§£æå™¨ç­‰å…¶ä»–æ¦‚å¿µã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªå¿«é€ŸæŒ‡å—ï¼Œå¯ä»¥å¸®åŠ©ä½ å¿«é€Ÿå…¥é—¨<a href="https://blog.logrocket.com/intro-to-graphql-with-prisma/" target="_blank" rel="noopener noreferrer">Prisma graph QLç®€ä»‹</a>ã€‚</p>
<p>è®©æˆ‘ä»¬è¿è¡Œä¸‹é¢çš„ä»£ç æ¥å¿«é€Ÿè®¾ç½®ä¸€ä¸ªApolloæœåŠ¡å™¨ã€‚</p>
<pre>mkdir jwt-authentication
cd jwt-authentication

npm init --yes</pre>
<p>é¡¹ç›®ç›®å½•ç°åœ¨åŒ…å«ä¸€ä¸ª<code>package.json</code>æ–‡ä»¶ã€‚</p>
<pre>npm install apollo-server graphql
touch index.js</pre>
<p>ä¸ºäº†ä¿æŒç®€å•å’Œæ˜“äºç†è§£ï¼Œindex.jsåŒ…å«äº†è¶³å¤Ÿå¼•å¯¼åº”ç”¨ç¨‹åºçš„ä»£ç ã€‚</p>
<p>åœ¨æ‚¨å–œæ¬¢çš„ç¼–è¾‘å™¨ä¸­æ‰“å¼€<code>index.js</code>,ç„¶åç²˜è´´ä»¥ä¸‹ä»£ç :</p>
<pre>const { ApolloServer, gql } = require('apollo-server');
const typeDefs = gql`
type User {
name: String!
email: String!
id: Int
}
type Query {
users: [User]
}
`;
const users = [{
name: 'Harry Potter',
email: '<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0b636a7979724b7b647f7f6e7925686466">[emailÂ protected]</a>',
id: 23,},
{name: 'Jurassic Park',
email: '<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b0ddd9d3d8d1d5dcf0d3c2d9d3d8c4dfde9ed3dfdd">[emailÂ protected]</a>',
id: 34 }];

const resolvers = {
Query: {
users: () =&gt; users,
 },
};

const server = new ApolloServer({ typeDefs, resolvers });

server.listen().then(({ url }) =&gt; {
console.log(`ğŸš€  Server ready at ${url}`);
});</pre>
<p>è¿™åªæ˜¯ä¸ºäº†ç¡®ä¿æˆ‘ä»¬å·²ç»æ­£ç¡®è®¾ç½®äº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è®¾ç½®æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä½¿ç”¨Prismaä½œä¸ºORMçš„é€‰æ‹©ã€‚</p>
<figure id="attachment_8989" aria-describedby="caption-attachment-8989" class="wp-caption aligncenter"><img data-attachment-id="8989" data-permalink="https://blog.logrocket.com/jwt-authentication-with-apollo-server-2-tips-and-tricks/jwt-authentication-no-cdn-mov/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov.png" data-orig-size="895,475" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="JWT-authentication-no-cdn.mov" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov-300x159.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov.png" decoding="async" class="wp-image-8989 jetpack-lazy-image" src="../Images/76ec53974b8d95c48cd5ade8583061c2.png" alt="JWT authentication " data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov.png 895w, https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov-300x159.png 300w, https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov-768x408.png 768w" data-lazy-sizes="(max-width: 750px) 100vw, 750px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="8989" data-permalink="https://blog.logrocket.com/jwt-authentication-with-apollo-server-2-tips-and-tricks/jwt-authentication-no-cdn-mov/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov.png" data-orig-size="895,475" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="JWT-authentication-no-cdn.mov" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov-300x159.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov.png" decoding="async" loading="lazy" class="wp-image-8989" src="../Images/76ec53974b8d95c48cd5ade8583061c2.png" alt="JWT authentication " srcset="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov.png 895w, https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov-300x159.png 300w, https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov-768x408.png 768w" sizes="(max-width: 750px) 100vw, 750px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-authentication-no-cdn.mov.png"/></noscript><figcaption id="caption-attachment-8989" class="wp-caption-text">Output of running query on the user resolver.</figcaption></figure>
<p>è¦æƒ³æˆåŠŸï¼Œæ‚¨éœ€è¦å®‰è£…Dockeræ¥è¿è¡Œæ¥ä¸‹æ¥çš„æ­¥éª¤ã€‚</p>
<p>æˆ‘å°†ä½¿ç”¨PostgreSQLä½œä¸ºåœ¨Dockerä¸»æœºä¸Šé…ç½®çš„æ•°æ®åº“ã€‚</p>
<p>è®©æˆ‘ä»¬åœ¨é¡¹ç›®ç›®å½•çš„æ ¹ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤cd:</p>
<pre>mkdir prisma-client
npm install -g prisma
npm install prisma-client-lib
prisma init</pre>
<p>æˆ‘ä»¬å°†ä¾æ¬¡é€‰æ‹©ä»¥ä¸‹é€‰é¡¹:</p>
<pre>Create new database                  Set up a local database using Docker</pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€‰æ‹©ä»¥ä¸‹å†…å®¹:</p>
<pre>PostgreSQL        PostgreSQL database</pre>
<p>æˆ‘ä»¬è¿˜å°†é€‰æ‹©:</p>
<pre>Prisma JavaScript Client</pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆè®¾ç½®:</p>
<pre>docker-compose up -d &amp;&amp; prisma deploy</pre>
<p>æˆåŠŸè¿è¡Œè¿™ä¸ªå‘½ä»¤åï¼Œæˆ‘ä»¬å°†æœ‰å¿…è¦çš„æ–‡ä»¶æ¥å……å½“æˆ‘ä»¬çš„ORMï¼Œå®ƒæ˜¯ä»<code>datamodel.prisma</code>æ–‡ä»¶ç”Ÿæˆçš„ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨è¦åšçš„å°±æ˜¯å°†Prismaå®ä¾‹å¯¼å…¥åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ï¼Œè¿™æ ·å½“æˆ‘ä»¬è¿›è¡Œçªå˜æˆ–æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸çœŸå®çš„æ•°æ®åº“è€Œä¸æ˜¯è™šæ‹Ÿæ•°æ®è¿›è¡Œäº¤äº’ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡åœ¨index.jsä¸­è¦æ±‚è¿™ä¸ªæ–‡ä»¶æ¥åšåˆ°è¿™ä¸€ç‚¹:</p>
<pre>const { prisma } = require('./prisma-client/generated/prisma-client')</pre>
<p>æ—¢ç„¶æˆ‘ä»¬åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸å¯¹æˆ‘ä»¬çš„é¡¹ç›®åšä¸€ç‚¹è°ƒæ•´ã€‚</p>
<p>æˆ‘ä»¬å°†åˆ é™¤ä¸Šé¢ç¬¬12åˆ°18è¡Œä¸­å‡ºç°çš„ç”¨æˆ·å¯¹è±¡æ•°ç»„ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶â€” <code>schema.js</code>å’Œ<code>resolver.js</code>ã€‚</p>
<p>ä¸‹é¢æ˜¯æˆ‘ä»¬çš„<code>index.js</code>æ–‡ä»¶ç°åœ¨çš„æ ·å­:</p>
<pre>const { ApolloServer } = require('apollo-server');
const typeDefs = require('./schema.js');
const { prisma } = require('./prisma-client/generated/prisma-client')
const resolvers = require('./resolver');

const server = new ApolloServer({ 
  typeDefs, 
  resolvers,
  context : () =&gt; ({
    prisma
  })
 });
server.listen().then(({ url }) =&gt; {
  console.log(`ğŸš€  Server ready at ${url}`);
});</pre>
<p>æˆ‘ä»¬çš„<code>schema.js</code>æ–‡ä»¶ç°åœ¨çœ‹èµ·æ¥åƒè¿™æ ·:</p>
<pre>const { gql } = require('apollo-server');
const typeDefs = gql`
  type User {
    name: String!
    email: String!
    id: Int
  }
  type Query {
    users: [User]
  }
`;
module.exports = typeDefs;</pre>
<p>æˆ‘ä»¬çš„<code>resolvers.js</code>æ–‡ä»¶çœ‹èµ·æ¥åƒè¿™æ ·:</p>
<pre>const resolvers = {
  Query: {
    users: async (root, args, { prisma }, info) =&gt; { 
      try {
        return prisma.users();
      } catch (error) {
        throw error;
      }
    },
  },
};
module.exports = resolvers;</pre>
<p>é¡¹ç›®ç»“æ„å¦‚ä¸‹æ‰€ç¤º:</p>
<p><img data-attachment-id="9005" data-permalink="https://blog.logrocket.com/jwt-authentication-with-apollo-server-2-tips-and-tricks/prisma-client-nocdn/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2019/11/Prisma-client-nocdn.png" data-orig-size="169,287" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Prisma-client-nocdn" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2019/11/Prisma-client-nocdn.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2019/11/Prisma-client-nocdn.png" decoding="async" class="aligncenter wp-image-9005 jetpack-lazy-image" src="../Images/99dfd399c606179878f2852676d4388a.png" alt="Prisma client" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/11/Prisma-client-nocdn.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/11/Prisma-client-nocdn.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="9005" data-permalink="https://blog.logrocket.com/jwt-authentication-with-apollo-server-2-tips-and-tricks/prisma-client-nocdn/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2019/11/Prisma-client-nocdn.png" data-orig-size="169,287" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Prisma-client-nocdn" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2019/11/Prisma-client-nocdn.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2019/11/Prisma-client-nocdn.png" decoding="async" loading="lazy" class="aligncenter wp-image-9005" src="../Images/99dfd399c606179878f2852676d4388a.png" alt="Prisma client" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/11/Prisma-client-nocdn.png"/></noscript>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»è®¾ç½®å¥½äº†ï¼Œè®©æˆ‘ä»¬å¼€å§‹å®é™…çš„ç¼–ç ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦å®‰è£…ä¸€äº›åº“æ¥å¸®åŠ©æˆ‘ä»¬:</p>
<pre>npm i bcrypt jsonwebtoken
npm i nodemon -D</pre>
<p>ç„¶åæˆ‘ä»¬å°†æ‰“å¼€<code>package.json</code>å¹¶å°†è¿™ä¸€è¡Œæ·»åŠ åˆ°JSONæ–‡ä»¶çš„è„šæœ¬éƒ¨åˆ†:</p>
<pre>"dev": "nodemon index.js"</pre>
<p>è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å¯åŠ¨æœåŠ¡å™¨:</p>
<pre>npm run dev</pre>
<p>å®ƒè¿˜ç›‘å¬å¹¶é‡å¯åº”ç”¨ç¨‹åºï¼Œå³ä½¿æˆ‘ä»¬å¯¹æ–‡ä»¶åšäº†æ›´æ”¹ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»å»ºç«‹äº†é¡¹ç›®ï¼Œè®©æˆ‘ä»¬å¯¹æˆ‘ä»¬çš„<code>datamodel.prisma</code>æ–‡ä»¶åšä¸€äº›ä¿®æ”¹ã€‚</p>
<p>ç°åœ¨çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:</p>
<pre>type User {
  id: ID! @id
  email: String! @unique
  name: String!
  password: String!
}</pre>
<p>æˆ‘ä»¬éœ€è¦åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬çš„<code>prisma-schema.js</code>ä¿æŒæ›´æ–°:</p>
<pre>prisma deploy
prisma generated</pre>
<p>ç°åœ¨æˆ‘ä»¬çš„ORMæ–‡ä»¶å·²ç»æ›´æ–°äº†ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æˆ‘ä»¬çš„<code>schema.js</code>æ–‡ä»¶åšä¸€äº›æ”¹å˜ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬èƒ½å¤Ÿæ‰§è¡Œä¸€äº›çªå˜ï¼Œä¾‹å¦‚<code>signupUser</code>å’Œ<code>loginUser</code>ã€‚</p>
<p>è¿™æ˜¯æˆ‘ä»¬æ›´æ–°åçš„<code>schema.js</code>çš„æ ·å­:</p>
<pre>onst { gql } = require('apollo-server');
const typeDefs = gql`
  type User {
    name: String!
    email: String!
    password: String!
    id: Int
  }
type Mutation {
  signupUser(data: UserCreateInput!) : AuthPayLoad!
  loginUser(data: UserLoginInput!): AuthPayLoad!
}
input UserCreateInput {
  email: String!
  name: String!
  password: String!
}
input UserLoginInput {
  email: String!
  password: String!
}
type AuthPayLoad {
  token: String!
}
  type Query {
    users: [User]
  }
`;
module.exports = typeDefs;</pre>
<p>æˆ‘ä»¬è¦åšçš„ä¸‹ä¸€ä»¶äº‹æ˜¯åœ¨æˆ‘ä»¬çš„è§£æå™¨ä¸­å®é™…å®ç°å˜å¼‚å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®é™…æ³¨å†Œç”¨æˆ·å¹¶è®©ç”¨æˆ·ç™»å½•:</p>
<pre>const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');

const resolvers = {
  ......., 
  Mutation: {
    signupUser: async (root, args, { prisma }, info) =&gt; {
        const { data: { email, name, password } } = args;
        const newUser = await prisma.createUser({
          email,
          name,
          password: bcrypt.hashSync(password, 3)
        });
        return {token : jwt.sign(newUser, "supersecret")};
    },
    loginUser: async (root, args, { prisma }, info)  =&gt; {
      const { data: { email, password } } = args;
      const [ theUser ] = await prisma.users({
        where: {
          email
        }
      })
      if (!theUser) throw new Error('Unable to Login');
      const isMatch = bcrypt.compareSync(password, theUser.password);
      if (!isMatch) throw new Error('Unable to Login');
      return {token : jwt.sign(theUser, "supersecret")};
    }
  }
};</pre>
<p>ä¸‹é¢æ˜¯å¯¹è¿™äº›è§£æå™¨å‡½æ•°è¿›è¡Œå˜å¼‚åçš„è¾“å‡º:</p>
<p><img data-attachment-id="9015" data-permalink="https://blog.logrocket.com/jwt-authentication-with-apollo-server-2-tips-and-tricks/jwt-apollo-nocdn/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn.png" data-orig-size="984,455" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="JWT-Apollo-nocdn" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn-300x139.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn.png" decoding="async" class="aligncenter wp-image-9015 jetpack-lazy-image" src="../Images/d1cd2548cced74ac619c74b11d1d8676.png" alt="JWT authentication Apollo" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn.png 984w, https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn-300x139.png 300w, https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn-768x355.png 768w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn.png"/></p><noscript><img data-lazy-fallback="1" data-attachment-id="9015" data-permalink="https://blog.logrocket.com/jwt-authentication-with-apollo-server-2-tips-and-tricks/jwt-apollo-nocdn/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn.png" data-orig-size="984,455" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="JWT-Apollo-nocdn" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn-300x139.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn.png" decoding="async" loading="lazy" class="aligncenter wp-image-9015" src="../Images/d1cd2548cced74ac619c74b11d1d8676.png" alt="JWT authentication Apollo" srcset="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn.png 984w, https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn-300x139.png 300w, https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn-768x355.png 768w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/11/JWT-Apollo-nocdn.png"/></noscript><br/>
<img data-attachment-id="9016" data-permalink="https://blog.logrocket.com/jwt-authentication-with-apollo-server-2-tips-and-tricks/login-user-nocdn/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn.png" data-orig-size="1003,463" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="login-user-nocdn" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn-300x138.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn.png" decoding="async" class="aligncenter wp-image-9016 jetpack-lazy-image" src="../Images/c120105c172685ff8b65846f04e52998.png" alt="User log-in" data-lazy-srcset="https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn.png 1003w, https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn-300x138.png 300w, https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn-768x355.png 768w" data-lazy-sizes="(max-width: 730px) 100vw, 730px" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn.png"/><noscript><img data-lazy-fallback="1" data-attachment-id="9016" data-permalink="https://blog.logrocket.com/jwt-authentication-with-apollo-server-2-tips-and-tricks/login-user-nocdn/" data-orig-file="https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn.png" data-orig-size="1003,463" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="login-user-nocdn" data-image-description="" data-image-caption="" data-medium-file="https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn-300x138.png" data-large-file="https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn.png" decoding="async" loading="lazy" class="aligncenter wp-image-9016" src="../Images/c120105c172685ff8b65846f04e52998.png" alt="User log-in" srcset="https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn.png 1003w, https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn-300x138.png 300w, https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn-768x355.png 768w" sizes="(max-width: 730px) 100vw, 730px" data-original-src="https://blog.logrocket.com/wp-content/uploads/2019/11/login-user-nocdn.png"/></noscript>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»æˆåŠŸåœ°åˆ›å»ºäº†ä¸€ä¸ªä»¤ç‰Œæ¥å­˜å‚¨ç”¨æˆ·çš„èº«ä»½ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æˆäºˆç”¨æˆ·å¯¹æ•°æ®åº“ä¸­æŸäº›å—ä¿æŠ¤èµ„æºçš„è®¿é—®æƒä¹‹å‰éªŒè¯è¿™ä¸ªç”¨æˆ·çš„èº«ä»½ã€‚</p>
<p>ä¸ºäº†æœ‰æ•ˆåœ°åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»ä¿®æ”¹åœ¨å¼•å¯¼åº”ç”¨ç¨‹åºæ—¶å£°æ˜çš„ä¸Šä¸‹æ–‡å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿå°†æ ‡è¯†ç”¨æˆ·çš„ä»¤ç‰Œä»å®¢æˆ·ç«¯ä¼ é€’åˆ°æœåŠ¡å™¨ã€‚</p>
<p>æˆ‘ä»¬å°†é€šè¿‡å‘ä¸Šä¸‹æ–‡å‡½æ•°ä¼ é€’ä¸€ä¸ªè¯·æ±‚å‚æ•°æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨æˆ‘ä»¬çš„è§£æå™¨ä¸­ä½¿ç”¨å®ƒ:</p>
<pre>.....
context : req =&gt; ({
    prisma,
    req
  })
.....</pre>
<p>ç°åœ¨è®©æˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º<code>authenticate.js</code>çš„æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å°†å¤„ç†ç”¨æˆ·åœ¨è®¿é—®å—ä¿æŠ¤çš„è·¯ç”±æ—¶æ˜¯å¦ç™»å½•ã€‚</p>
<pre>touch decodedToken.js
cd decodedToken.js</pre>
<p>åœ¨<code>decodedToken.js</code>ä¸­ï¼Œæˆ‘ä»¬å°†ç®€å•åœ°æ ¹æ®æˆ‘ä»¬çš„ç§˜å¯†éªŒè¯ç”¨æˆ·çš„ä»¤ç‰Œï¼Œä»¥ç¡®å®šä»–ä»¬çš„èº«ä»½ï¼Œå¹¶è®©ä»–ä»¬ç™»å½•æˆ–ç”¨é€‚å½“çš„æ¶ˆæ¯è¿›è¡Œå“åº”ã€‚</p>
<pre>const jwt = require('jsonwebtoken');
const decodedToken = (req, requireAuth = true) =&gt; {
  const header =  req.req.headers.authorization;
    
  if (header){
    const token = header.replace('Bearer ', '');
    const decoded = jwt.verify(token, 'supersecret');
    return decoded;
  }
  if (requireAuth) {
    throw new Error('Login in to access resource');
  } 
  return null
}
module.exports = { decodedToken }</pre>
<p>å‡ºäºæµ‹è¯•ç›®çš„ï¼Œæˆ‘ä»¬å°†é€šè¿‡localhost 4000çš„graphQL playgroundä¸­çš„HTTP HEADERSéƒ¨åˆ†æä¾›æˆ‘ä»¬çš„ç™»å½•ä»¤ç‰Œã€‚</p>
<p>è¦æ‰§è¡Œè¿”å›æ‰€æœ‰ç”¨æˆ·çš„æŸ¥è¯¢æ“ä½œï¼Œæ‚¨éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ã€‚æˆ‘ä»¬å°†ä¿®æ”¹æˆ‘ä»¬çš„<code>resolvers.js</code>æ–‡ä»¶æ¥åæ˜ è¿™äº›å˜åŒ–ã€‚</p>
<p>æ‰“å¼€<code>resolvers.js</code>å¹¶è¿›è¡Œä»¥ä¸‹æ›´æ”¹:</p>
<pre>....
const { decodedToken } = require('./decodedToken');

....
 Query: {
    users: async (root, args, { prisma, req }, info) =&gt; { 
        const decoded = decodedToken(req);
        return prisma.users();
    },
  },
.....</pre>
<p>æˆ‘ä»¬å·²ç»æˆåŠŸåœ°è®¤è¯äº†ä¸€ä¸ªç”¨æˆ·ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦ä½¿æˆ‘ä»¬çš„<code>decodedToken.js</code>æ›´åŠ é€šç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒè¿›è¡Œæˆæƒã€‚</p>
<p>è¿™æ˜¯æˆ‘ä»¬æ›´æ–°åçš„<code>decodedToken.js</code>ç°åœ¨çš„æ ·å­:</p>
<pre>const jwt = require('jsonwebtoken');
const decodedToken = (req, requireAuth = true) =&gt; {
  const header =  req.req.headers.authorization;
    
  if (header){
    const token = header.replace('Bearer ', '');
    const decoded = jwt.verify(token, 'supersecret');
    return decoded;
  }
  if (requireAuth) {
    throw new Error('Login in to access resource');
  } 
  return null
}
module.exports = { decodedToken }</pre>
<p>å¦‚æœä½ é™·å…¥å›°å¢ƒæˆ–è€…éœ€è¦å‚è€ƒèµ„æ–™æ¥ç¼–å†™ä»£ç ï¼Œè¿™é‡Œæœ‰æ‰˜ç®¡åœ¨github ä¸Šçš„æ–‡ä»¶ã€‚</p>
<h3>ç»“è®º</h3>
<p>æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†éªŒè¯ç”¨æˆ·èº«ä»½çš„ç»†èŠ‚ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€äº›æˆ‘ä»¬æ²¡æœ‰æåˆ°çš„äº‹æƒ…:</p>
<ul>
<li>æ­¤ç±»ç”¨æˆ·å³ä½¿åœ¨èº«ä»½å¾—åˆ°éªŒè¯åä»å°†æ‹¥æœ‰çš„è®¿é—®æƒé™ï¼Œæ¢å¥è¯è¯´ï¼Œè¯¥ç”¨æˆ·æ˜¯ç¼–è¾‘ã€å‘å¸ƒè€…è¿˜æ˜¯æ¥å®¾ã€‚</li>
<li>é€šè¿‡æŸ¥è¯¢å…³ç³»æ¥ä¿æŠ¤æ•°æ®ï¼Œç­‰ç­‰ã€‚</li>
</ul>
<p>æœ¬æ–‡åªæ˜¯è®©æ‚¨åœ¨ApolloæœåŠ¡å™¨ä¸Šä½¿ç”¨JWTè¿›è¡Œèº«ä»½éªŒè¯çš„å¼€èƒƒèœã€‚</p><div class="code-block code-block-2">
<div class="blog-plug base-cta"><h2>ä½¿ç”¨<a class="signup" href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>æ¶ˆé™¤ä¼ ç»Ÿé”™è¯¯æŠ¥å‘Šçš„å¹²æ‰°</h2>
<a href="https://lp.logrocket.com/blg/signup" class="signup" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-46 jetpack-lazy-image" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-lazy-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png?is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/><noscript><img data-lazy-fallback="1" class="alignnone size-full wp-image-46" src="../Images/d6f5a5dd739296c1dd7aab3d5e77eeb9.png" alt="LogRocket Dashboard Free Trial Banner" data-original-src="https://blog.logrocket.com/wp-content/uploads/2017/03/1d0cd-1s_rmyo6nbrasp-xtvbaxfg.png"/></noscript></a>
<p><a href="https://lp.logrocket.com/blg/signup" target="_blank" rel="noopener noreferrer"> LogRocket </a>æ˜¯ä¸€ä¸ªæ•°å­—ä½“éªŒåˆ†æè§£å†³æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥ä¿æŠ¤æ‚¨å…å—æ•°ç™¾ä¸ªå‡é˜³æ€§é”™è¯¯è­¦æŠ¥çš„å½±å“ï¼Œåªé’ˆå¯¹å‡ ä¸ªçœŸæ­£é‡è¦çš„é¡¹ç›®ã€‚LogRocketä¼šå‘Šè¯‰æ‚¨åº”ç”¨ç¨‹åºä¸­å®é™…å½±å“ç”¨æˆ·çš„æœ€å…·å½±å“åŠ›çš„bugå’ŒUXé—®é¢˜ã€‚</p>
<p>ç„¶åï¼Œä½¿ç”¨å…·æœ‰æ·±å±‚æŠ€æœ¯é¥æµ‹çš„ä¼šè¯é‡æ”¾æ¥ç¡®åˆ‡åœ°æŸ¥çœ‹ç”¨æˆ·çœ‹åˆ°äº†ä»€ä¹ˆä»¥åŠæ˜¯ä»€ä¹ˆå¯¼è‡´äº†é—®é¢˜ï¼Œå°±åƒä½ åœ¨ä»–ä»¬èº«åçœ‹ä¸€æ ·ã€‚</p>
<p>LogRocketè‡ªåŠ¨èšåˆå®¢æˆ·ç«¯é”™è¯¯ã€JSå¼‚å¸¸ã€å‰ç«¯æ€§èƒ½æŒ‡æ ‡å’Œç”¨æˆ·äº¤äº’ã€‚ç„¶åLogRocketä½¿ç”¨æœºå™¨å­¦ä¹ æ¥å‘Šè¯‰ä½ å“ªäº›é—®é¢˜æ­£åœ¨å½±å“å¤§å¤šæ•°ç”¨æˆ·ï¼Œå¹¶æä¾›ä½ éœ€è¦ä¿®å¤å®ƒçš„ä¸Šä¸‹æ–‡ã€‚</p>
<p>å…³æ³¨é‡è¦çš„bugâ€”<a class="signup" href="https://lp.logrocket.com/blg/signup-issue-free" target="_blank" rel="noopener noreferrer">ä»Šå¤©å°±è¯•è¯•LogRocketã€‘ã€‚</a></p></div></div>

<p class="clearfix"/>
<p class="clearfix"/>
</article>

</div>    
</body>
</html>