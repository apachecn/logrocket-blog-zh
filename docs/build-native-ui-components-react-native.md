# åœ¨ React Native - LogRocket åšå®¢ä¸­æ„å»ºåŸç”Ÿ UI ç»„ä»¶

> åŸæ–‡ï¼š<https://blog.logrocket.com/build-native-ui-components-react-native/>

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†äº†è§£ä»€ä¹ˆæ˜¯åŸç”Ÿ UI ç»„ä»¶ï¼Œä»¥åŠå¦‚ä½•åœ¨ React Native ä¸­æ„å»ºå’Œä½¿ç”¨å®ƒä»¬ã€‚

å¦‚æœæ‚¨æƒ³å°†ç°æœ‰çš„åŸç”Ÿ Java æˆ– Objective-C ç»„ä»¶è½¬æ¢ä¸º React åŸç”Ÿç»„ä»¶ï¼ŒåŒæ—¶é‡ç”¨æ‚¨çš„åŸç”Ÿä»£ç é€»è¾‘ï¼Œé‚£ä¹ˆåŸç”Ÿ UI ç»„ä»¶æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹å§ã€‚

## ä»€ä¹ˆæ˜¯ React Nativeï¼Ÿ

React Native æ˜¯ç”±è„¸ä¹¦åˆ›å»ºå’Œç»´æŠ¤çš„ JavaScript æ¡†æ¶ï¼Œç”¨äºå¼€å‘æœ¬åœ°å‘ˆç°çš„ç§»åŠ¨åº”ç”¨ç¨‹åºã€‚å®ƒåŸºäº Reactï¼Œè¿™æ˜¯ä¸€ä¸ª JavaScript åº“ï¼Œç”¨äºä¸º web æµè§ˆå™¨æ„å»ºç”¨æˆ·ç•Œé¢ã€‚

[React Native](https://blog.logrocket.com/tag/react-native/) ä¸ä»…ä»…å±€é™äºæ‰‹æœº appã€‚æˆ‘ä»¬è¿˜å¯ä»¥å€ŸåŠ©åƒ [react-native-windows](https://microsoft.github.io/react-native-windows/) è¿™æ ·çš„ç¬¬ä¸‰æ–¹åº“ï¼Œç”¨ React Native å¼€å‘ macOS å’Œ Windows æ¡Œé¢åº”ç”¨ã€‚

## React Native ä¸­çš„åŸç”Ÿ UI ç»„ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨å¹•åï¼ŒReact Native ä½¿ç”¨ iOS ä¸­çš„æœ¬æœºç»„ä»¶ï¼Œå¦‚`UIView`å’Œ`UIImageView`ï¼Œå¹¶å°†å®ƒä»¬å¯¼å‡ºåˆ° JavaScript å±‚ã€‚æˆ‘ä»¬åœ¨æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨è¿™äº›ç»„ä»¶ã€‚

ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬åœ¨ JSX ä½¿ç”¨`View`ç»„ä»¶æ—¶ï¼Œæˆ‘ä»¬åœ¨ JavaScript ä»£ç ä¸­ä½¿ç”¨æ¥è‡ª iOS çš„`UIView`ã€‚åŒæ ·ï¼Œå¯¹äº`Image`ç»„ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ iOS ä¸­çš„`UIImage`ç»„ä»¶ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨ React Native ä¸­ä½¿ç”¨çš„æ‰€æœ‰ç»„ä»¶éƒ½æœ‰ä¸€ä¸ªæœ¬æœºå£°æ˜ã€‚

React Native å·²ç»åŒ…è£…äº†æ‰€æœ‰ä¸»è¦çš„å’Œå¹¿æ³›ä½¿ç”¨çš„ UI ç»„ä»¶ï¼Œæ¯”å¦‚`[ScrollView](https://blog.logrocket.com/common-bugs-react-native-scrollview/)`ã€`Button`å’Œ`Switch`ã€‚

ä½†æ˜¯ï¼Œå¦‚æœç»„ä»¶æ²¡æœ‰è¢«åŒ…è£…ï¼Œæˆ–è€…ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦é‡ç”¨æˆ‘ä»¬ä¸ºæœ¬åœ°åº”ç”¨ç¨‹åºæ„å»ºçš„è‡ªå®šä¹‰æœ¬åœ°ç»„ä»¶ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åŒ…è£…è¿™äº›ç»„ä»¶æ¥åˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„ UI ç»„ä»¶ã€‚

## åœ¨ React Native ä¸­è®¾ç½®é¡¹ç›®

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º`CameraView`çš„åŸç”Ÿ UI ç»„ä»¶ï¼Œå®ƒå°†æ¥è‡ªè®¾å¤‡æ‘„åƒå¤´çš„å®æ—¶æ‘„åƒå¤´é¦ˆé€å‘ˆç°åˆ° UIã€‚å®ƒè¿˜ä¼šä»ç›¸æœºä¸­æ•æ‰å›¾åƒï¼Œå¹¶å°†å®ƒä»¬ä¿å­˜åˆ°ç”¨æˆ·çš„è®¾å¤‡ä¸­ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°[å…¨å›è´­](https://github.com/hrupesh/RN-Native-UI-Components)ã€‚

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç±»ä¼¼äºä¸‹é¢ç»™å‡ºçš„ç”¨æˆ·ç•Œé¢:

![iOS UI](img/a061a8f617ed88ea2a0e7f9533b429fa.png)

iOS UI

![Android UI](img/e92a8ada6d924d67cf916c577f9e8fef.png)

Android UI

> å¦‚æœä½ åªæ˜¯æ¥çœ‹ä»£ç çš„ï¼Œé‚£ä¹ˆä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ä»£ç ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè£¸éœ²çš„ React åŸç”Ÿé¡¹ç›®ã€‚æ‰“å¼€æ‚¨çš„ç»ˆç«¯ï¼Œå°†å½“å‰å·¥ä½œç›®å½•æ›´æ”¹ä¸ºæ‚¨çš„é¦–é€‰æ–‡ä»¶å¤¹ã€‚åœ¨é‚£é‡Œï¼Œé”®å…¥ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ React æœ¬åœ°é¡¹ç›®:

```
react-native init <your-project-name>

```

æˆ–è€…ï¼Œå¦‚æœæ‚¨æƒ³è¦ä½¿ç”¨ React Native çš„ç‰¹å®šç‰ˆæœ¬åˆ›å»ºé¡¹ç›®ï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨å‘½ä»¤ä¸­æ·»åŠ ç‰ˆæœ¬æ ‡å¿—æ¥å®ç°:

```
react-native init <your-project-name> --version 0.63.0

```

ç°åœ¨ï¼Œè¿›å…¥æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ–°é¡¹ç›®çš„ç›®å½•ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä¸º iOS åº”ç”¨ç¨‹åºå®‰è£… pods:

```
cd ios
pod install

```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬è¿è¡Œåº”ç”¨ç¨‹åºï¼

æˆ‘ä»¬å°†é€šè¿‡ [XCode](https://developer.apple.com/xcode/) å’Œ [Android studio](https://developer.android.com/studio) è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ï¼Œåœ¨ finder ä¸­è¿›å…¥é¡¹ç›®çš„ iOS ç›®å½•:

![Reveal Finder](img/ed1c0e53ea4d024e25bf08db47839b24.png)

åœ¨ iOS ç›®å½•ä¸­ï¼Œæ‚¨ä¼šçœ‹åˆ°ä¸€ä¸ª`<your-project-name>.xc`å·¥ä½œåŒºæ–‡ä»¶ã€‚æ‰“å¼€å®ƒã€‚

![Workspace File](img/3dd4948ab69db2de2f517c51049bd6da.png)

å¦‚æœæ‚¨å·²å°† iOS è®¾å¤‡æ­£ç¡®è¿æ¥åˆ°ç³»ç»Ÿï¼Œæ‚¨åº”è¯¥ä¼šåœ¨ XCode çª—å£ä¸­çœ‹åˆ°æ‚¨çš„è®¾å¤‡åç§°ã€‚è¦åœ¨æ‚¨çš„è®¾å¤‡ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºï¼Œè¯·é€‰æ‹©æ‚¨çš„è®¾å¤‡å¹¶å•å‡»**æ’­æ”¾**æŒ‰é’®æ¥æ„å»ºå¹¶è¿è¡Œåº”ç”¨ç¨‹åºã€‚

æ„å»ºæˆåŠŸåï¼Œæ‚¨å°†åœ¨åº”ç”¨ç¨‹åºä¸­çœ‹åˆ°ä¸€äº›æ ·æ¿ç”¨æˆ·ç•Œé¢ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Android è®¾å¤‡ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºã€‚

æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åœ¨ Android studio ä¸­æ‰“å¼€æ‚¨çš„ Android é¡¹ç›®:

*   æ‰“å¼€ Android Studio
*   ç‚¹å‡»**è¿›å…¥æ–‡ä»¶**ï¼Œç„¶å**æ‰“å¼€**
    ![Open](img/8c729ce50f3aaa2b4c4167a5beed0e70.png)
*   åœ¨é¡¹ç›®çš„ Android æ–‡ä»¶å¤¹ä¸­ï¼Œç‚¹å‡»**æ‰“å¼€**
    ![Android Folder](img/a45aefafd6863e36bc5c99ee3db662fc.png)
*   åœ¨ Android studio çª—å£é¡¶éƒ¨é€‰æ‹©ä½ çš„è®¾å¤‡ï¼Œç‚¹å‡»**æ’­æ”¾**å¼€å§‹æ„å»º
    ![Play to Start](img/6f9f780d82634d90df0e84a18e6ea3cc.png)

ä¸€æ—¦åº”ç”¨ç¨‹åºè¿è¡Œï¼Œæ‚¨å°†çœ‹åˆ°ä¸€ä¸ªç±»ä¼¼äº iOS ä¸­çš„ UIï¼Œè¿™æ˜¯ React åŸç”Ÿé¡¹ç›®çš„é»˜è®¤æ ·æ¿ä»£ç ã€‚

æˆ‘ä»¬ç°åœ¨å·²ç»æˆåŠŸåœ°åœ¨ iOS å’Œ Android ä¸Šè¿è¡Œäº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

## ä¸º Android å’Œ iOS åˆ›å»ºé€šç”¨çš„åŸç”Ÿç”¨æˆ·ç•Œé¢

è¦ä¸º Android å’Œ iOS åˆ›å»ºä¸€ä¸ªé€šç”¨çš„åŸç”Ÿ UI ç»„ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ä» JavaScript ä¿®æ”¹ä¸¤ä¸ªæ–‡ä»¶:

é¦–å…ˆï¼Œåˆ é™¤`App.js`ä¸­çš„æ ·æ¿ JS å’Œ JSX ä»£ç ã€‚

```
import React from 'react';
import { View, StyleSheet } from 'react-native';

const App = () => {
  return (
    <View style={styles.container} />
  );
};

const styles = StyleSheet.create({
  flex: 1,
  backgroundColor: 'white'
});

export default App;

```

ç›®å‰ï¼Œè¿™æ˜¯æˆ‘ä»¬å”¯ä¸€éœ€è¦ä¿®æ”¹çš„ä»£ç ã€‚è®©æˆ‘ä»¬ä» Java ä»£ç å¼€å§‹ç¼–å†™ï¼Œä¸º Android åˆ›å»º`CameraView`ç»„ä»¶ã€‚

## åˆ›å»º Android åŸç”Ÿ UI ç»„ä»¶

æ ¹æ® React Native çš„å®˜æ–¹[æ–‡æ¡£](https://reactnative.dev/docs/native-components-android)ï¼Œåˆ›å»ºä¸€ä¸ª Android UI ç»„ä»¶æœ‰äº”ä¸ªæ­¥éª¤:

*   åˆ›å»º`ViewManager`å­ç±»
*   å®ç°`createViewInstance`æ–¹æ³•
*   ä½¿ç”¨`@ReactProp`(æˆ–`@ReactPropGroup`)æ³¨é‡Šå…¬å¼€è§†å›¾å±æ€§è®¾ç½®å™¨ã€‚**æ³¨æ„:**æˆ‘ä»¬ä¸ä¼šä½¿ç”¨è¿™äº›
*   åœ¨åº”ç”¨ç¨‹åºåŒ…çš„`createViewManagers`ä¸­æ³¨å†Œç®¡ç†å™¨
*   å®ç° JavaScript æ¨¡å—

çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œå¯¹å§ï¼Ÿ

ç°åœ¨ï¼Œåˆ‡æ¢åˆ° Android Studio çª—å£ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ‰©å±•äº†`ViewManger`å­ç±»çš„ Java ç±»ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å¸¦æœ‰ç±»å‹`TextureView`çš„`SimpleViewManager`ç±»ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥å‘ˆç°æˆ‘ä»¬çš„æ‘„åƒæœºé¦ˆé€ã€‚

åœ¨å­èœå•ä¸­ç‚¹å‡»**æ–‡ä»¶**ã€**æ–°å»ºã€**ç„¶å **Java ç±»**:

![Java Class](img/7f1b5a252d19e31f1314036d583acb26.png)

ç„¶åä¼šæç¤ºæ‚¨å¡«å†™æ–° Java ç±»çš„ç±»åã€‚

![Class Name](img/7f5563d05de2ba710ed6236da1c74b38.png)

åœ¨æ–‡ä»¶åå†…é”®å…¥`RNCSTMCameraManager`ï¼ŒæŒ‰**é”®è¿›å…¥**ã€‚ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæ–°çš„ Java ç±»ï¼Œæˆ‘ä»¬éœ€è¦ç”¨`SimpleViewManager`ç±»æ¥æ‰©å±•å®ƒã€‚

æˆ‘ä»¬å°†ä»å®ƒåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œåœ¨ React Native ä¸­ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬éœ€è¦åœ¨`getName()`æ–¹æ³•ä¸­ç»™å®ƒä¸€ä¸ªåç§°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä» JavaScript è®¿é—®è¿™ä¸ªè§†å›¾ã€‚

ä¸‹é¢æ˜¯æ‚¨çš„`RNCSTMCameraManager.java`æ–‡ä»¶çš„æ ·å­:

```
/** All the imports will be here */

public class RNCSTMCameraManager extends SimpleViewManager<TextureView> {

    public static final String REACT_CLASS = "RNCSTMCamera";
    public static final String ComponentTag = "RNCSTMCamera";
    ReactApplicationContext mCallerContext;
    TextureView textureView;

    public RNCSTMCameraManager(ReactApplicationContext reactContext) {
        mCallerContext = reactContext;
        textureView = new TextureView(reactContext);
    }

    @Override
    public String getName() {
        return REACT_CLASS;
    }
}

```

æˆ‘ä»¬æ·»åŠ äº†å››ä¸ªå…¨å±€å˜é‡:

1.  `REACT_CLASS`:åœ¨ JS ä»£ç ä¸­æˆ‘ä»¬çš„ç»„ä»¶å°†è¢«è®¿é—®çš„åå­—ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å…¶å‘½åä¸º`RNCSTMCamera`
2.  `ComponentTag`:ä¸€ä¸ªæ ‡ç­¾åï¼Œç”¨æ¥æ‰“å°åœ¨æ—¥å¿—ä¸­ï¼Œä»¥ä¾¿äºè·Ÿè¸ªå’Œè°ƒè¯•æˆ‘ä»¬çš„ä»£ç 
3.  `mCallerContext`:åœ¨ [Android](https://developer.android.com/reference/android/content/Context) ä¸­ï¼Œä¸Šä¸‹æ–‡è¢«ç”¨æ¥è®¿é—®å„ç§åº•å±‚åŸç”Ÿç‰¹æ€§ã€‚ä¸ºäº†è®¿é—®è¿™äº›ç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåä¸º`ReactApplicationContext`çš„ä¸Šä¸‹æ–‡
4.  `textureView`:æˆ‘ä»¬å°†è¿”å›åˆ° JavaScript çš„è§†å›¾ï¼Œè¿™æ˜¯å°†æ˜¾ç¤ºæˆ‘ä»¬çš„å®æ—¶æ‘„åƒæœºé¦ˆé€çš„è§†å›¾

æˆ‘ä»¬ç°åœ¨éœ€è¦å®ç°`createViewInstance`æ–¹æ³•ï¼Œå®ƒè´Ÿè´£è¿”å›ä¸€ä¸ªæˆ‘ä»¬å°†åœ¨ UI ä¸Šæ˜¾ç¤ºçš„`View`ã€‚

```
@Override
public TextureView createViewInstance(ThemedReactContext context) {
    return textureView;
}

```

æˆ‘ä»¬çš„åŸç”Ÿ UI ç»„ä»¶å°†å‘ˆç°ä¸€ä¸ª`TextureView`ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰å‘å®ƒæ·»åŠ ä»»ä½•å±æ€§æˆ–æ ·å¼ï¼Œæ‰€ä»¥å®ƒå°†æ˜¾ç¤ºä¸ºä¸€ä¸ªç©ºç™½çš„ç™½è‰²å±å¹•ã€‚

## åœ¨`TextureView`ä¸­é¢„è§ˆç›´æ’­

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦è®¿é—®è®¾å¤‡æ‘„åƒå¤´å¹¶åœ¨`TextureView`ä¸­è¿”å›å®æ—¶æè¦ï¼Œä»¥åŠæ·»åŠ å›¾åƒæ•æ‰åŠŸèƒ½ã€‚ä½†æ˜¯åœ¨ç»§ç»­ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æˆ‘ä»¬çš„`AndroidManifest.xml`æ–‡ä»¶åšä¸€äº›ä¿®æ”¹ã€‚æˆ‘ä»¬éœ€è¦æƒé™æ¥:

*   æ‰“å¼€æ‘„åƒæœº
*   ä»è®¾å¤‡å­˜å‚¨å™¨å†™å…¥å’Œè¯»å–
*   å½•åˆ¶è§†é¢‘è®¾å¤‡éŸ³é¢‘
*   åœ¨æ²¡æœ‰å¤–éƒ¨å­˜å‚¨å¡çš„è®¾å¤‡ä¸Šå†™å…¥å¤–éƒ¨å­˜å‚¨å™¨ï¼Œæˆ‘ä»¬éœ€è¦è®¿é—®å®ƒä»¬çš„`LegacyExternalStorage`æ–‡ä»¶

è®©æˆ‘ä»¬å°†è¿™äº›æƒé™æ·»åŠ åˆ°`AndroidManifest.xml`çš„`manifest`æ ‡ç­¾ä¸­ã€‚

```
<uses-permission Android:name="Android.permission.CAMERA" />
<uses-feature Android:name="Android.hardware.camera2.full" />
<uses-permission Android:name="Android.permission.READ_EXTERNAL_STORAGE" />
<uses-permission Android:name="Android.permission.WRITE_EXTERNAL_STORAGE" />
<uses-permission Android:name="Android.permission.RECORD_AUDIO" />

```

ç„¶åå°†è¯¥å±æ€§æ·»åŠ åˆ°`application`æ ‡ç­¾ä¸­:

```
Android:requestLegacyExternalStorage="true"

```

æˆ‘ä»¬çš„`AndroidManifest.xml`æ–‡ä»¶ç°åœ¨åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚

![Androidmanifest File](img/381ca6df519315c4211745df99b515bb.png)

åœ¨æˆ‘ä»¬å®ç°äº†è¿™äº›æ›´æ”¹ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™é€»è¾‘æ¥è®¿é—®è®¾å¤‡æ‘„åƒå¤´å¹¶åœ¨`TextureView`ä¸­è¿”å›å®ƒçš„ feedï¼Œä»¥ä¾¿èƒ½å¤Ÿæ•è·å›¾åƒå¹¶ä¿å­˜å®ƒã€‚

è¯¥æ–‡ä»¶å°†å¦‚ä¸‹æ‰€ç¤º:

```
/** All the imports will go here */

public class RNCSTMCameraManager extends SimpleViewManager<TextureView> {

    public static final String REACT_CLASS = "RNCSTMCamera";
    public static final String ComponentTag = "RNCSTMCamera";
    public final int CAPTURE_COMMAND = 1111;
    ReactApplicationContext mCallerContext;
    TextureView textureView;

    public String cameraId;
    CameraDevice cameraDevice;
    CameraCaptureSession cameraCaptureSession;
    CaptureRequest captureRequest;
    CaptureRequest.Builder captureRequestBuilder;

    private Size imageDimensions;
    private ImageReader imageReader;
    private File file;
    Handler mBackgroundHandler;
    HandlerThread mBackgroundThread;

    TextureView.SurfaceTextureListener textureListener = new TextureView.SurfaceTextureListener() {
        @Override
        public void onSurfaceTextureAvailable(@NonNull SurfaceTexture surface, int width, int height) {
            try {
                openCamera();
            } catch (CameraAccessException e) {
                Log.d(ComponentTag, "Error in onSurfaceTextureAvailable:"+e);
            }
        }

        @Override
        public void onSurfaceTextureSizeChanged(@NonNull SurfaceTexture surface, int width, int height) {

        }

        @Override
        public boolean onSurfaceTextureDestroyed(@NonNull SurfaceTexture surface) {
            return false;
        }

        @Override
        public void onSurfaceTextureUpdated(@NonNull SurfaceTexture surface) {

        }
    };

    public RNCSTMCameraManager(ReactApplicationContext reactContext) {
        mCallerContext = reactContext;
        textureView = new TextureView(reactContext);
        if(checkCameraHardware(reactContext))  getCameraPermissions(reactContext);
    }

    @Override
    public String getName() {
        return REACT_CLASS;
    }

    /** Check if this device has a camera */
    private boolean checkCameraHardware(Context context) {
        if (context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_CAMERA)){
            // this device has a camera
            return true;
        } else {
            // no camera on this device
            return false;
        }
    }

    private void getCameraPermissions(Context context) {
        if (ContextCompat.checkSelfPermission(context, Manifest.permission.CAMERA)
                == PackageManager.PERMISSION_DENIED){
            ActivityCompat.requestPermissions(mCallerContext.getCurrentActivity(), new String[] {Manifest.permission.CAMERA}, 100);
        }
    }

    private final CameraDevice.StateCallback stateCallback = new CameraDevice.StateCallback() {
        @Override
        public void onOpened(@NonNull CameraDevice camera) {
            cameraDevice = camera;
            try {
                createCameraPreview();
            } catch (CameraAccessException e) {
                Log.d(ComponentTag, "Error in onOpened:"+e);
            }
        }

        @Override
        public void onDisconnected(@NonNull CameraDevice camera) {
            cameraDevice.close();
        }

        @Override
        public void onError(@NonNull CameraDevice camera, int error) {
            cameraDevice.close();
            cameraDevice = null;
        }
    };

    private void createCameraPreview() throws CameraAccessException {
        SurfaceTexture surfaceTexture = textureView.getSurfaceTexture();
        surfaceTexture.setDefaultBufferSize(imageDimensions.getWidth(),imageDimensions.getHeight());
        Surface surface = new Surface(surfaceTexture);
        captureRequestBuilder = cameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);
        captureRequestBuilder.addTarget(surface);

        cameraDevice.createCaptureSession(Arrays.asList(surface), new CameraCaptureSession.StateCallback() {
            @Override
            public void onConfigured(@NonNull CameraCaptureSession session) {
                if(cameraDevice == null) return;
                cameraCaptureSession = session;
                try {
                    updatePreview();
                } catch (CameraAccessException e) {
                    e.printStackTrace();
                }
            }

            @Override
            public void onConfigureFailed(@NonNull CameraCaptureSession session) {
                Log.d(ComponentTag, "onConfigure failed");
            }
        }, null);
    }

    private void updatePreview() throws CameraAccessException {
        if(cameraDevice == null) return;
        captureRequestBuilder.set(CaptureRequest.CONTROL_MODE, CameraMetadata.CONTROL_MODE_AUTO);
        cameraCaptureSession.setRepeatingRequest(captureRequestBuilder.build(),null, mBackgroundHandler);
    }

    private  void openCamera() throws CameraAccessException {
        Log.d(ComponentTag, "Open Camera was called from onSurface Available");
        CameraManager cameraManager = (CameraManager) mCallerContext.getSystemService(Context.CAMERA_SERVICE);
        cameraId = cameraManager.getCameraIdList()[1];
        CameraCharacteristics cameraCharacteristics = cameraManager.getCameraCharacteristics(cameraId);
        StreamConfigurationMap map = cameraCharacteristics.get(CameraCharacteristics.SCALER_STREAM_CONFIGURATION_MAP);
        imageDimensions = map.getOutputSizes(SurfaceTexture.class)[0];

        if(ActivityCompat.checkSelfPermission(mCallerContext, Manifest.permission.CAMERA) != PackageManager.PERMISSION_GRANTED){
            ActivityCompat.requestPermissions(mCallerContext.getCurrentActivity(), new String[] { Manifest.permission.CAMERA }, 101);
        }
        if(ActivityCompat.checkSelfPermission(mCallerContext, Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED){
            ActivityCompat.requestPermissions(mCallerContext.getCurrentActivity(), new String[] { Manifest.permission.WRITE_EXTERNAL_STORAGE }, 101);
        }

        cameraManager.openCamera(cameraId, stateCallback,null);
    }

    @Override
    public TextureView createViewInstance(ThemedReactContext context) {
        textureView.setSurfaceTextureListener(textureListener);
        return textureView;
    }

    private void takePicture() throws CameraAccessException {
        Log.d(ComponentTag, "takePicture is initiated!");
        if(cameraDevice == null) return;
        CameraManager cameraManager = (CameraManager) mCallerContext.getSystemService(Context.CAMERA_SERVICE);
        CameraCharacteristics cameraCharacteristics = cameraManager.getCameraCharacteristics(cameraDevice.getId());
        Size[] jpegSizes = null;
        jpegSizes = cameraCharacteristics.get(CameraCharacteristics.SCALER_STREAM_CONFIGURATION_MAP).getOutputSizes(ImageFormat.JPEG);
        int width = 1080;
        int height = 1440;
        if(jpegSizes != null & jpegSizes.length > 0){
            width = jpegSizes[0].getWidth();
            height = jpegSizes[0].getHeight();
        }

        ImageReader imageReader = ImageReader.newInstance(width, height, ImageFormat.JPEG, 1);
        List<Surface> outputSurfaces = new ArrayList<>(2);
        outputSurfaces.add(imageReader.getSurface());
        outputSurfaces.add(new Surface(textureView.getSurfaceTexture()));
        final CaptureRequest.Builder captureRequestBuilder = cameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_STILL_CAPTURE);
        captureRequestBuilder.addTarget(imageReader.getSurface());
        captureRequestBuilder.set(CaptureRequest.CONTROL_MODE, CameraMetadata.CONTROL_MODE_AUTO);

        Long timeStampInLong = System.currentTimeMillis();
        String timeStamp = timeStampInLong.toString();

        file = new File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DCIM)+"/"+timeStamp+".jpg");
        ImageReader.OnImageAvailableListener readerListener = new ImageReader.OnImageAvailableListener() {
            @Override
            public void onImageAvailable(ImageReader reader) {
                Image image = null;
                image = reader.acquireLatestImage();
                ByteBuffer byteBuffer = image.getPlanes()[0].getBuffer();
                byte[] bytes = new byte[byteBuffer.capacity()];
                byteBuffer.get(bytes);
                try {
                    saveImageBytes(bytes);
                } catch (IOException e) {
                    e.printStackTrace();
                }finally {
                    if(image != null) image.close();
                }
            }
        };
        imageReader.setOnImageAvailableListener(readerListner, mBackgroundHandler);

        final  CameraCaptureSession.CaptureCallback captureCallback = new CameraCaptureSession.CaptureCallback() {
            @Override
            public void onCaptureCompleted(@NonNull CameraCaptureSession session, @NonNull CaptureRequest request, @NonNull TotalCaptureResult result) {
                super.onCaptureCompleted(session, request, result);
                Log.d(ComponentTag, "Image is saved!");
                new AlertDialog.Builder(mCallerContext.getCurrentActivity())
                        .setTitle("Photo Saved!")
                        .setMessage("The photo has been successfully saved to your Photos Gallery.")
                        .setPositiveButton("ğŸ‘", null)
                        .setIcon(Android.R.drawable.ic_menu_gallery)
                        .show();
                try {
                    createCameraPreview();
                } catch (CameraAccessException e) {
                    e.printStackTrace();
                }
            }
        };

        cameraDevice.createCaptureSession(outputSurfaces, new CameraCaptureSession.StateCallback() {
            @Override
            public void onConfigured(@NonNull CameraCaptureSession session) {
                try {
                    session.capture(captureRequestBuilder.build(), captureCallback, mBackgroundHandler);
                } catch (CameraAccessException e) {
                    e.printStackTrace();
                }
            }

            @Override
            public void onConfigureFailed(@NonNull CameraCaptureSession session) {

            }
        }, mBackgroundHandler);
    }

    private void saveImageBytes(byte[] bytes) throws IOException {
        OutputStream outputStream = null;
        outputStream = new FileOutputStream(file);
        outputStream.write(bytes);
        outputStream.close();
    }

    /**
     * Map the "captureImage" command to an integer
     */
    @Nullable
    @Override
    public Map<String, Integer> getCommandsMap() {
        return MapBuilder.of("captureImage", CAPTURE_COMMAND);
    }

    /**
     * Handle "captureImage" command called from JS
     */
    @Override
    public void receiveCommand(@NonNull TextureView root, String commandId, @Nullable ReadableArray args) {
        super.receiveCommand(root, commandId, args);
        int reactNativeViewId = args.getInt(0);
        int commandIdInt = Integer.parseInt(commandId);

        switch (commandIdInt) {
            case CAPTURE_COMMAND:
                try {
                    takePicture();
                } catch (CameraAccessException e) {
                    e.printStackTrace();
                }
                break;
            default: {}
        }
    }
}

```

ä½ å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½å®Œæ•´çš„æºä»£ç ã€‚

æ³¨æ„ï¼Œæˆ‘ä»¬æ·»åŠ äº†æ ·æ¿ä»£ç æ¥è®¿é—®ç›¸æœºï¼Œè¿˜åŒ…å«äº†`getCommandsMap()`å’Œ`receiveCommand()`å‡½æ•°ã€‚è¿™äº›å‡½æ•°ç”¨äºè·Ÿè¸ªæˆ‘ä»¬æ˜¯å¦åœ¨æœ¬åœ° UI ç»„ä»¶ä¸­æ¥æ”¶åˆ°ä»»ä½•å‘½ä»¤ã€‚

å½“å®ƒä»¬æ”¶åˆ°æŸä¸ªå‘½ä»¤æ—¶ï¼Œå®ƒä»¬æ‰§è¡Œç‰¹å®šçš„é€»è¾‘ã€‚å¯ä»¥æŠŠå®ƒæƒ³æˆç±»ä¼¼äº Reduxï¼Œå½“æˆ‘ä»¬æ¥æ”¶åˆ°ä¸€ä¸ª`TYPE`ç„¶ååˆ†æ´¾ä¸€ä¸ª`ACTION`æ¥æ‰§è¡Œç‰¹å®šçš„é€»è¾‘ã€‚

åœ¨è¿™é‡Œï¼Œå½“æˆ‘ä»¬æ¥æ”¶åˆ°`CAPTURE_COMMAND`æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨`takePicture()`æ–¹æ³•æ¥æ•è·å›¾åƒå¹¶å°†å…¶ä¿å­˜åˆ°ç”¨æˆ·çš„ç…§ç‰‡åº“ä¸­ã€‚

æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ³¨å†Œæˆ‘ä»¬çš„`viewManager`ã€‚é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªå®ç°`ReactPackage`çš„åŒ…æ–‡ä»¶ï¼Œå¹¶é€šè¿‡å®ƒçš„`createViewManagers`æ–¹æ³•è¿”å›æˆ‘ä»¬çš„`RNCSTMCameraManager`çš„ä¸€ä¸ªå®ä¾‹ã€‚

ç°åœ¨ï¼Œä½¿ç”¨`MainApplication.java`çš„`getPackages()`æ–¹æ³•å°†å…¶å¯¼å‡ºä¸º JavaScript ä»£ç ã€‚

ä½¿ç”¨ä¸åˆ›å»º`RNCSTMCameraManager.java`æ–‡ä»¶ç›¸åŒçš„è¿‡ç¨‹åˆ›å»ºä¸€ä¸ª`RNCSTMCameraManagerPackage.java`æ–‡ä»¶ã€‚åˆ›å»ºåï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç :

```
/** Imports will be here */

public class RNCSTMCameraManagerPackage implements ReactPackage {

    @NonNull
    @Override
    public List<NativeModule> createNativeModules(@NonNull ReactApplicationContext reactContext) {
        List<NativeModule> nativeModules = new ArrayList<>();
        return nativeModules;
    }

    @Override
    public List<ViewManager> createViewManagers(
            ReactApplicationContext reactContext) {
        return Arrays.<ViewManager>asList(
                new RNCSTMCameraManager(reactContext)
        );
    }
}

```

ç°åœ¨ï¼Œå°†åŒ…æ·»åŠ åˆ°`MainApplication.java`çš„`getPackages()`æ–¹æ³•ä¸­:

```
@Override
protected List<ReactPackage> getPackages() {
  @SuppressWarnings("UnnecessaryLocalVariable")
  List<ReactPackage> packages = new PackageList(this).getPackages();
  // Packages that cannot be autolinked yet can be added manually here, for example:
   packages.add(new RNCSTMCameraManagerPackage()); // Add this line to add our package
  return packages;
}

```

ğŸ‰å°±æ˜¯è¿™æ ·ï¼æˆ‘ä»¬å·²ç»æˆåŠŸåœ°åˆ›å»ºäº†ä¸€ä¸ª Android åŸç”Ÿ UI ç»„ä»¶ã€‚

è®©æˆ‘ä»¬åœ¨ JavaScript ä»£ç ä¸­è®¿é—®å®ƒã€‚è½¬åˆ° VSCodeï¼Œæ‰“å¼€`App.js`ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç :

```
import React, { useRef } from 'react';
import {
  findNodeHandle,
  Platform,
  Pressable,
  StyleSheet,
  UIManager,
  View
} from 'react-native';
import { CameraView } from './CameraView';

const App = () => {
  const componentRef = useRef(null);
  const dispatchCaptureCommand = () => {
        UIManager?.dispatchViewManagerCommand(
          findNodeHandle(componentRef?.current),
          UIManager?.RNCSTMCamera?.Commands?.captureImage?.toString(),
          [findNodeHandle(componentRef?.current)],
        )
  };
  return (
    <View style={styles.container}>
      <CameraView ref={componentRef} style={styles.cameraView} />
      <View style={styles.captureBtnContainer}>
        <Pressable style={styles.captureBtn} onPress={dispatchCaptureCommand} />
      </View>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: 'white',
  },
  cameraView: {
    flex: 1,
  },
  captureBtnContainer: {
    backgroundColor: '#0006',
    position: 'absolute',
    bottom: 60,
    alignSelf: 'center',
    alignItems: 'center',
    justifyContent: 'center',
    height: 100,
    width: 100,
    borderRadius: 60,
  },
  captureBtn: {
    height: 75,
    width: 75,
    borderRadius: 37.5,
    backgroundColor: '#fff',
  },
});

export default App;

```

æ‚¨å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªä»`CameraView`å¯¼å…¥çš„`CameraView`ç»„ä»¶ã€‚

åœ¨åŒä¸€ä¸ªç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JS æ–‡ä»¶ï¼Œå°†å…¶å‘½åä¸º`CameraView.js`ï¼Œç„¶åç²˜è´´ä»¥ä¸‹å†…å®¹:

```
import {requireNativeComponent} from 'react-native';

const CameraView = requireNativeComponent('RNCSTMCamera');

export {CameraView};

```

æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ React Native çš„`requireNativeComponent`è®¿é—®æˆ‘ä»¬çš„åŸç”Ÿ Android UI ç»„ä»¶ï¼Œå¹¶å°†å…¶å¯¼å‡ºä¸º`CameraView`ã€‚

å¯¹äº Androidï¼Œæˆ‘ä»¬çš„ JavaScript ç«¯å®ç°ä¹Ÿå·²ç»å®Œæˆã€‚ç°åœ¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ Android studio åœ¨æ‚¨çš„ Android è®¾å¤‡ä¸Šè¿è¡Œæ¥æµ‹è¯•è¯¥åº”ç”¨ç¨‹åºã€‚

## åˆ›å»º iOS åŸç”Ÿ UI ç»„ä»¶

æ ¹æ®å®˜æ–¹[æ–‡æ¡£](https://reactnative.dev/docs/native-components-ios)ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆè¿™äº›æ­¥éª¤æ¥åˆ›å»ºä¸€ä¸ª iOS åŸç”Ÿ UI ç»„ä»¶:

*   å­ç±»`RCTViewManager`ä¸ºç»„ä»¶åˆ›å»ºç®¡ç†å™¨
*   æ·»åŠ `RCT_EXPORT_MODULE()`æ ‡è®°å®
*   å®ç°`-(UIView *)view`æ–¹æ³•

ç±»ä¼¼äº Androidï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸ºæˆ‘ä»¬çš„ç»„ä»¶åˆ›å»ºä¸€ä¸ªç®¡ç†å™¨ï¼Œå®ƒå°†æ‰©å±•`RCTViewManager`ç±»ã€‚æˆ‘ä»¬å°†é€šè¿‡`RCT_EXPORT_MODULE()`æ ‡è®°å®å°†å…¶å¯¼å‡ºã€‚`-(UIView *)view`æ˜¯è¿”å›åœ¨ç”¨æˆ·ç•Œé¢ä¸­æ˜¾ç¤ºä»€ä¹ˆçš„æ–¹æ³•ã€‚

æˆ‘ä»¬å°†åœ¨ iOS ä¸­åˆ›å»ºä¸¤ç§ç±»å‹çš„æ–‡ä»¶ï¼Œç”¨äºå°†æœ¬åœ° UI ç»„ä»¶å¯¼å‡ºåˆ° JS ä»£ç :

1.  ä¸€ä¸ªç®¡ç†å™¨ç±»ï¼Œå®ƒå°†å¯¼å‡ºæˆ‘ä»¬çš„è§†å›¾ï¼Œå¹¶å°†åŒ…å«ä¸å¤„ç†æ¥è‡ª JS ç«¯çš„äº‹ä»¶æˆ–å‘½ä»¤ç›¸å…³çš„é€»è¾‘
2.  å°†å‘é€ç»™ manager ç±»è¿›è¡Œå‘ˆç°çš„è§†å›¾ã€‚è¯¥æ–‡ä»¶å°†åŒ…å«ä¸åœ¨`UIView`ä¸Šæ˜¾ç¤ºå®æ—¶æ‘„åƒæœºç”»é¢ç›¸å…³çš„æ‰€æœ‰é€»è¾‘

å¯¹äºè¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬å°†æœ‰ä¸¤ä¸ªæ–‡ä»¶:ä¸€ä¸ª`.h`(å¤´)æ–‡ä»¶å’Œä¸€ä¸ª`.m`(å®ç°)æ–‡ä»¶ã€‚

åˆ‡æ¢åˆ° XCode çª—å£ã€‚ç‚¹å‡»æ ‡é¢˜æ ä¸­çš„**æ–‡ä»¶**ï¼Œç„¶åç‚¹å‡»å­èœå•ä¸­çš„**æ–°å»º**ï¼Œç„¶åç‚¹å‡»**æ–‡ä»¶**ã€‚

![File Submenu](img/a5ccce3992c8e5b8a2b13ca474860e8b.png)

å°†æºç±»å‹è®¾ç½®ä¸º**å¤´æ–‡ä»¶**ï¼Œåœ¨**é€‰æ‹©æ¨¡æ¿**å¯¹è¯æ¡†ä¸­ç‚¹å‡»**ä¸‹ä¸€æ­¥**ã€‚

![Choose Template](img/87c6d8e105ea49f8157f586ff836cf1c.png)

å°†æ–‡ä»¶å¦å­˜ä¸º`RNCSTMCameraManager`ï¼Œç‚¹å‡»**åˆ›å»º**ã€‚

![Create](img/8d5b64e2fff1939155cc341f0a0ff065.png)

å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`RNCSTMCameraManager.h`ã€‚

```
#import "AVFoundation/AVFoundation.h"
#import <React/RCTViewManager.h>

@interface RNCSTMCameraManager : RCTViewManager

@end

```

åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬åˆšåˆšå£°æ˜äº†ç±»`RNCSTMCameraManager`ï¼Œå®ƒæ‰©å±•äº†`RCTViewManager`ã€‚å®ƒçš„å®ç°å°†åœ¨`.m`æ–‡ä»¶ä¸­ã€‚

è¦åˆ›å»º`RNCSTMCameraManager.m`ï¼Œéµå¾ªä¸åˆ›å»ºå¤´æ–‡ä»¶ç›¸åŒçš„æ­¥éª¤ï¼Œä½†æ˜¯é€‰æ‹©æºä»£ç ç±»å‹ä¸º **Objective-C** ã€‚

![Objective-c](img/abf7cf66fce5a7ddcb503f1553408a3c.png)

å¦å­˜ä¸º`RNCSTMCameraManager`ï¼Œç‚¹å‡»**ä¸‹ä¸€æ­¥ï¼Œ**ç„¶åæ·»åŠ  app ç›®æ ‡ï¼Œç‚¹å‡»**åˆ›å»º**ã€‚

æ·»åŠ ä»¥ä¸‹ä»£ç :

```
#import "RNCSTMCameraManager.h"
#import "RNCTSTMCamera.h"
#import "React/RCTUIManager.h"
#import "React/RCTLog.h"

@implementation RNCSTMCameraManager

RCT_EXPORT_MODULE(RNCSTMCamera)

- (UIView *)view
{
  return [[RNCSTMCamera alloc] initWithFrame:CGRectMake(UIScreen.mainScreen.bounds.origin.x,
    UIScreen.mainScreen.bounds.origin.y,
    UIScreen.mainScreen.bounds.size.width,
    UIScreen.mainScreen.bounds.size.height)];
}

+ (BOOL)requiresMainQueueSetup {
    return YES;
}

@end

```

æˆ‘ä»¬å‘Šè¯‰ JavaScriptï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`RCT_EXPORT_MODULE`æ ‡è®°å®ä¸­ä½¿ç”¨`RNCSTMCamera`æ¥è®¿é—®è¿™ä¸ªç±»ï¼Œå¹¶åœ¨`view`æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ª`RNCSTMCamera`ç±»çš„å®ä¾‹ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª`UIView`ã€‚

æˆ‘ä»¬è¿˜æ·»åŠ äº†ä¸€ä¸ª`requiresMainQueueSetup`æ–¹æ³•ï¼Œå®ƒå°†åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œæˆ‘ä»¬çš„ç»„ä»¶ã€‚

æ‚¨è¿˜ä¼šæ³¨æ„åˆ°ï¼Œæˆ‘ä»¬æ­£åœ¨è¿”å›ä¸€ä¸ªè¿˜æ²¡æœ‰åˆ›å»ºçš„`RNCSTMCamera`ç±»ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è¿™æ ·åšå§ã€‚ä¸º`RNCSTMCamera`ç±»çš„å£°æ˜åˆ›å»ºä¸€ä¸ªåä¸º`RNCSTMCamera`çš„`.h`å¤´æ–‡ä»¶ï¼Œå¹¶å‘å…¶ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç :

```
#import "UIKit/UIKit.h"
#import "AVFoundation/AVFoundation.h"

@interface RNCSTMCamera : UIView

@property (strong, nullable) AVCapturePhotoOutput *photoOutput;

@end

```

æˆ‘ä»¬æ·»åŠ äº†ç±»å‹ä¸º`AVCapturePhotoOutput`çš„`photoOutput`å±æ€§ï¼Œç”¨äºæ•æ‰ç…§ç‰‡ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºè¿™ä¸ªç±»çš„ä¸€ä¸ªå®ç°ã€‚æŒ‰ç…§ç›¸åŒçš„æ­¥éª¤åˆ›å»ºä¸€ä¸ª Objective-C å®ç°(`.m`)æ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶å‘½åä¸º`RNCSTMCamera`ã€‚è¦è®¿é—®è®¾å¤‡æ‘„åƒå¤´å¹¶è¿”å›å…¶å®æ—¶åé¦ˆï¼Œè¯·æ·»åŠ ä»¥ä¸‹ä»£ç :

```
#import "RNCTSTMCamera.h"
#import "AVFoundation/AVFoundation.h"

@implementation RNCSTMCamera

- (instancetype)initWithFrame:(CGRect)frame
{
  _photoOutput = [[AVCapturePhotoOutput alloc] init];
  self = [super initWithFrame:frame];
  if (self) {
    NSLog(@"RNCSTMCamera was initialized in init with Frame");
    [self initializeCamera];
  }
  return self;
}

- (void) initializeCamera {
  AVCaptureSession *session = [[AVCaptureSession alloc] init];
  session.sessionPreset = AVCaptureSessionPresetHigh;
  CALayer *viewLayer = self.layer;
  AVCaptureVideoPreviewLayer *captureVideoPreviewLayer = [[AVCaptureVideoPreviewLayer alloc] initWithSession:session];
  captureVideoPreviewLayer.frame = CGRectMake(UIScreen.mainScreen.bounds.origin.x,UIScreen.mainScreen.bounds.origin.y,UIScreen.mainScreen.bounds.size.width,UIScreen.mainScreen.bounds.size.height);
  [captureVideoPreviewLayer setVideoGravity:AVLayerVideoGravityResizeAspectFill];
  [self.layer addSublayer:captureVideoPreviewLayer];
  AVCaptureDevice *device = nil;
  NSArray *devices = [AVCaptureDevice devicesWithMediaType:AVMediaTypeVideo];
  for(AVCaptureDevice *camera in devices) {
      if([camera position] == AVCaptureDevicePositionFront) {
          device = camera;
          break;
      }
  }
  NSError *error = nil;
  AVCaptureDeviceInput *input = [AVCaptureDeviceInput deviceInputWithDevice:device error:&error];
  if (!input) NSLog(@"ERROR: trying to open camera: %@", error);
  [session addInput:input];
  [session addOutput:_photoOutput];
  [session startRunning];
  [self setClipsToBounds:true];
}

@end

```

å½“æˆ‘ä»¬è°ƒç”¨`initWithFrame`æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨`initializeCamera`æ–¹æ³•ï¼Œè¿™å°†å¯åŠ¨ä¸€ä¸ª`AVCaptureSession`ã€‚ç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`AVCaptureVideoPreviewLayer`å¹¶ç”¨`AVCaptureSession`åˆå§‹åŒ–å®ƒã€‚

ä¸€æ—¦`AVCaptureVideoPreviewLayer`å‡†å¤‡å¥½äº†ï¼Œæˆ‘ä»¬æ·»åŠ `AVCaptureVideoPreviewLayer`ä½œä¸ºæˆ‘ä»¬çš„æ ¹`UIView`çš„å­å±‚ï¼Œå¹¶è®¾ç½®`AVCaptureDevice`ä¸ºå‰ç½®æ‘„åƒå¤´ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`AVCaptureDeviceInput`å¯¹è±¡ï¼Œå®ƒå†³å®šåœ¨ä¼šè¯ä¸­æ˜¾ç¤ºå“ªä¸ªæè¦ï¼Œç„¶åå°†`photoOutput`ä½œä¸ºè¾“å‡ºæ·»åŠ åˆ°`session`ä¸­ï¼Œç”¨äºä»è®¾å¤‡æ‘„åƒå¤´æ•æ‰ç…§ç‰‡ã€‚æœ€åï¼Œæˆ‘ä»¬å¼€å§‹ä¼šè®®ã€‚

è¦è®¿é—®ç›¸æœºå¹¶èƒ½å¤Ÿå†™å…¥ç”¨æˆ·çš„ç…§ç‰‡åº“ï¼Œæˆ‘ä»¬éœ€è¦å‘`info.plist`æ–‡ä»¶æ·»åŠ ä»¥ä¸‹æƒé™:

![Permissions](img/168d96d023bb89bf14f13980f7ab4edd.png)

è¦æ¥æ”¶æ•è·ç…§ç‰‡å‘½ä»¤ï¼Œæ‰“å¼€`RNCSTMCameraManager.m`å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:

```
RCT_EXPORT_METHOD(captureImage: (nonnull NSNumber *)viewTag)
{
  [self.bridge.uiManager addUIBlock:^(RCTUIManager *uiManager, NSDictionary<NSNumber *, UIView *> *viewRegistry) {
    RNCSTMCamera *view = viewRegistry[viewTag];

    if ([view isKindOfClass:[UIView class]]) {
      NSLog(@"Capture Command was called");
      [self capturePhoto:view];
    } else {
      RCTLogError(@"view type must be UIView");
    }
  }];
}

-(void) capturePhoto:(RNCSTMCamera*) view{
  AVCapturePhotoSettings *settings = [AVCapturePhotoSettings photoSettingsWithFormat:@{AVVideoCodecKey: AVVideoCodecTypeJPEG}];
  [view.photoOutput capturePhotoWithSettings:settings delegate:self];
}

#pragma mark - AVCapturePhotoCaptureDelegate
- (void)captureOutput:(AVCapturePhotoOutput *)output didFinishProcessingPhoto:(AVCapturePhoto *)photo error:(nullable NSError *)error
{
  NSData *imageData = [photo fileDataRepresentation];
  UIImage *image = [UIImage imageWithData:imageData];
  NSLog(@"image is: %@",image);
  UIImageWriteToSavedPhotosAlbum(image, NULL, NULL, NULL);
  UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"Photo Saved!" message:@"The Photo has been successfully saved in your photo library." delegate:self cancelButtonTitle:NULL otherButtonTitles:@"ğŸ‘", nil];
  [alert show];
}

```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å°†`captureImage`å¯¼å‡ºåˆ° JS ä»£ç ï¼Œå› æ­¤ï¼Œå½“è¢«è°ƒç”¨æ—¶ï¼Œå®ƒå°†æ£€æŸ¥ç±»å‹`UIView`ã€‚ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨`capturePhoto`ä»`RNCSTMCamera`ç±»çš„`photoOutput`å±æ€§ä¸­æ•è·å›¾åƒã€‚

æˆ‘ä»¬è¿˜æ·»åŠ äº†ä¸€ä¸ªå®æ¥è¦†ç›–`AVCapturePhotoCaptureDelegate`ï¼Œå®ƒåœ¨æˆ‘ä»¬è°ƒç”¨`captureWithSettings`æ—¶è¢«è§¦å‘ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`fileDataRepresentation`å°†`AVCapturePhoto`è½¬æ¢ä¸º`imageData`ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨è¯¥æ•°æ®åˆ›å»ºä¸€ä¸ª`UIImage`ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°ç…§ç‰‡åº“ä¸­ã€‚

æˆ‘ä»¬çš„æœ€åä¸€æ­¥æ˜¯å‘é€å‘½ä»¤æ¥ä¸º iOS æ•æ‰ç…§ç‰‡ã€‚æ‰“å¼€ VSCode ä¸­çš„`App.js`,å°†`dispatchCaptureCommand`ä¸­çš„ä»£ç æ›´æ”¹å¦‚ä¸‹:

```
const dispatchCaptureCommand = () => {
  Platform.OS === 'Android'
    ? UIManager?.dispatchViewManagerCommand(
        findNodeHandle(componentRef?.current),
        UIManager?.RNCSTMCamera?.Commands?.captureImage?.toString(),
        [findNodeHandle(componentRef?.current)],
      )
    : UIManager.dispatchViewManagerCommand(
        findNodeHandle(componentRef?.current),
        UIManager.getViewManagerConfig('RNCSTMCamera').Commands.captureImage,
        [],
      );
};

```

æ‚¨å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸åŒçš„è¯­æ³•åœ¨ iOS ä¸­å‘é€å‘½ä»¤ã€‚è¿™æ˜¯å› ä¸º iOS ä¸­çš„åº•å±‚è§†å›¾ç®¡ç†æœ‰ä¸€äº›ä¸åŒçš„é€»è¾‘ã€‚

## ç»“è®º

å¦‚æœæ‚¨å¸Œæœ›ä¸ºè‡ªå·±çš„ React æœ¬æœºåº”ç”¨ç¨‹åºå®ç°ä¸€ä¸ªä¸æ”¯æŒå¼€ç®±å³ç”¨çš„ç‰¹æ€§ï¼Œé‚£ä¹ˆåœ¨ React Native ä¸­æ„å»ºå’Œä½¿ç”¨æœ¬æœº UI ç»„ä»¶ä¼šéå¸¸æ–¹ä¾¿ã€‚å¦‚æœæ‚¨æ­£åœ¨å°†ç°æœ‰çš„åŸç”Ÿ iOS å’Œ Android åº”ç”¨ç¨‹åºè½¬æ¢ä¸º React Nativeï¼Œè¿™ä¹Ÿéå¸¸æœ‰ç”¨ã€‚æ„Ÿè°¢é˜…è¯»ï¼

## [LogRocket](https://lp.logrocket.com/blg/react-native-signup) :å³æ—¶é‡ç° React åŸç”Ÿåº”ç”¨ä¸­çš„é—®é¢˜ã€‚

[![](img/110055665562c1e02069b3698e6cc671.png)](https://lp.logrocket.com/blg/react-native-signup)

[LogRocket](https://lp.logrocket.com/blg/react-native-signup) æ˜¯ä¸€æ¬¾ React åŸç”Ÿç›‘æ§è§£å†³æ–¹æ¡ˆï¼Œå¯å¸®åŠ©æ‚¨å³æ—¶é‡ç°é—®é¢˜ã€ç¡®å®š bug çš„ä¼˜å…ˆçº§å¹¶äº†è§£ React åŸç”Ÿåº”ç”¨çš„æ€§èƒ½ã€‚

LogRocket è¿˜å¯ä»¥å‘ä½ å±•ç¤ºç”¨æˆ·æ˜¯å¦‚ä½•ä¸ä½ çš„åº”ç”¨ç¨‹åºäº’åŠ¨çš„ï¼Œä»è€Œå¸®åŠ©ä½ æé«˜è½¬åŒ–ç‡å’Œäº§å“ä½¿ç”¨ç‡ã€‚LogRocket çš„äº§å“åˆ†æåŠŸèƒ½æ­ç¤ºäº†ç”¨æˆ·ä¸å®Œæˆç‰¹å®šæµç¨‹æˆ–ä¸é‡‡ç”¨æ–°åŠŸèƒ½çš„åŸå› ã€‚

å¼€å§‹ä¸»åŠ¨ç›‘æ§æ‚¨çš„ React åŸç”Ÿåº”ç”¨â€” [å…è´¹è¯•ç”¨ LogRocketã€‘ã€‚](https://lp.logrocket.com/blg/react-native-signup)